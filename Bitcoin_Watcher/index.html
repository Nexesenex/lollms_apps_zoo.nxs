<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Watcher</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
        }
        .neon-text {
            font-size: large;
            transition: text-shadow 0.3s ease-in-out;
        }
        .neon-box {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: box-shadow 0.3s ease-in-out;
        }
        .neon-glow {
            box-shadow: 0 0 2px #fff, 0 0 3px #fff, 0 0 5px #ff00de, 0 0 7px #ff00de, 0 0 10px #ff00de;
        }
        .neon-text.neon-glow {
            text-shadow: 0 0 2px #e0e0e0, 0 0 5px #ff00de;
        }
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .settings-content {
            background-color: #2a2a2a;
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container mx-auto p-4">
        <header class="mb-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold neon-text">Bitcoin Watcher</h1>
            <button id="settingsBtn" class="p-2 bg-gray-800 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </header>
        <main>
            <div class="gap-4">
                <section class="p-4 w-full">
                    <h2 class="text-2xl font-semibold mb-2 neon-text">Dashboard</h2>
                    <div id="dashboard" class="space-y-4">
                        <div id="bitcoin-price" class="neon-box p-4 rounded shadow">
                            <h3 class="text-xl font-semibold mb-2 neon-text">Current Bitcoin Price</h3>
                            <p id="current-price" class="text-center text-4xl mb-2 neon-text"></p>
                            <p id="price-change"></p>
                        </div>
                        <div class="neon-box p-4 rounded shadow">
                            <div class="flex">
                                <button id="graphTab" class="px-4 py-2 bg-purple-600 text-white rounded-t-lg">Graph</button>
                                <button id="aiAnalysisTab" class="px-4 py-2 bg-gray-600 text-white rounded-t-lg ml-2">Analysis</button>
                            </div>
                            <div id="aiAnalysisContent" class="mt-2 hidden">
                                <h3 class="text-xl font-semibold mb-2 neon-text">Mock AI Analysis</h3>
                                <button id="generateAnalysisBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                    <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    Generate Analysis
                                </button>
                                <div id="analysis-spinner" class="spinner hidden mt-4"></div>
                                <div id="analysis-result"></div>
                            </div>
                            <div id="graphContent" class="mt-2">
                                <h3 class="text-xl font-semibold mb-2 neon-text">Interactive Bitcoin Price Chart</h3>
                                <div class="mb-4">
                                    <label for="timeRange" class="block text-sm font-medium text-gray-300">Time Range:</label>
                                    <select id="timeRange" class="mt-1 block w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white">
                                        <option value="7d">7 Days</option>
                                        <option value="30d" selected>30 Days</option>
                                        <option value="90d">90 Days</option>
                                        <option value="1y">1 Year</option>
                                    </select>
                                </div>
                                <canvas id="bitcoinChart"></canvas>
                            </div>
                        </div>
                        <div id="alerts" class="neon-box p-4 rounded shadow">
                            <h3 class="text-xl font-semibold mb-2 neon-text">Alerts and Notifications</h3>
                            <ul id="alertList" class="list-disc pl-5"></ul>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <div id="settingsOverlay" class="settings-overlay hidden">
        <div class="settings-content">
            <h2 class="text-2xl font-semibold mb-2 neon-text">Settings</h2>
            <form id="settingsForm" class="space-y-4">
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-300">Currency</label>
                    <select id="currency" name="currency" class="mt-1 block w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                    </select>
                </div>
                <div>
                    <label for="alertThreshold" class="block text-sm font-medium text-gray-300">Alert Price Threshold</label>
                    <input type="number" id="alertThreshold" name="alertThreshold" class="mt-1 block w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white" value="50000">
                </div>
                <div>
                    <label for="themeSelect" class="block text-sm font-medium text-gray-300">Theme Selection</label>
                    <select id="themeSelect" name="themeSelect" class="mt-1 block w-full p-2 bg-gray-800 border border-gray-600 rounded-md text-white">
                        <option value="default">Default</option>
                        <option value="neon" selected>Neon</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white p-2 rounded-md hover:bg-purple-700">Update Settings</button>
                <button type="button" id="closeSettingsBtn" class="w-full bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700 mt-2">Close</button>
            </form>
        </div>
    </div>
    <script>
        let bitcoinChart;
        let currentBitcoinData;
        let selectedCurrency = 'USD';
        let selectedTimeRange = '30d';

        async function fetchBitcoinData() {
            const url = `https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=true`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`CoinGecko API error: ${response.status} ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching current data from CoinGecko:', error);
                document.getElementById('current-price').textContent = 'Error loading price';
                throw error;
            }
        }

        async function fetchHistoricalData(timeRange) {
            const daysMap = { '7d': 7, '30d': 30, '90d': 90, '1y': 365 };
            const days = daysMap[timeRange] || 30;
            const url = `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=${selectedCurrency.toLowerCase()}&days=${days}&interval=daily`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`CoinGecko API error: ${response.status} ${response.statusText}`);
                const data = await response.json();
                return data.prices;
            } catch (error) {
                console.error('Error fetching historical data from CoinGecko:', error);
                throw error;
            }
        }

        function initBitcoinChart() {
            const ctx = document.getElementById('bitcoinChart').getContext('2d');
            bitcoinChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `Bitcoin Price (${selectedCurrency})`,
                        data: [],
                        borderColor: '#ff00de',
                        backgroundColor: 'rgba(255, 0, 222, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { type: 'time', title: { display: true, text: 'Date' } },
                        y: { title: { display: true, text: 'Price' } }
                    }
                }
            });
        }

        async function updateBitcoinChart() {
            if (!bitcoinChart) return;
            try {
                const data = await fetchHistoricalData(selectedTimeRange);
                bitcoinChart.data.datasets[0].data = data.map(([x, y]) => ({ x, y }));
                bitcoinChart.data.datasets[0].label = `Bitcoin Price (${selectedCurrency})`;
                bitcoinChart.update();
            } catch (error) {
                 console.error('Error updating chart:', error);
            }
        }

        async function analyzeBitcoinData(bitcoinData) {
            const spinner = document.getElementById('analysis-spinner');
            const resultDiv = document.getElementById('analysis-result');
            
            spinner.classList.remove('hidden');
            resultDiv.innerHTML = '';
            
            await new Promise(resolve => setTimeout(resolve, 1000));

            const currency = selectedCurrency.toLowerCase();
            const currentPrice = bitcoinData.market_data.current_price[currency];
            const priceChange24h = bitcoinData.market_data.price_change_percentage_24h;

            const mockAnalysis = `
### Mock AI Analysis

Based on the latest data, here is a summary of Bitcoin's performance:

*   **Current Price:** **${new Intl.NumberFormat(undefined, { style: 'currency', currency: selectedCurrency }).format(currentPrice)}**
*   **24-Hour Change:** The price has changed by **${priceChange24h.toFixed(2)}%** in the last 24 hours.

**Outlook:**
The current trend shows ${priceChange24h >= 0 ? 'positive momentum' : 'a slight downturn'}. 

*(Note: This is a simulated analysis.)*
            `;
            
            resultDiv.innerHTML = marked.parse(mockAnalysis);
            spinner.classList.add('hidden');
        }
        
        function checkAlerts(bitcoinData, threshold) {
            const alertList = document.getElementById('alertList');
            alertList.innerHTML = ''; 
            if (!bitcoinData || !bitcoinData.market_data) return;

            const currentPrice = bitcoinData.market_data.current_price[selectedCurrency.toLowerCase()];
            if (currentPrice > threshold) {
                const li = document.createElement('li');
                li.textContent = `High price alert: Bitcoin is above your threshold of ${threshold.toLocaleString()} ${selectedCurrency}, currently at ${currentPrice.toFixed(2)} ${selectedCurrency}.`;
                li.className = 'text-yellow-400';
                alertList.appendChild(li);
            } else {
                 const li = document.createElement('li');
                li.textContent = `No active alerts. Current price is ${currentPrice.toFixed(2)} ${selectedCurrency}.`;
                alertList.appendChild(li);
            }
        }
        
        async function updateCurrentBitcoinInfo() {
            try {
                const bitcoinData = await fetchBitcoinData();
                currentBitcoinData = bitcoinData;
                updateBitcoinPrice(bitcoinData);
                const threshold = parseFloat(document.getElementById('alertThreshold').value);
                checkAlerts(bitcoinData, threshold);
            } catch (error) { /* Error is logged in fetchBitcoinData */ }
        }

        function updateBitcoinPrice(bitcoinData) {
            const currency = selectedCurrency.toLowerCase();
            const currentPrice = bitcoinData.market_data.current_price[currency];
            const priceChange = bitcoinData.market_data.price_change_percentage_24h;
            
            document.getElementById('current-price').textContent = `${new Intl.NumberFormat(undefined, { style: 'currency', currency: selectedCurrency }).format(currentPrice)}`;
            const priceChangeEl = document.getElementById('price-change');
            priceChangeEl.textContent = `24h Change: ${priceChange.toFixed(2)}%`;
            priceChangeEl.classList.toggle('text-green-500', priceChange >= 0);
            priceChangeEl.classList.toggle('text-red-500', priceChange < 0);
        }

        function applyTheme(theme) {
            const elements = document.querySelectorAll('.neon-text, .neon-box');
            elements.forEach(el => {
                el.classList.toggle('neon-glow', theme === 'neon');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Variables ---
            const settingsOverlay = document.getElementById('settingsOverlay');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const settingsForm = document.getElementById('settingsForm');
            const aiTab = document.getElementById('aiAnalysisTab');
            const graphTab = document.getElementById('graphTab');
            const aiContent = document.getElementById('aiAnalysisContent');
            const graphContent = document.getElementById('graphContent');

            // --- Modal Handling ---
            settingsBtn.addEventListener('click', () => {
                settingsOverlay.classList.remove('hidden');
            });

            // FIX: This now correctly handles the close button click
            closeSettingsBtn.addEventListener('click', () => {
                settingsOverlay.classList.add('hidden');
            });

            // FIX: This adds "click outside to close" functionality
            settingsOverlay.addEventListener('click', (event) => {
                // If the click is on the overlay itself (the background) and not the content inside
                if (event.target === settingsOverlay) {
                    settingsOverlay.classList.add('hidden');
                }
            });

            settingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                selectedCurrency = document.getElementById('currency').value;
                applyTheme(document.getElementById('themeSelect').value);
                updateCurrentBitcoinInfo();
                updateBitcoinChart();
                settingsOverlay.classList.add('hidden');
            });

            // --- Tab Switching ---
            aiTab.addEventListener('click', () => {
                aiContent.classList.remove('hidden');
                graphContent.classList.add('hidden');
                aiTab.classList.replace('bg-gray-600', 'bg-purple-600');
                graphTab.classList.replace('bg-purple-600', 'bg-gray-600');
            });

            graphTab.addEventListener('click', () => {
                aiContent.classList.add('hidden');
                graphContent.classList.remove('hidden');
                aiTab.classList.replace('bg-purple-600', 'bg-gray-600');
                graphTab.classList.replace('bg-gray-600', 'bg-purple-600');
            });

            // --- Other Event Listeners ---
            document.getElementById('generateAnalysisBtn').addEventListener('click', () => {
                if (currentBitcoinData) {
                    analyzeBitcoinData(currentBitcoinData);
                } else {
                    alert('Bitcoin data not loaded yet. Please wait a moment.');
                }
            });

            document.getElementById('timeRange').addEventListener('change', (e) => {
                selectedTimeRange = e.target.value;
                updateBitcoinChart();
            });

            // --- Initial App Load ---
            initBitcoinChart();
            applyTheme(document.getElementById('themeSelect').value);
            updateCurrentBitcoinInfo();
            updateBitcoinChart(); // Load the chart on startup
            setInterval(updateCurrentBitcoinInfo, 60000);
        });
    </script>
</body>
</html>