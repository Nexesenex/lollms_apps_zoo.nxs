<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Mechanics Companion</title>
    <script src="/lollms_assets/js/mermaid.min"></script>
    <script src="/lollms_assets/js/tailwindcss"></script>
    <link href="/lollms_assets/css/tailwind.min" rel="stylesheet">
    <script src="/lollms_assets/js/lollms_client_js"></script>
    <script src="/lollms_assets/js/axios.min"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>    
    <style>
        @keyframes engine {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-1deg); }
            100% { transform: rotate(0deg); }
        }
        .engine-border {
            position: relative;
            overflow: hidden;
            animation: engine 0.5s infinite;
        }
        .engine-border::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #3b82f6, #60a5fa, #93c5fd);
            z-index: -1;
            filter: blur(5px);
        }
        .neumorphic {
            box-shadow: 12px 12px 24px #1a1a1a, -12px -12px 24px #2c2c2c;
            transition: all 0.3s ease;
        }
        .neumorphic:hover {
            box-shadow: 6px 6px 12px #1a1a1a, -6px -6px 12px #2c2c2c;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans" style="font-family: 'Roboto', sans-serif;">
    <div class="flex h-screen">
        <!-- Left Panel -->
        <div class="w-1/4 bg-gray-800 p-6 overflow-y-auto">
            <div class="flex justify-between items-center mt-4 mb-8">
                <button id="settings-button" class="neumorphic bg-gray-700 hover:bg-gray-600 text-yellow-400 font-bold py-3 px-6 rounded-full inline-flex items-center transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                    Settings
                </button>
            </div>
            
            <h2 id="previous-consultations" class="text-2xl font-semibold mb-4 text-yellow-400">Previous Consultations</h2>
            <ul id="previous-consultations-list" class="mb-8 space-y-2"></ul>
            
            <button onclick="showConsultationView()" id="new-consultation" class="w-full neumorphic electric-border bg-yellow-500 text-gray-900 px-6 py-3 rounded-full hover:bg-yellow-400 transition duration-300 font-medium mb-4">New Consultation</button>
            <button onclick="saveConsultation()" id="save-consultation" class="w-full neumorphic electric-border bg-blue-500 text-white px-6 py-3 rounded-full hover:bg-blue-400 transition duration-300 font-medium">Save Consultation</button>
        </div>
    
        <!-- Main Content -->
        <div id="main-content" class="flex-1 p-8 overflow-y-auto" style="display: none;">
            <h1 class="flex items-center justify-center space-x-4 text-4xl font-bold text-blue-600 mb-12">
                <img src="/apps/Car_Mechanics_Companion/icon.png" alt="Car Mechanic Icon" class="w-20 h-20 rounded-full border-4 border-blue-600 shadow-lg">
                <span class="engine-border px-8 py-4 rounded-lg backdrop-blur-sm" id="app-title">
                    Car Wizard
                </span>
            </h1>
            
            <div class="bg-gray-800 rounded-lg p-8 mb-12 transition duration-300">
                <h2 class="text-3xl font-semibold mb-6 text-yellow-400" id="consultation-title">Electrical Consultation</h2>
                <div id="chat-container" class="mb-6 h-96 overflow-y-auto border border-gray-600 rounded-lg p-6 bg-gray-700"></div>
                <div class="flex flex-col space-y-4">
                    <div class="flex">
                        <input type="text" id="user-input" class="flex-grow neumorphic bg-gray-700 text-blue-400 rounded-l-full px-6 py-3 focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-300" placeholder="Describe your car issue...">
                        <button id="mic-button" class="neumorphic bg-green-600 text-white px-6 py-3 hover:bg-green-500 transition duration-300 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                        </button>
                        <button id="send-button" onclick="sendMessage()" class="neumorphic electric-border bg-blue-600 text-white px-8 py-3 rounded-r-full hover:bg-blue-500 transition duration-300 font-medium">Send</button>
                    </div>                    
                    <div class="flex space-x-4">
                        <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleFileUpload(event, 'image')">
                        <button onclick="document.getElementById('image-input').click()" class="neumorphic bg-red-600 text-white px-6 py-3 rounded-full hover:bg-red-500 transition duration-300 font-medium flex-1">Upload Image</button>
                        
                        <input type="file" id="csv-input" accept=".csv" style="display: none;" onchange="handleFileUpload(event, 'csv')">
                        <button onclick="document.getElementById('csv-input').click()" class="neumorphic bg-green-600 text-white px-6 py-3 rounded-full hover:bg-green-500 transition duration-300 font-medium flex-1">Upload Diagnostic Data</button>
                        
                        <input type="file" id="pdf-input" accept=".pdf" style="display: none;" onchange="handleFileUpload(event, 'pdf')">
                        <button onclick="document.getElementById('pdf-input').click()" class="neumorphic bg-orange-600 text-white px-6 py-3 rounded-full hover:bg-orange-500 transition duration-300 font-medium flex-1">Upload Manual</button>                    </div>
                </div>
            </div>
    
            <div id="final-diagnosis" class="neumorphic bg-gray-800 rounded-lg p-8 mb-12 transition duration-300 hidden">
                <h2 class="text-3xl font-semibold mb-6 text-yellow-400" id="diagnosis-title">Final Diagnosis</h2>
                <div id="diagnosis-container" class="mb-6 p-6 bg-gray-700 rounded-lg"></div>
            </div>
    
            <div id="mermaid-container" class="neumorphic bg-gray-800 rounded-lg p-8 mb-12 transition duration-300" style="display: none;">
                <h2 class="text-3xl font-semibold mb-6 text-yellow-400" id="reasoning-title">AI Reasoning</h2>
                <div id="mermaid-diagram" class="mermaid bg-gray-700 p-6 rounded-lg"></div>
            </div>
    
            <div class="flex justify-between">
                <button id="export-button" onclick="exportData()" class="neumorphic electric-border bg-green-600 text-white px-8 py-4 rounded-full hover:bg-green-500 transition duration-300 font-medium shadow-lg hover:shadow-xl">Export Data</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                <button id="import-button" onclick="document.getElementById('import-file').click()" class="neumorphic electric-border bg-yellow-600 text-white px-8 py-4 rounded-full hover:bg-yellow-500 transition duration-300 font-medium shadow-lg hover:shadow-xl">Import Data</button>
            </div>
    
            <!-- Disclaimer Popup -->
            <div id="disclaimer-popup" class="fixed inset-0 bg-black bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
                <div class="neumorphic bg-gray-800 p-8 rounded-lg shadow-xl max-w-md">
                    <h2 class="text-3xl font-bold mb-6 text-yellow-400" id="disclaimer-title">Disclaimer</h2>
                    <p class="mb-6 text-gray-300" id="disclaimer-text">
                        This AI Electrician Assistant is for informational purposes only. Always consult with a licensed electrician for professional advice and services. Electrical work can be dangerous and should only be performed by qualified professionals.
                    </p>
                    <div class="flex items-center mb-6">
                        <input type="checkbox" id="dont-show-again" class="mr-3">
                        <label for="dont-show-again" class="text-sm text-gray-400">Don't show this again</label>
                    </div>
                    <button onclick="closeDisclaimer()" id="i-understand" class="w-full neumorphic electric-border bg-yellow-500 text-gray-900 px-6 py-3 rounded-full hover:bg-yellow-400 transition duration-300 font-medium">
                        I Understand
                    </button>
                </div>
            </div>
    
        </div>
        <!-- Welcome Page -->
        <div id="welcome-page" class="flex-1 p-8 flex flex-col items-center justify-center">
            <img src="/apps/Car_Mechanics_Companion/icon.png" alt="Electrician Icon" class="w-32 h-32 mb-12 animate-pulse">
            <h1 class="text-5xl font-bold text-center mb-8 text-yellow-400" id="welcome-title">Welcome to Car Mechanics Companion</h1>
            <p class="text-2xl text-center mb-12 text-gray-300" id="welcome-text">Your AI-powered electrical assistant is ready to help. Start a new consultation to begin.</p>
            <button id="start-new-consultation" onclick="showConsultationView()" class="neumorphic engine-border bg-blue-500 text-gray-900 px-12 py-4 rounded-full hover:bg-blue-400 transition duration-300 font-medium text-xl shadow-lg hover:shadow-xl">Start New Consultation</button>
        </div>
    
    </div>
    <div id="settings-popup" class="fixed inset-0 bg-black bg-opacity-75 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-8 border w-96 shadow-lg rounded-lg neumorphic bg-gray-800">
            <div class="mt-3 text-center">
                <h3 class="text-2xl leading-6 font-medium text-yellow-400 mb-6">Settings</h3>
                <div class="mt-2 px-7 py-3">
                    <label for="voice-select" class="block text-lg font-medium text-gray-300 mb-2">Select Voice:</label>
                    <select id="voice-select" class="neumorphic bg-gray-700 text-yellow-400 rounded-lg px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 transition duration-300">
                        <!-- Voice options will be populated here -->
                    </select>
                </div>
                <!-- Language Selector -->
                <div class="mb-8">
                    <label id="language-select-label" for="language-select" class="text-lg font-semibold text-yellow-400 mb-2 block">Select Language:</label>
                    <select id="language-select" class="neumorphic bg-gray-700 text-yellow-400 rounded-lg px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 transition duration-300" onchange="changeLanguage()">
                        <option value="ar">Arabic</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="zh">Chinese</option>
                    </select>
                </div>

                <div class="items-center px-4 py-3 mt-6">
                    <button id="close-settings" class="w-full neumorphic electric-border bg-gray-600 text-yellow-400 px-6 py-3 rounded-full hover:bg-gray-500 transition duration-300 font-medium">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lc;
        let tl;
        let consultationHistory = [];
        let isThinking = false;
        let allConsultations = [];
        let currentConsultationIndex = -1;
        let aiIsThinking = "AI is thinking...";
        let systemPrompt = "You are an AI electrician. Ask the user questions about their electrical issues and use their responses to build a diagnosis of the problem. Use sensor data or electrical measurements when available. Use step-by-step reasoning and share them with the client. Use markdown sections to enhance the quality of your answer and discussion. If you need more information, ask questions until you feel confident in your judgment. Only provide a final diagnosis when you have enough information. Use the '## Electrical Diagnosis' header to specify the final diagnosis. Use markdown formatting in your responses to enhance readability. You can also use mermaid diagrams for a better explanation of electrical circuits or systems, in this case put it inside a mermaid markdown code tag. The user may upload images of electrical components, CSV files with voltage/current readings, or PDF files with electrical schematics. When they do, analyze the information and incorporate it into your diagnosis of the electrical problem.";

        const translations = {
            en: {
                appTitle: "Car Wizard",
                send: "Send",
                exportData: "Export data",
                importData: "Import data",
                aiIsThinking: "Car Mechanics Companion is thinking ...",
                languageSelection: "Select language",
                iUnderstand: "I understand",
                previousConsultations: "Previous consultations",
                startNewConsultation: "Start New consultation",
                saveConsultation:"Save consultation",
                consultationTitle: "Consultation",
                diagnosisTitle: "Final Diagnosis",
                reasoningTitle: "Car Mechanics Companion's Reasoning",
                disclaimerTitle: "Disclaimer",
                disclaimerText: "Car Wizard is an AI assistant for informational purposes only. Always consult with a certified mechanic for professional advice and before attempting any car repairs.",
                welcomeTitle: "Welcome to Car Mechanics Companion",
                welcomeText: "Your virtual electrician assistant is ready to help you. Start a new consultation to begin.",
                welcomeMessage: `
Welcome to Car Wizard: Your Virtual Car Mechanic Assistant!

I'm Car Wizard, your personal AI car mechanic, here to help you diagnose and fix issues with your vehicle. Whether you're dealing with strange noises, performance problems, or dashboard warning lights, I'm here to guide you through the troubleshooting process.

Here's how I can assist you:

1. Diagnose car issues based on your descriptions
2. Provide step-by-step guidance for simple repairs
3. Offer maintenance advice and schedules
4. Explain car components and systems
5. Recommend when it's time to visit a professional mechanic

Remember, safety is our top priority. Always follow proper precautions when working on your vehicle, and never hesitate to seek professional help for complex or dangerous situations.

To get started, simply describe the problem you're experiencing with your car, and I'll help you get back on the road!

How can I help tune up your day with some automotive expertise?                
        `,
        systemPrompt: "You are Car Wizard, an AI car mechanic. Ask the user questions about their car issues and use their responses to diagnose problems. Use step-by-step reasoning and share it with the user. Use markdown sections to enhance the quality of your answer and discussion. If you need more information, ask questions until you feel confident in your assessment. Only provide a final diagnosis when you have enough information. Use the '## Diagnosis' header to specify the final diagnosis. Use markdown formatting in your responses to enhance readability. You can also use mermaid diagrams for a better explanation of car systems, in this case put it inside a mermaid markdown code tag. The user may upload images, diagnostic data, or measurement data. When they do, analyze the information and incorporate it into your diagnosis. Always prioritize safety and recommend professional help for complex or dangerous situations."
            },             
            es: {
        appTitle: "Asistente de Automóviles",
        send: "Enviar",
        exportData: "Exportar datos",
        importData: "Importar datos",
        aiIsThinking: "El Compañero de Mecánica de Automóviles está pensando ...",
        languageSelection: "Seleccionar idioma",
        iUnderstand: "Entiendo",
        previousConsultations: "Consultas anteriores",
        startNewConsultation: "Iniciar nueva consulta",
        saveConsultation: "Guardar consulta",
        consultationTitle: "Consulta",
        diagnosisTitle: "Diagnóstico Final",
        reasoningTitle: "Razonamiento del Compañero de Mecánica de Automóviles",
        disclaimerTitle: "Aviso legal",
        disclaimerText: "Asistente de Automóviles es un asistente de IA solo con fines informativos. Siempre consulte a un mecánico certificado para obtener asesoramiento profesional y antes de intentar cualquier reparación de automóviles.",
        welcomeTitle: "Bienvenido al Compañero de Mecánica de Automóviles",
        welcomeText: "Su asistente virtual de mecánica está listo para ayudarlo. Inicie una nueva consulta para comenzar.",
        welcomeMessage: `
¡Bienvenido al Asistente de Automóviles: Tu Mecánico Virtual de Coches!

Soy el Asistente de Automóviles, tu mecánico personal de IA, aquí para ayudarte a diagnosticar y solucionar problemas con tu vehículo. Ya sea que estés lidiando con ruidos extraños, problemas de rendimiento o luces de advertencia en el tablero, estoy aquí para guiarte a través del proceso de resolución de problemas.

Así es como puedo ayudarte:

1. Diagnosticar problemas del coche basándome en tus descripciones
2. Proporcionar orientación paso a paso para reparaciones simples
3. Ofrecer consejos y programas de mantenimiento
4. Explicar los componentes y sistemas del coche
5. Recomendar cuándo es el momento de visitar a un mecánico profesional

Recuerda, la seguridad es nuestra prioridad principal. Siempre sigue las precauciones adecuadas cuando trabajes en tu vehículo, y nunca dudes en buscar ayuda profesional para situaciones complejas o peligrosas.

Para comenzar, simplemente describe el problema que estás experimentando con tu coche, ¡y te ayudaré a volver a la carretera!

¿Cómo puedo ayudarte a mejorar tu día con algo de experiencia automotriz?
        `,
        systemPrompt: "Eres el Asistente de Automóviles, un mecánico de coches de IA. Haz preguntas al usuario sobre los problemas de su coche y utiliza sus respuestas para diagnosticar problemas. Utiliza un razonamiento paso a paso y compártelo con el usuario. Usa secciones de markdown para mejorar la calidad de tu respuesta y discusión. Si necesitas más información, haz preguntas hasta que te sientas seguro en tu evaluación. Solo proporciona un diagnóstico final cuando tengas suficiente información. Utiliza el encabezado '## Diagnóstico' para especificar el diagnóstico final. Utiliza formato markdown en tus respuestas para mejorar la legibilidad. También puedes usar diagramas mermaid para una mejor explicación de los sistemas del coche, en este caso ponlos dentro de una etiqueta de código markdown mermaid. El usuario puede subir imágenes, datos de diagnóstico o datos de medición. Cuando lo hagan, analiza la información e incorpórala a tu diagnóstico. Siempre prioriza la seguridad y recomienda ayuda profesional para situaciones complejas o peligrosas."
    },
    fr: {
        appTitle: "Assistant Automobile",
        send: "Envoyer",
        exportData: "Exporter les données",
        importData: "Importer les données",
        aiIsThinking: "Le Compagnon de Mécanique Automobile réfléchit ...",
        languageSelection: "Sélectionner la langue",
        iUnderstand: "Je comprends",
        previousConsultations: "Consultations précédentes",
        startNewConsultation: "Démarrer une nouvelle consultation",
        saveConsultation: "Sauvegarder la consultation",
        consultationTitle: "Consultation",
        diagnosisTitle: "Diagnostic Final",
        reasoningTitle: "Raisonnement du Compagnon de Mécanique Automobile",
        disclaimerTitle: "Avertissement",
        disclaimerText: "L'Assistant Automobile est un assistant IA à des fins informatives uniquement. Consultez toujours un mécanicien certifié pour obtenir des conseils professionnels et avant d'essayer toute réparation automobile.",
        welcomeTitle: "Bienvenue au Compagnon de Mécanique Automobile",
        welcomeText: "Votre assistant mécanicien virtuel est prêt à vous aider. Commencez une nouvelle consultation pour débuter.",
        welcomeMessage: `
Bienvenue à l'Assistant Automobile : Votre Mécanicien Automobile Virtuel !

Je suis l'Assistant Automobile, votre mécanicien personnel IA, ici pour vous aider à diagnostiquer et à résoudre les problèmes de votre véhicule. Que vous ayez affaire à des bruits étranges, des problèmes de performance ou des voyants d'avertissement sur le tableau de bord, je suis là pour vous guider à travers le processus de dépannage.

Voici comment je peux vous aider :

1. Diagnostiquer les problèmes de voiture basés sur vos descriptions
2. Fournir des conseils étape par étape pour des réparations simples
3. Offrir des conseils et des programmes d'entretien
4. Expliquer les composants et les systèmes de la voiture
5. Recommander quand il est temps de consulter un mécanicien professionnel

N'oubliez pas, la sécurité est notre priorité absolue. Suivez toujours les précautions appropriées lorsque vous travaillez sur votre véhicule, et n'hésitez jamais à chercher de l'aide professionnelle pour des situations complexes ou dangereuses.

Pour commencer, décrivez simplement le problème que vous rencontrez avec votre voiture, et je vous aiderai à reprendre la route !

Comment puis-je améliorer votre journée avec un peu d'expertise automobile ?
        `,
        systemPrompt: "Vous êtes l'Assistant Automobile, un mécanicien automobile IA. Posez des questions à l'utilisateur sur les problèmes de sa voiture et utilisez ses réponses pour diagnostiquer les problèmes. Utilisez un raisonnement étape par étape et partagez-le avec l'utilisateur. Utilisez des sections markdown pour améliorer la qualité de votre réponse et de la discussion. Si vous avez besoin de plus d'informations, posez des questions jusqu'à ce que vous vous sentiez confiant dans votre évaluation. Ne fournissez un diagnostic final que lorsque vous avez suffisamment d'informations. Utilisez l'en-tête '## Diagnostic' pour spécifier le diagnostic final. Utilisez le formatage markdown dans vos réponses pour améliorer la lisibilité. Vous pouvez également utiliser des diagrammes mermaid pour une meilleure explication des systèmes automobiles, dans ce cas, placez-les dans une balise de code markdown mermaid. L'utilisateur peut télécharger des images, des données de diagnostic ou des données de mesure. Lorsqu'il le fait, analysez les informations et intégrez-les dans votre diagnostic. Priorisez toujours la sécurité et recommandez une aide professionnelle pour les situations complexes ou dangereuses."
    },
    de: {
        appTitle: "Auto-Assistent",
        send: "Senden",
        exportData: "Daten exportieren",
        importData: "Daten importieren",
        aiIsThinking: "Der Auto-Mechanik-Begleiter denkt nach ...",
        languageSelection: "Sprache auswählen",
        iUnderstand: "Ich verstehe",
        previousConsultations: "Vorherige Beratungen",
        startNewConsultation: "Neue Beratung starten",
        saveConsultation: "Beratung speichern",
        consultationTitle: "Beratung",
        diagnosisTitle: "Endgültige Diagnose",
        reasoningTitle: "Überlegungen des Auto-Mechanik-Begleiters",
        disclaimerTitle: "Haftungsausschluss",
        disclaimerText: "Der Auto-Assistent ist ein KI-Assistent nur zu Informationszwecken. Konsultieren Sie immer einen zertifizierten Mechaniker für professionelle Beratung und bevor Sie Autoreparaturen versuchen.",
        welcomeTitle: "Willkommen beim Auto-Mechanik-Begleiter",
        welcomeText: "Ihr virtueller Mechaniker-Assistent ist bereit, Ihnen zu helfen. Starten Sie eine neue Beratung, um zu beginnen.",
        welcomeMessage: `
Willkommen beim Auto-Assistent: Ihr virtueller Automechaniker!

Ich bin der Auto-Assistent, Ihr persönlicher KI-Automechaniker, hier um Ihnen bei der Diagnose und Behebung von Problemen mit Ihrem Fahrzeug zu helfen. Ob Sie es mit seltsamen Geräuschen, Leistungsproblemen oder Warnleuchten im Armaturenbrett zu tun haben, ich bin hier, um Sie durch den Fehlerbehebungsprozess zu führen.

So kann ich Ihnen helfen:

1. Autoprobleme basierend auf Ihren Beschreibungen diagnostizieren
2. Schritt-für-Schritt-Anleitung für einfache Reparaturen geben
3. Wartungsratschläge und -pläne anbieten
4. Autokomponenten und -systeme erklären
5. Empfehlen, wann es Zeit ist, einen professionellen Mechaniker aufzusuchen

Denken Sie daran, Sicherheit hat oberste Priorität. Befolgen Sie immer die richtigen Vorsichtsmaßnahmen, wenn Sie an Ihrem Fahrzeug arbeiten, und zögern Sie nie, bei komplexen oder gefährlichen Situationen professionelle Hilfe in Anspruch zu nehmen.

Um zu beginnen, beschreiben Sie einfach das Problem, das Sie mit Ihrem Auto haben, und ich werde Ihnen helfen, wieder auf die Straße zu kommen!

Wie kann ich Ihren Tag mit etwas Automobil-Expertise verbessern?
        `,
        systemPrompt: "Sie sind der Auto-Assistent, ein KI-Automechaniker. Stellen Sie dem Benutzer Fragen zu seinen Autoproblemen und verwenden Sie seine Antworten, um Probleme zu diagnostizieren. Verwenden Sie schrittweises Denken und teilen Sie es mit dem Benutzer. Verwenden Sie Markdown-Abschnitte, um die Qualität Ihrer Antwort und Diskussion zu verbessern. Wenn Sie mehr Informationen benötigen, stellen Sie Fragen, bis Sie sich in Ihrer Einschätzung sicher fühlen. Geben Sie erst eine endgültige Diagnose, wenn Sie genug Informationen haben. Verwenden Sie die Überschrift '## Diagnose', um die endgültige Diagnose anzugeben. Verwenden Sie Markdown-Formatierung in Ihren Antworten, um die Lesbarkeit zu verbessern. Sie können auch Mermaid-Diagramme für eine bessere Erklärung von Autosystemen verwenden, in diesem Fall setzen Sie sie in ein Mermaid-Markdown-Code-Tag. Der Benutzer kann Bilder, Diagnosedaten oder Messdaten hochladen. Wenn sie das tun, analysieren Sie die Informationen und integrieren Sie sie in Ihre Diagnose. Priorisieren Sie immer die Sicherheit und empfehlen Sie professionelle Hilfe für komplexe oder gefährliche Situationen."
    },
    zh: {
    appTitle: "汽车精灵",
    send: "发送",
    exportData: "导出数据",
    importData: "导入数据",
    aiIsThinking: "汽车维修伙伴正在思考...",
    languageSelection: "选择语言",
    iUnderstand: "我明白了",
    previousConsultations: "以前的咨询",
    startNewConsultation: "开始新的咨询",
    saveConsultation: "保存咨询",
    consultationTitle: "咨询",
    diagnosisTitle: "最终诊断",
    reasoningTitle: "汽车维修伙伴的推理",
    disclaimerTitle: "免责声明",
    disclaimerText: "汽车精灵是一个仅供参考的AI助手。在尝试任何汽车维修之前，请务必咨询认证的机械师以获得专业建议。",
    welcomeTitle: "欢迎使用汽车维修伙伴",
    welcomeText: "您的虚拟汽车维修助手已准备就绪。开始新的咨询以开始。",
    welcomeMessage: `
欢迎使用汽车精灵：您的虚拟汽车维修助手！

我是汽车精灵，您的个人AI汽车维修师，在此帮助您诊断和修复车辆问题。无论您遇到奇怪的噪音、性能问题还是仪表盘警告灯，我都在这里指导您完成故障排除过程。

以下是我可以帮助您的方式：

1. 根据您的描述诊断汽车问题
2. 为简单维修提供逐步指导
3. 提供保养建议和时间表
4. 解释汽车部件和系统
5. 建议何时需要专业机械师

请记住，安全是我们的首要任务。在处理车辆时始终遵循适当的预防措施，对于复杂或危险的情况，请不要犹豫寻求专业帮助。

要开始，只需描述您的汽车遇到的问题，我将帮助您重新上路！

我能如何用一些汽车专业知识来帮您调整今天的心情呢？
    `,
    systemPrompt: "您是汽车精灵，一位AI汽车维修师。向用户询问他们的汽车问题，并使用他们的回答来诊断问题。使用逐步推理并与用户分享。使用markdown部分来提高回答和讨论的质量。如果需要更多信息，请继续提问直到您对评估有信心。只有在您有足够信息时才提供最终诊断。使用'## 诊断'标题来指定最终诊断。在您的回答中使用markdown格式以提高可读性。您还可以使用mermaid图表来更好地解释汽车系统，在这种情况下，将其放在mermaid markdown代码标签内。用户可能会上传图像、诊断数据或测量数据。当他们这样做时，分析信息并将其纳入您的诊断中。始终优先考虑安全，并对复杂或危险的情况推荐专业帮助。"
  },
  ar: {
    appTitle: "ساحر السيارات",
    send: "إرسال",
    exportData: "تصدير البيانات",
    importData: "استيراد البيانات",
    aiIsThinking: "رفيق ميكانيكا السيارات يفكر ...",
    languageSelection: "اختر اللغة",
    iUnderstand: "أفهم",
    previousConsultations: "الاستشارات السابقة",
    startNewConsultation: "بدء استشارة جديدة",
    saveConsultation: "حفظ الاستشارة",
    consultationTitle: "استشارة",
    diagnosisTitle: "التشخيص النهائي",
    reasoningTitle: "تفكير رفيق ميكانيكا السيارات",
    disclaimerTitle: "إخلاء المسؤولية",
    disclaimerText: "ساحر السيارات هو مساعد ذكاء اصطناعي لأغراض المعلومات فقط. استشر دائمًا ميكانيكي معتمد للحصول على نصيحة مهنية وقبل محاولة أي إصلاحات للسيارة.",
    welcomeTitle: "مرحبًا بك في رفيق ميكانيكا السيارات",
    welcomeText: "مساعدك الافتراضي لميكانيكا السيارات جاهز لمساعدتك. ابدأ استشارة جديدة للبدء.",
    welcomeMessage: `
مرحبًا بك في ساحر السيارات: مساعدك الافتراضي لميكانيكا السيارات!

أنا ساحر السيارات، ميكانيكي السيارات الشخصي بالذكاء الاصطناعي، هنا لمساعدتك في تشخيص وإصلاح مشاكل سيارتك. سواء كنت تتعامل مع أصوات غريبة، أو مشاكل في الأداء، أو أضواء تحذير في لوحة القيادة، أنا هنا لإرشادك خلال عملية استكشاف الأخطاء وإصلاحها.

إليك كيف يمكنني مساعدتك:

1. تشخيص مشاكل السيارة بناءً على وصفك
2. تقديم إرشادات خطوة بخطوة للإصلاحات البسيطة
3. تقديم نصائح وجداول الصيانة
4. شرح مكونات وأنظمة السيارة
5. التوصية بموعد زيارة ميكانيكي محترف

تذكر، السلامة هي أولويتنا القصوى. اتبع دائمًا الاحتياطات المناسبة عند العمل على سيارتك، ولا تتردد أبدًا في طلب المساعدة المهنية للمواقف المعقدة أو الخطرة.

للبدء، ما عليك سوى وصف المشكلة التي تواجهها مع سيارتك، وسأساعدك في العودة إلى الطريق!

كيف يمكنني المساعدة في تحسين يومك ببعض الخبرة في السيارات؟
    `,
    systemPrompt: "أنت ساحر السيارات، ميكانيكي سيارات بالذكاء الاصطناعي. اسأل المستخدم أسئلة حول مشاكل سيارتهم واستخدم إجاباتهم لتشخيص المشاكل. استخدم التفكير خطوة بخطوة وشاركه مع المستخدم. استخدم أقسام markdown لتحسين جودة إجابتك ومناقشتك. إذا كنت بحاجة إلى مزيد من المعلومات، اطرح أسئلة حتى تشعر بالثقة في تقييمك. قدم التشخيص النهائي فقط عندما يكون لديك معلومات كافية. استخدم عنوان '## التشخيص' لتحديد التشخيص النهائي. استخدم تنسيق markdown في ردودك لتحسين القراءة. يمكنك أيضًا استخدام مخططات mermaid لشرح أفضل لأنظمة السيارات، في هذه الحالة ضعها داخل علامة كود markdown الخاصة بـ mermaid. قد يقوم المستخدم بتحميل صور أو بيانات تشخيصية أو بيانات قياس. عندما يفعلون ذلك، قم بتحليل المعلومات وإدراجها في تشخيصك. دائمًا أعط الأولوية للسلامة وأوصِ بالمساعدة المهنية للمواقف المعقدة أو الخطرة."
  }             
        };

        // Animation for electric border
        gsap.to(".electric-border::before", {
            duration: 2,
            repeat: -1,
            ease: "linear",
            background: "linear-gradient(270deg, #00fffc, #fc00ff, #fffc00)",
        });

        // Pulse animation for buttons
        gsap.to(".neumorphic", {
            scale: 1.05,
            duration: 0.5,
            repeat: -1,
            yoyo: true,
            ease: "power1.inOut",
        });

        // Function to show/hide the settings popup
        document.getElementById('settings-button').addEventListener('click', function() {
            document.getElementById('settings-popup').classList.toggle('hidden');
        });

        document.getElementById('close-settings').addEventListener('click', function() {
            document.getElementById('settings-popup').classList.add('hidden');
        });



        let recognition;
        let isListening = false;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    // Combine final and interim transcripts
                    const fullTranscript = finalTranscript + interimTranscript;
                    document.getElementById('user-input').value = fullTranscript;
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                };

                recognition.onend = function() {
                    isListening = false;
                    updateMicButtonState();
                };
            } else {
                console.error('Speech recognition not supported');
                document.getElementById('mic-button').style.display = 'none';
            }
        }

        function toggleSpeechRecognition() {
            if (!recognition) {
                initSpeechRecognition();
            }

            if (isListening) {
                recognition.stop();
            } else {
                const selectedLanguage = document.getElementById('language-select').value;
                recognition.lang = selectedLanguage;
                recognition.start();
                isListening = true;
            }
            updateMicButtonState();
        }

        function updateMicButtonState() {
            const micButton = document.getElementById('mic-button');
            if (isListening) {
                micButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                micButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                micButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                micButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        // Add event listener to the mic button
        document.getElementById('mic-button').addEventListener('click', toggleSpeechRecognition);


        let selectedVoice = null;

        document.addEventListener('DOMContentLoaded', function() {
            const settingsButton = document.getElementById('settings-button');
            const settingsPopup = document.getElementById('settings-popup');
            const closeSettingsButton = document.getElementById('close-settings');
            const voiceSelect = document.getElementById('voice-select');

            settingsButton.addEventListener('click', function() {
                settingsPopup.classList.remove('hidden');
                populateVoiceList();
            });

            closeSettingsButton.addEventListener('click', function() {
                settingsPopup.classList.add('hidden');
            });

            voiceSelect.addEventListener('change', function() {
                selectedVoice = voiceSelect.value;
            });

            function populateVoiceList() {
                const selectedLanguage = document.getElementById('language-select').value;
                const voices = speechSynthesis.getVoices();
                
                voiceSelect.innerHTML = '';
                
                voices.forEach(function(voice) {
                    if (voice.lang.startsWith(selectedLanguage)) {
                        const option = document.createElement('option');
                        option.textContent = voice.name + ' (' + voice.lang + ')';
                        option.value = voice.name;
                        voiceSelect.appendChild(option);
                    }
                });

                if (selectedVoice) {
                    voiceSelect.value = selectedVoice;
                }
            }

            // Ensure voices are loaded
            speechSynthesis.onvoiceschanged = populateVoiceList;
        });

        // Update the readMessage function to use the selected voice
        function readMessage(button) {
            const messageText = button.parentElement.textContent.split(':')[1].trim();
            const selectedLanguage = document.getElementById('language-select').value;
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(messageText);
                utterance.lang = selectedLanguage;

                if (selectedVoice) {
                    const voices = speechSynthesis.getVoices();
                    const voice = voices.find(v => v.name === selectedVoice);
                    if (voice) {
                        utterance.voice = voice;
                    }
                }
                
                speechSynthesis.cancel(); // Stop any ongoing speech
                speechSynthesis.speak(utterance);
            } else {
                console.error('Text-to-speech not supported in this browser.');
                alert('Text-to-speech is not supported in your browser.');
            }
        }

        // Update the changeLanguage function to repopulate the voice list
        function changeLanguage() {
            const selectedLanguage = document.getElementById('language-select').value;
            localStorage.setItem('selectedLanguage', selectedLanguage);
            updateLanguage(selectedLanguage);
            systemPrompt = translations[selectedLanguage].systemPrompt;
            
            // Update speech recognition language
            if (recognition) {
                recognition.lang = selectedLanguage;
            }

            // Repopulate voice list
            populateVoiceList();
        }


    function updateLanguage(language) {
        document.getElementById('app-title').innerText = translations[language].appTitle;
        document.getElementById('start-new-consultation').innerText = translations[language].startNewConsultation;
        document.getElementById('new-consultation').innerText = translations[language].startNewConsultation;
        document.getElementById('save-consultation').innerText = translations[language].saveConsultation;
        document.getElementById('language-select-label').innerText = translations[language].languageSelection;
        document.getElementById('i-understand').innerText = translations[language].iUnderstand;


        document.getElementById('send-button').innerText = translations[language].send;
        document.getElementById('export-button').innerText = translations[language].exportData;
        document.getElementById('import-button').innerText = translations[language].importData;
        document.getElementById('previous-consultations').innerText = translations[language].previousConsultations;        
        
        document.getElementById('consultation-title').innerText = translations[language].consultationTitle;
        document.getElementById('diagnosis-title').innerText = translations[language].diagnosisTitle;
        document.getElementById('reasoning-title').innerText = translations[language].reasoningTitle;
        document.getElementById('disclaimer-title').innerText = translations[language].disclaimerTitle;
        document.getElementById('disclaimer-text').innerText = translations[language].disclaimerText;
        document.getElementById('welcome-title').innerText = translations[language].welcomeTitle;
        document.getElementById('welcome-text').innerText = translations[language].welcomeText;
    }
    function loadSettings() {
        const storedLanguage = localStorage.getItem('selectedLanguage') || 'en'; // Default to English if no language is stored
        document.getElementById('language-select').value = storedLanguage; // Set the dropdown to the stored language
        updateLanguage(storedLanguage); // Update the UI with the stored language
        systemPrompt = translations[storedLanguage].systemPrompt; // Set the initial system prompt
    }

        async function initializeLollms() {
            lc = new LollmsClient(
                null,
                null,
                4096,
                -1,
                4096,
                0.7,
                50,
                0.95,
                1.1,
                64,
                null,
                8,
                "",
                ELF_GENERATION_FORMAT.LOLLMS
            );
            tl = new TasksLibrary(lc);
            loadPreviousConsultations();
        }

        function showWelcomePage() {
            document.getElementById('welcome-page').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
        }

        function showConsultationView() {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            startNewConsultation();
        }


        // Modify the startNewConsultation function
        async function startNewConsultation() {
            consultationHistory = [];
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('diagnosis-container').innerHTML = '';
            document.getElementById('final-diagnosis').classList.add('hidden');
            
            document.getElementById('mermaid-container').style.display = 'none';
            currentConsultationIndex = -1;

            const selectedLanguage = document.getElementById('language-select').value;
            const response = translations[selectedLanguage].welcomeMessage;
            updateChatContainer("AI", response);
            consultationHistory.push({role: "system", content: systemPrompt});
            consultationHistory.push({role: "assistant", content: response});
            
            processMermaidDiagram(response);
            extractDiagnosis(response);
        }

        async function sendMessage() {
            if (isThinking) return;

            const userInput = document.getElementById('user-input').value;
            if (!userInput) return;

            updateChatContainer("You", userInput);
            consultationHistory.push({role: "user", content: userInput});

            const prompt = consultationHistory.map(msg => {
                if (msg.role === "user") return lc.user_message() + msg.content;
                if (msg.role === "assistant") return lc.ai_message() + msg.content;
                return "";
            }).join(lc.template.separator_template) + lc.template.separator_template + lc.ai_message();

            setThinking(true);
            
            // Extract images from consultationHistory
            const images = consultationHistory.filter(msg => msg.role === "image").map(msg => msg.content);
            
            let response;
            try {
                // Attempt to generate response with images
                response = images.length > 0 
                    ? await lc.generate_with_images(prompt, images) 
                    : await lc.generate(prompt); // Fallback to generate if no images
            } catch (error) {
                // If generate_with_images fails, fallback to generate and notify the user
                console.error("Image input not supported:", error);
                response = await lc.generate(prompt);
                updateChatContainer("AI", "The model you are using does not support image inputs. Here is the response without images:");
            }

            setThinking(false);
            updateChatContainer("AI", response);
            consultationHistory.push({role: "assistant", content: response});

            document.getElementById('user-input').value = '';

            processMermaidDiagram(response);
            extractDiagnosis(response);
            // Add visual feedback
            let sendButton = document.getElementById('send-button');
            sendButton.classList.add('animate-ping');
            setTimeout(() => {
                sendButton.classList.remove('animate-ping');
            }, 300);

        }
        // Initialize tooltips for better UX
        tippy('[data-tippy-content]', {
            theme: 'electric',
            animation: 'scale',
        });

        async function handleFileUpload(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;

            let fileContent = '';
            let fileInfo = '';
            let images = []; // Array to hold base64 images

            if (fileType === 'image') {
                fileContent = await readFileAsDataURL(file);
                images.push(fileContent); // Store the base64 image
                fileInfo = `[An image file named "${file.name}" (${file.type}) has been uploaded.]`;
                consultationHistory.push({role: "image", content: fileContent}); // Store in consultationHistory
                updateChatContainer("You", fileContent, true); // Pass true to indicate it's an image
            } else if (fileType === 'csv') {
                fileContent = await readFileAsText(file);
                fileInfo = `[A CSV file named "${file.name}" has been uploaded. Its content is as follows:]\n\n${fileContent}`;
                consultationHistory.push({role: "document", content: fileContent}); // Store in consultationHistory
                updateChatContainer("You", fileInfo);
            } else if (fileType === 'pdf') {
                fileContent = await readFileAsArrayBuffer(file);
                const pdfText = await extractTextFromPDF(fileContent);
                fileInfo = `[A PDF file named "${file.name}" has been uploaded. Its textual content is as follows:]\n\n${pdfText}`;
                consultationHistory.push({role: "document", content: pdfText}); // Store in consultationHistory
                updateChatContainer("You", fileInfo);
            }
        }

        function updateChatContainer(sender, message, isImage = false, index) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 p-3 rounded-lg ${sender === 'You' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`;
            
            if (isImage) {
                messageDiv.innerHTML = `
                    <strong>${sender}:</strong>
                    <img src="${message}" alt="Uploaded Image" style="max-width: 100%; height: auto;" />
                    <button onclick="deleteMessage(this, ${index})" aria-label="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                            <path d="M5.5 5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 .5.5v1h-6v-1zm1-3a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v1h4a.5.5 0 0 1 0 1h-1.5l-.5 10a.5.5 0 0 1-.5.5H4a.5.5 0 0 1-.5-.5l-.5-10H1a.5.5 0 0 1 0-1h4V2z"/>
                        </svg>
                    </button>
                `;
            } else {
                messageDiv.innerHTML = `
                    <strong>${sender}:</strong> ${marked.parse(message)}
                    <button onclick="editMessage(this, ${index})" aria-label="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-1.5 1.5-3.708-3.708 1.5-1.5a.5.5 0 0 1 0-.708zM11.207 2.5l-1.5 1.5 3.708 3.708 1.5-1.5-3.708-3.708zM1 13.5V15h1.5l8.5-8.5-1.5-1.5L1 13.5z"/>
                        </svg>
                    </button>
                    <button onclick="deleteMessage(this, ${index})" aria-label="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                            <path d="M5.5 5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 .5.5v1h-6v-1zm1-3a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v1h4a.5.5 0 0 1 0 1h-1.5l-.5 10a.5.5 0 0 1-.5.5H4a.5.5 0 0 1-.5-.5l-.5-10H1a.5.5 0 0 1 0-1h4V2z"/>
                        </svg>
                    </button>
                    <button onclick="readMessage(this)" aria-label="Read">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up" viewBox="0 0 16 16">
                            <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                            <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                            <path d="M10.025 8a4.486 4.486 0 0 1-1.318 3.182L8 10.475A3.489 3.489 0 0 0 9.025 8c0-.966-.392-1.841-1.025-2.475l.707-.707A4.486 4.486 0 0 1 10.025 8zM7 4a.5.5 0 0 0-.812-.39L3.825 5.5H1.5A.5.5 0 0 0 1 6v4a.5.5 0 0 0 .5.5h2.325l2.363 1.89A.5.5 0 0 0 7 12V4zM4.312 6.39 6 5.04v5.92L4.312 9.61A.5.5 0 0 0 4 9.5H2v-3h2a.5.5 0 0 0 .312-.11z"/>
                        </svg>
                    </button>
                `;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }



        function loadConsultationData(data) {
            consultationHistory = data.consultationHistory;
            document.getElementById('chat-container').innerHTML = '';
            consultationHistory.forEach((msg, index) => {
                if (msg.role !== "system") {
                    updateChatContainer(msg.role === "user" ? "You" : msg.role === "image" ? "image": msg.role === "document"? "document" : "AI", msg.content, msg.role=="image", index);
                }
            });
            document.getElementById('diagnosis-container').innerHTML = data.diagnosis;
            document.getElementById('final-diagnosis').classList.remove('hidden');
            const lastResponse = consultationHistory[consultationHistory.length - 1].content;
            processMermaidDiagram(lastResponse);
        }


        function editMessage(button, index) {
            const messageDiv = button.closest('div');
            if (!messageDiv) return;

            const currentMessage = messageDiv.innerHTML.split('</strong>')[1].split('<button')[0].trim();
            const newMessage = prompt("Edit your message:", currentMessage);

            if (newMessage !== null && newMessage !== "") {
                const sender = messageDiv.querySelector('strong').textContent.replace(':', '');
                messageDiv.innerHTML = `
                    <strong>${sender}:</strong> ${marked.parse(newMessage)}
                    <button onclick="editMessage(this, ${index})" aria-label="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-1.5 1.5-3.708-3.708 1.5-1.5a.5.5 0 0 1 0-.708zM11.207 2.5l-1.5 1.5 3.708 3.708 1.5-1.5-3.708-3.708zM1 13.5V15h1.5l8.5-8.5-1.5-1.5L1 13.5z"/>
                        </svg>
                    </button>
                    <button onclick="deleteMessage(this, ${index})" aria-label="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                            <path d="M5.5 5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 .5.5v1h-6v-1zm1-3a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v1h4a.5.5 0 0 1 0 1h-1.5l-.5 10a.5.5 0 0 1-.5.5H4a.5.5 0 0 1-.5-.5l-.5-10H1a.5.5 0 0 1 0-1h4V2z"/>
                        </svg>
                    </button>
                `;
                // Update consultationHistory
                if (consultationHistory[index]) {
                    consultationHistory[index].content = newMessage;
                }
            }
        }

        function deleteMessage(button, index) {
            const messageDiv = button.closest('div');
            if (!messageDiv) return;

            // Update consultationHistory before removing the element
            if (index !== -1) {
                consultationHistory.splice(index, 1);
            }

            messageDiv.remove();

            // Adjust indices for remaining messages
            const chatContainer = document.getElementById('chat-container');
            const remainingMessages = chatContainer.querySelectorAll('div');
            remainingMessages.forEach((msg, newIndex) => {
                const editBtn = msg.querySelector('button[aria-label="Edit"]');
                const deleteBtn = msg.querySelector('button[aria-label="Delete"]');
                if (editBtn) editBtn.setAttribute('onclick', `editMessage(this, ${newIndex})`);
                if (deleteBtn) deleteBtn.setAttribute('onclick', `deleteMessage(this, ${newIndex})`);
            });
        }

        function extractDiagnosis(response) {
            const diagnosisMatch = response.match(/## Diagnosis\s*([\s\S]*?)(?=\n#|$)/i);
            if (diagnosisMatch) {
                const diagnosis = diagnosisMatch[1].trim();
                document.getElementById('diagnosis-container').innerHTML = marked.parse(diagnosis);
                document.getElementById('final-diagnosis').classList.remove('hidden');
            }
        }

        function processMermaidDiagram(response) {
            const codes = tl.extractCodeBlocks(response);
            const mermaidCode = codes.find(code => code.language === 'mermaid');
            
            const mermaidContainer = document.getElementById('mermaid-container');
            if (mermaidCode) {
                mermaidContainer.style.display = 'block';
                const mermaidDiagram = document.getElementById('mermaid-diagram');
                mermaidDiagram.innerHTML = mermaidCode.content;
                mermaid.init(undefined, mermaidDiagram);
            } else {
                mermaidContainer.style.display = 'none';
            }
        }

        function exportData() {
            const data = {
                consultationHistory: consultationHistory,
                diagnosis: document.getElementById('diagnosis-container').innerHTML
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "car_wizard_consultation.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const importedData = JSON.parse(e.target.result);
                    loadConsultationData(importedData);
                };
                reader.readAsText(file);
            }
        }

        function setThinking(thinking) {
            isThinking = thinking;
            const buttons = ['send-button', 'export-button', 'import-button'];
            const userInput = document.getElementById('user-input');
            
            buttons.forEach(id => {
                const button = document.getElementById(id);
                button.disabled = thinking;
                button.classList.toggle('opacity-50', thinking);
                button.classList.toggle('cursor-not-allowed', thinking);
            });
            
            userInput.disabled = thinking;
            userInput.classList.toggle('bg-gray-100', thinking);
            
            if (thinking) {
                const thinkingDiv = document.createElement('div');
                thinkingDiv.id = 'thinking-indicator';
                thinkingDiv.className = 'flex items-center justify-center p-4';
                thinkingDiv.innerHTML = `<div class="thinking-animation mr-3"></div><span class="text-blue-600 font-medium">${aiIsThinking}</span>`;
                document.getElementById('chat-container').appendChild(thinkingDiv);
            } else {
                const thinkingDiv = document.getElementById('thinking-indicator');
                if (thinkingDiv) thinkingDiv.remove();
            }
        }

        function saveConsultation() {
            const data = {
                consultationHistory: consultationHistory,
                diagnosis: document.getElementById('diagnosis-container').innerHTML
            };
            const timestamp = new Date().toISOString();
            const consultation = { timestamp, data };
            
            if (currentConsultationIndex === -1) {
                allConsultations.push(consultation);
                currentConsultationIndex = allConsultations.length - 1;
            } else {
                allConsultations[currentConsultationIndex] = consultation;
            }
            
            localStorage.setItem('aiCarWizardConsultations', JSON.stringify(allConsultations));
            updatePreviousConsultationsList();
        }

        function loadPreviousConsultations() {
            const savedConsultations = localStorage.getItem('aiCarWizardConsultations');
            if (savedConsultations) {
                allConsultations = JSON.parse(savedConsultations);
                updatePreviousConsultationsList();
            }
        }

        function updatePreviousConsultationsList() {
            const list = document.getElementById('previous-consultations-list');
            list.innerHTML = '';
            allConsultations.forEach((consultation, index) => {
                const li = document.createElement('li');
                li.className = 'mb-2 p-2 bg-gray-700 rounded cursor-pointer hover:bg-gray-500 transition duration-300 flex justify-between items-center';
                const dateSpan = document.createElement('span');
                dateSpan.textContent = new Date(consultation.timestamp).toLocaleString();
                dateSpan.onclick = () => {
                    document.getElementById('welcome-page').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    loadConsultation(index);
                }
                li.appendChild(dateSpan);
                
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '&#x2716;'; // X symbol
                deleteButton.className = 'text-red-600 hover:text-red-800 font-bold';
                deleteButton.onclick = (e) => {
                    e.stopPropagation();
                    removeConsultation(index);
                };
                li.appendChild(deleteButton);
                
                list.appendChild(li);
            });
        }

        function loadConsultation(index) {
            currentConsultationIndex = index;
            const selectedConsultation = allConsultations[index];
            loadConsultationData(selectedConsultation.data);
        }

        function removeConsultation(index) {
            if (confirm('Are you sure you want to delete this consultation?')) {
                allConsultations.splice(index, 1);
                localStorage.setItem('aiCarWizardConsultations', JSON.stringify(allConsultations));
                updatePreviousConsultationsList();
                if (currentConsultationIndex === index) {
                    startNewConsultation();
                } else if (currentConsultationIndex > index) {
                    currentConsultationIndex--;
                }
            }
        }


        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromPDF(arrayBuffer) {
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let markdownText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                
                // Initialize variables to store text and table data
                let pageText = '';
                let tableData = [];
                let currentRow = [];
                let lastY = null;

                // Process each item in the content
                content.items.forEach(item => {
                    const text = item.str;
                    const fontSize = item.transform[0]; // Approximate font size from transform matrix
                    const y = item.transform[5]; // Y position of the text

                    // Detect headers based on font size
                    if (fontSize > 12) { // Assuming larger font sizes are headers
                        pageText += `## ${text}\n\n`; // Use ## for sub-headers
                    } else {
                        // Check if we are still on the same row
                        if (lastY === null || Math.abs(lastY - y) < 5) { // Adjust threshold as needed
                            currentRow.push(text);
                        } else {
                            // If we have a complete row, push it to tableData
                            if (currentRow.length > 0) {
                                tableData.push(currentRow);
                                currentRow = [text]; // Start a new row
                            }
                        }
                        lastY = y; // Update lastY to current item's Y position
                        pageText += `${text} `;
                    }
                });

                // Push the last row if it exists
                if (currentRow.length > 0) {
                    tableData.push(currentRow);
                }

                // Format tables in Markdown
                if (tableData.length > 0) {
                    markdownText += `| ${tableData[0].join(' | ')} |\n`; // Header row
                    markdownText += `| ${tableData[0].map(() => '---').join(' | ')} |\n`; // Separator row
                    tableData.forEach(row => {
                        markdownText += `| ${row.join(' | ')} |\n`;
                    });
                    markdownText += '\n'; // New line after table
                } else {
                    markdownText += `# Page ${i}\n\n${pageText}\n\n`;
                }
            }
            
            return markdownText;
        }

        function showDisclaimer() {
            const showDisclaimer = localStorage.getItem('showDisclaimer') !== 'false';
            if (showDisclaimer) {
                document.getElementById('disclaimer-popup').style.display = 'flex';
            }
        }

        function closeDisclaimer() {
            const dontShowAgain = document.getElementById('dont-show-again').checked;
            if (dontShowAgain) {
                localStorage.setItem('showDisclaimer', 'false');
            }
            document.getElementById('disclaimer-popup').style.display = 'none';
        }

        // Modify the window.onload function to include showDisclaimer
        window.onload = function() {
            loadSettings();
            initializeLollms();
            showWelcomePage();
            showDisclaimer();
        };

        // Add event listener for Enter key in the input field
        document.getElementById('user-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
