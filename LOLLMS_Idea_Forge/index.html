<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOLLMS Idea Forge</title>
    <!-- For code highlighting -->
    <link rel="stylesheet" href="/lollms_assets/css/hilight.js.default.min">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>

    <!-- For LaTeX math rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>

    <!-- For Mermaid graph rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    
    <!-- tailwindcss -->
    <script src="/lollms_assets/js/tailwindcss"></script>
    <link href="/lollms_assets/css/tailwind.min" rel="stylesheet">


    <script src="/lollms_assets/js/axios.min"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>


   <!-- Prism CSS -->
   <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet" />
    
   <!-- Prism JS -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
   
   <!-- If you want additional languages, include them like this -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-javascript.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-markup.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-c.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-cpp.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-java.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-latex.min.js"></script>


   <!-- To read docx files -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.8/mammoth.browser.min.js"></script>

   <script src="/lollms_assets/js/lollms_client_js"></script>
   <script src="/lollms_assets/js/lollms_markdown_renderer"></script>
   <link rel="stylesheet" type="text/css" href="/lollms_assets/css/lollms_markdown_renderer">
   <!-- Render math -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">
   <script src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"></script>
   

</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-gray-100 transition-colors duration-200">
    <div id="app" class="container mx-auto px-4 py-8">
        <header class="bg-gradient-to-r rounded from-purple-600 to-indigo-600 py-6 px-8 mb-8">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center">
                    <img src="/apps/LOLLMS_Idea_Forge/icon.png" alt="LOLLMS Idea Forge Icon" class="w-12 h-12 mr-4 rounded-lg shadow-md">
                    <h1 class="text-4xl font-bold text-white">LOLLMS Idea Forge</h1>
                </div>
                <nav class="flex items-center space-x-4">
                    <button id="projects-btn" class="px-4 py-2 rounded-md text-white hover:bg-white hover:bg-opacity-20 transition duration-300 ease-in-out">Projects</button>
                    <button id="settings-btn" class="px-4 py-2 rounded-md text-white hover:bg-white hover:bg-opacity-20 transition duration-300 ease-in-out">Settings</button>
                    <button id="help-btn" class="p-2 rounded-md text-white hover:bg-white hover:bg-opacity-20 transition duration-300 ease-in-out" aria-label="Help">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-full text-white hover:bg-white hover:bg-opacity-20 transition duration-300 ease-in-out">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                </nav>
            </div>
        </header>


        <main>
            <section id="projects-section" class="mb-8">
                <div class="min-h-screen bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="w-full mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 py-6 px-8">
                            <h1 class="text-3xl font-bold text-white">Projects</h1>
                        </div>
                        
                        <section id="projects" class="p-8">
                            <div id="projects-content" class="space-y-6">
                                <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <!-- Projects will be dynamically added here -->
                                </div>
                                <div class="pt-4">
                                    <button id="new-project-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                        New Project
                                    </button>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </section>
            
            <section id="settings-section" class="mb-8">
                <div class="min-h-screen bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="w-full mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 py-6 px-8">
                            <h1 class="text-3xl font-bold text-white">Settings</h1>
                        </div>
                        
                        <section id="settings" class="p-8">
                            <div id="settings-content" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label for="context-size" class="block text-sm font-medium text-gray-700">Context Size</label>
                                        <input type="number" id="context-size" value="128000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                                    </div>
                                    <div class="space-y-2">
                                        <label for="max-gen-size" class="block text-sm font-medium text-gray-700">Max Generation Size</label>
                                        <input type="number" id="max-gen-size" value="4096" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label for="lollms-host" class="block text-sm font-medium text-gray-700">LOLLMS Host Address</label>
                                    <input type="text" id="lollms-host" value="http://localhost:9600" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                                </div>
                                <div class="pt-4">
                                    <button id="save-settings" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                        Save Settings
                                    </button>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </section>
            
            <section id="idea-generation" class="mb-8">
                <div class="min-h-screen bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="w-full mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 py-6 px-8">
                            <h1 class="text-3xl font-bold text-white">Idea Generation</h1>
                        </div>
                        
                        <section id="idea-generation" class="p-8">
                            <div id="idea-generation-section" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label for="num-ideas" class="block text-sm font-medium text-gray-700">Number of Ideas</label>
                                        <input type="number" id="num-ideas" min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                                    </div>
                                    <div class="space-y-2">
                                        <label for="idea-category" class="block text-sm font-medium text-gray-700">Idea Category</label>
                                        <select id="idea-category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm rounded-md">
                                            <option value="brainstorming">Brainstorming</option>
                                            <option value="mind-mapping">Mind Mapping</option>
                                            <option value="product-development">Product Development</option>
                                            <option value="marketing-strategies">Marketing Strategies</option>
                                            <option value="problem-solving">Problem Solving</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label for="subject-specifications" class="block text-sm font-medium text-gray-700">Subject specifications</label>
                                    <textarea 
                                        id="subject-specifications" 
                                        placeholder="Express your subject in plain text" 
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-base h-40 resize-y"
                                    ></textarea>
                                </div>
                                <div class="space-y-2">
                                    <label for="reasoning-steps" class="block text-sm font-medium text-gray-700">Reasoning Steps</label>
                                    <select id="reasoning-steps" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm rounded-md">
                                        <option value="default">Default</option>
                                        <option value="chain of thoughts">Chain of thoughts</option>
                                        <option value="tree of thought">Tree of thoughts</option>
                                        <option value="8-stage process">8-Stage Process</option>
                                        <option value="10-steps reasoning">10-step reasoning</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label for="document-upload" class="block text-sm font-medium text-gray-700">Upload Document (optional)</label>
                                    <input type="file" id="document-upload" accept=".txt,.py,.html,.css,.c,.cpp,.java,.md,.js,.csv,.docx" class="mt-1 block w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-full file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-purple-50 file:text-purple-700
                                        hover:file:bg-purple-100">
                                </div>
                                <div class="pt-4">
                                    <button id="generate-ideas" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                        Generate Ideas
                                    </button>
                                </div>
                                <div id="idea-display-section" class="mt-12 hidden">
                                    <div class="flex justify-between items-center mb-6">
                                        <h2 class="text-2xl font-semibold text-gray-900">Generated Ideas</h2>
                                        <button id="back-to-projects" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                            Back to Projects
                                        </button>
                                    </div>
                                    <div id="idea-list" class="space-y-6"></div>
                                </div>
                    
                                <div id="loading-animation" class="hidden mt-8 flex justify-center">
                                    <svg class="animate-spin h-10 w-10 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </section>
                        </div>
                    </div>
                </section>
                <section id="help-section" class="mb-8 hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-600 dark:text-purple-400">Help & Getting Started</h2>
                    <div class="space-y-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <div class="border-l-4 border-purple-500 pl-4">
                            <h3 class="text-2xl font-semibold mb-2 text-gray-800 dark:text-gray-200">Welcome to LOLLMS Idea Forge</h3>
                            <p class="text-gray-600 dark:text-gray-400">This powerful tool helps you generate creative ideas for various purposes. Let's get you started!</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-gray-800 dark:text-gray-200">How to Use</h3>
                            <ol class="list-decimal list-inside space-y-2 text-gray-700 dark:text-gray-200">
                                <li>Create a new project or select an existing one from the Projects section.</li>
                                <li>In the Idea Generation section, specify the number of ideas, category, and tags.</li>
                                <li>Choose a reasoning process for idea generation.</li>
                                <li>Click "Generate Ideas" to create new ideas based on your inputs.</li>
                                <li>View and manage your generated ideas in the project.</li>
                            </ol>
                        </div>
                        <div class="bg-purple-100 dark:bg-purple-900 p-4 rounded-lg">
                            <h3 class="text-xl font-semibold mb-3 text-purple-800 dark:text-purple-200">Pro Tips</h3>
                            <ul class="list-disc list-inside space-y-2 text-purple-700 dark:text-purple-300">
                                <li>Use specific tags to guide the idea generation process.</li>
                                <li>Experiment with different reasoning steps for varied results.</li>
                                <li>Save your favorite ideas within projects for future reference.</li>
                                <li>Regularly review and refine your ideas to spark new innovations.</li>
                            </ul>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="close-help" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                                Got it, let's create!
                            </button>
                        </div>
                        <div class="mt-6 text-sm text-gray-600 dark:text-gray-300 italic">
                            <p>This tool was created by ParisNeo from idea suggestions given by a lollms fan called <strong class="dark:text-white">Truman Show Participant</strong>. Special thanks for given those ideas.</p>
                        </div>
                    </div>
                </section>
            </main>
    
            <footer class="fixed bottom-0 left-0 right-0 text-center py-4 bg-gray-100 dark:bg-gray-800">
                <p>&copy; 2024 LOLLMS Idea Forge</p>
            </footer>
        </div>
    

    <script>
        // Markdown renderer
        const mr = new MarkdownRenderer()

        // Initialize LOLLMS client and settings
        let contextSize = parseInt(localStorage.getItem('contextSize')) || 128000;
        let maxGenSize = parseInt(localStorage.getItem('maxGenSize')) || 4096;
        let lollmsHostAddress = localStorage.getItem('lollmsHostAddress') || "http://localhost:9600";
        let currentProjectId = parseInt(localStorage.getItem('lollms-ideas-forge-currentProjectId'));

        console.log("contextSize:",contextSize)
        console.log("maxGenSize:",maxGenSize)
        let lc = new LollmsClient(
            lollmsHostAddress, null, contextSize, -1, maxGenSize, 0.1, 50, 0.95, 0.8, 40, null, 8, "", ELF_GENERATION_FORMAT.LOLLMS
        );
        console.log("lc.n_predict", lc.n_predict)
        let tl = new TasksLibrary(lc);

        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;

        function setTheme(isDark) {
            if (isDark) {
                console.log("Going to dark mode")
                htmlElement.classList.add('dark');
            } else {
                console.log("Going to light mode")
                htmlElement.classList.remove('dark');
            }
            localStorage.setItem('darkMode', isDark);
        }

        themeToggle.addEventListener('click', () => {
            const isDark = !htmlElement.classList.contains('dark');
            setTheme(isDark);
        });

        // Initialize theme
        const savedTheme = localStorage.getItem('darkMode');
        if (savedTheme !== null) {
            setTheme(JSON.parse(savedTheme));
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme(true);
        }
    
        // Navigation
        const projectsBtn = document.getElementById('projects-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const projectsSection = document.getElementById('projects-section');
        const settingsSection = document.getElementById('settings-section');
        const ideaGeneration = document.getElementById('idea-generation');
        const backToProjectsBtn = document.getElementById('back-to-projects');

        projectsBtn.addEventListener('click', () => {
            projectsSection.classList.remove('hidden');
            settingsSection.classList.add('hidden');
            ideaGeneration.classList.add('hidden');
            loadProjects();
        });

        settingsBtn.addEventListener('click', () => {
            projectsSection.classList.add('hidden');
            settingsSection.classList.remove('hidden');
            ideaGeneration.classList.add('hidden');
        });

        backToProjectsBtn.addEventListener('click', () => {
            ideaGeneration.classList.add('hidden');
            projectsSection.classList.remove('hidden');
            backToProjectsBtn.classList.add('hidden');
            document.title = 'LOLLMS Idea Forge';

            // Animate the transition
            anime({
                targets: '#projects-section',
                opacity: [0, 1],
                translateY: [20, 0],
                easing: 'easeOutExpo',
                duration: 800
            });

            // Refresh the projects list
            loadProjects();
        });

        // Settings
        const contextSizeInput = document.getElementById('context-size');
        const maxGenSizeInput = document.getElementById('max-gen-size');
        const lollmsHostInput = document.getElementById('lollms-host');
        const saveSettingsBtn = document.getElementById('save-settings');

        contextSizeInput.value = contextSize;
        maxGenSizeInput.value = maxGenSize;
        lollmsHostInput.value = lollmsHostAddress;

        saveSettingsBtn.addEventListener('click', () => {
            contextSize = parseInt(contextSizeInput.value);
            maxGenSize = parseInt(maxGenSizeInput.value);
            lollmsHostAddress = lollmsHostInput.value;

            localStorage.setItem('contextSize', contextSize);
            localStorage.setItem('maxGenSize', maxGenSize);
            localStorage.setItem('lollmsHostAddress', lollmsHostAddress);

            lc = new LollmsClient(
                lollmsHostAddress, null, contextSize, -1, maxGenSize, 0.1, 50, 0.95, 0.8, 40, null, 8, "", ELF_GENERATION_FORMAT.LOLLMS
            );

            alert('Settings saved successfully!');
        });

        // Projects
        const projectsList = document.getElementById('projects-list');
        const newProjectBtn = document.getElementById('new-project-btn');

        function loadProjects() {
            const projects = JSON.parse(localStorage.getItem('lollms_ideas_forge_projects')) || [];
            projectsList.innerHTML = '';
            projects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg shadow fade-in';
                projectCard.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2">${project.name}</h3>
                    <p class="mb-2">${project.description}</p>
                    <div class="flex justify-between">
                        <button class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 open-project" data-id="${project.id}">Open</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 delete-project" data-id="${project.id}">Delete</button>
                    </div>
                `;
                projectsList.appendChild(projectCard);
                setTimeout(() => projectCard.classList.add('show'), 10);
            });
        }

        newProjectBtn.addEventListener('click', () => {
            const name = prompt('Enter project name:');
            if (name) {
                const description = prompt('Enter project description:');
                const projects = JSON.parse(localStorage.getItem('lollms_ideas_forge_projects')) || [];
                const newProject = {
                    id: Date.now(),
                    name,
                    description,
                    sessions: []
                };
                projects.push(newProject);
                localStorage.setItem('lollms_ideas_forge_projects', JSON.stringify(projects));
                loadProjects();
            }
        });

        projectsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('open-project')) {
                const projectId = parseInt(e.target.getAttribute('data-id'));
                console.log("Lioading project: ",projectId)
                currentProjectId = projectId
                localStorage.setItem('lollms-ideas-forge-currentProjectId', currentProjectId);
                await openProject(projectId);
            } else if (e.target.classList.contains('delete-project')) {
                const projectId = parseInt(e.target.getAttribute('data-id'));
                deleteProject(projectId);
            }
        });

        async function openProject(projectId) {
            const projects = JSON.parse(localStorage.getItem('lollms_ideas_forge_projects')) || [];
            const project = projects.find(p => p.id === projectId);
            if (project) {
                const projectsSection = document.getElementById('projects-section');
                const ideaGeneration = document.getElementById('idea-generation');
                const backBtn = document.getElementById('back-to-projects');

                if (projectsSection) projectsSection.classList.add('hidden');
                if (ideaGeneration) ideaGeneration.classList.remove('hidden');
                if (backBtn) backBtn.classList.remove('hidden');

                const ideaDisplaySection = document.getElementById('idea-display-section');
                if (ideaDisplaySection) {
                    ideaDisplaySection.innerHTML = '';

                    const projectNameElement = document.createElement('h2');
                    projectNameElement.className = 'text-2xl font-semibold mb-2 text-gray-900';
                    projectNameElement.textContent = project.name;

                    const projectDescriptionElement = document.createElement('p');
                    projectDescriptionElement.className = 'text-gray-600 mb-4';
                    projectDescriptionElement.textContent = project.description;

                    ideaDisplaySection.appendChild(projectNameElement);
                    ideaDisplaySection.appendChild(projectDescriptionElement);

                    if (project.sessions && project.sessions.length > 0) {
                        const { tabContainer, contentContainer } = await createSessionTabs(project);
                        ideaDisplaySection.appendChild(tabContainer);
                        ideaDisplaySection.appendChild(contentContainer);
                        ideaDisplaySection.classList.remove('hidden');
                    }

                    const newSessionBtn = document.createElement('button');
                    newSessionBtn.textContent = 'New Session';
                    newSessionBtn.className = 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4';
                    newSessionBtn.addEventListener('click', () => {
                        const numIdeasInput = document.getElementById('num-ideas');
                        const ideaCategoryInput = document.getElementById('idea-category');
                        const subjectSpecificationsTextArea = document.getElementById('subject-specifications');
                        const reasoningStepsInput = document.getElementById('reasoning-steps');

                        if (numIdeasInput) numIdeasInput.value = '';
                        if (ideaCategoryInput) ideaCategoryInput.value = 'brainstorming';
                        if (subjectSpecificationsTextArea) subjectSpecificationsTextArea.value = '';
                        if (reasoningStepsInput) reasoningStepsInput.value = 'default';
                        
                        generateIdeas();
                    });
                    ideaDisplaySection.appendChild(newSessionBtn);
                }

                document.title = `${project.name} - LOLLMS Idea Forge`;

                if (ideaGeneration) {
                    anime({
                        targets: '#idea-generation',
                        opacity: [0, 1],
                        translateY: [20, 0],
                        easing: 'easeOutExpo',
                        duration: 800
                    });
                }
            }
        }

        async function createSessionTabs(project) {
            const tabContainer = document.createElement('div');
            tabContainer.className = 'flex mb-4 border-b';
            
            const contentContainer = document.createElement('div');
            contentContainer.className = 'mt-4';

            const tabs = [];
            const contents = [];

            for (let index = 0; index < project.sessions.length; index++) {
                const session = project.sessions[index];
                
                const tab = document.createElement('button');
                tab.className = 'px-4 py-2 text-sm font-medium text-center text-gray-700 bg-gray-100 rounded-t-lg hover:bg-gray-200 focus:outline-none';
                tab.textContent = `Session ${index + 1}`;
                tab.onclick = () => switchTab(index);
                
                // Create remove button
                const removeButton = document.createElement('button');
                removeButton.className = 'ml-2 text-red-500 hover:text-red-700';
                removeButton.innerHTML = 'x';
                removeButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent tab click event
                    removeSession(index);
                };

                tab.appendChild(removeButton);
                tabContainer.appendChild(tab);
                tabs.push(tab);

                const content = document.createElement('div');
                content.className = 'hidden session-content';
                const rendered = await mr.renderMarkdown(session.ideas);
                
                const editButton = `
                    <button class="edit-btn bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                    </button>
                `;
                const numIdeasInput = document.getElementById('num-ideas');
                const ideaCategoryInput = document.getElementById('idea-category');
                const subjectSpecificationsTextArea = document.getElementById('subject-specifications');
                const reasoningStepsInput = document.getElementById('reasoning-steps');
                numIdeasInput.value = session.numIdeas;
                ideaCategoryInput.value = session.category;
                subjectSpecificationsTextArea.value = session.tags;
                reasoningStepsInput.value = session.reasoningSteps;
                content.innerHTML = `
                    <div class="mb-4 relative">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Ideas</label>
                            ${editButton}
                        </div>
                        <div class="rendered-markdown">${rendered}</div>
                        <textarea class="hidden mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50 h-64" data-field="ideas">${session.ideas}</textarea>
                    </div>
                    <div class="flex justify-between">
                        <button class="update-session-btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-session-id="${index}">Update Session</button>
                        <button class="export-btn bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" data-session-id="${index}">Export</button>
                    </div>
                `;
                contentContainer.appendChild(content);
                contents.push(content);

                const editBtn = content.querySelector('.edit-btn');
                const renderedMarkdown = content.querySelector('.rendered-markdown');
                const textarea = content.querySelector('textarea[data-field="ideas"]');
                
                editBtn.addEventListener('click', () => {
                    if (renderedMarkdown.style.display !== 'none') {
                        renderedMarkdown.style.display = 'none';
                        textarea.style.display = 'block';
                        editBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        `;
                    } else {
                        renderedMarkdown.style.display = 'block';
                        textarea.style.display = 'none';
                        editBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        `;
                        updateRenderedMarkdown(textarea, renderedMarkdown);
                    }
                });
            }

            function switchTab(selectedIndex) {
                tabs.forEach((tab, index) => {
                    if (index === selectedIndex) {
                        tab.classList.add('bg-purple-500', 'text-white');
                        tab.classList.remove('bg-gray-100', 'text-gray-700');
                    } else {
                        tab.classList.remove('bg-purple-500', 'text-white');
                        tab.classList.add('bg-gray-100', 'text-gray-700');
                    }
                });
                contents.forEach((content, index) => {
                    content.classList.toggle('hidden', index !== selectedIndex);
                });
            }

            async function removeSession(index) {
                // Remove session from the project
                project.sessions.splice(index, 1);
                
                // Update the UI
                tabContainer.removeChild(tabs[index]);
                contentContainer.removeChild(contents[index]);
                tabs.splice(index, 1);
                contents.splice(index, 1);

                // Re-render tabs and contents
                for (let i = 0; i < tabs.length; i++) {
                    tabs[i].textContent = `Session ${i + 1}`;
                    tabs[i].querySelector('.remove-btn').onclick = () => removeSession(i);
                }

                // Activate the first tab if there are any sessions left
                if (tabs.length > 0) {
                    switchTab(0);
                }
            }

            // Activate the first tab by default
            if (project.sessions.length > 0) {
                switchTab(0);
            }

            async function updateRenderedMarkdown(textarea, renderedElement) {
                const newRendered = await mr.renderMarkdown(textarea.value);
                renderedElement.innerHTML = newRendered;
            }

            return { tabContainer, contentContainer };
        }


        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('update-session-btn')) {
                const sessionId = parseInt(e.target.getAttribute('data-session-id'));
                const sessionContent = e.target.closest('.session-content');
                const updatedSession = {
                    numIdeas: sessionContent.querySelector('[data-field="numIdeas"]').value,
                    category: sessionContent.querySelector('[data-field="category"]').value,
                    tags: sessionContent.querySelector('[data-field="tags"]').value,
                    reasoningSteps: sessionContent.querySelector('[data-field="reasoningSteps"]').value,
                    ideas: sessionContent.querySelector('[data-field="ideas"]').value
                };

                const projects = JSON.parse(localStorage.getItem('lollms_ideas_forge_projects')) || [];
                const projectIndex = projects.findIndex(p => p.id === currentProjectId);
                if (projectIndex !== -1) {
                    projects[projectIndex].sessions[sessionId] = updatedSession;
                    localStorage.setItem('lollms_ideas_forge_projects', JSON.stringify(projects));
                    alert('Session updated successfully');
                }
            }
        });
        function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                const projects = JSON.parse(localStorage.getItem('lollms_ideas_forge_projects')) || [];
                const updatedProjects = projects.filter(p => p.id !== projectId);
                localStorage.setItem('lollms_ideas_forge_projects', JSON.stringify(updatedProjects));
                loadProjects();
            }
        }

        // Load projects on page load
        loadProjects();

        // Idea Generation
        const generateIdeasBtn = document.getElementById('generate-ideas');
        const loadingAnimation = document.getElementById('loading-animation');
        const ideaDisplaySection = document.getElementById('idea-display-section');
        const ideaList = document.getElementById('idea-list');
        function isValidTextFileExtension(fileName) {
            const validExtensions = ['.txt', '.py', '.html', '.css', '.c', '.cpp', '.java', '.md', '.js', '.csv'];
            return validExtensions.includes(fileName.slice(-4).toLowerCase());
        }
        async function generateIdeas() {
            const numIdeas = document.getElementById('num-ideas').value;
            const category = document.getElementById('idea-category').value;
            const tags = document.getElementById('subject-specifications').value;
            const reasoningSteps = document.getElementById('reasoning-steps').value;
            const fileInput = document.getElementById('document-upload');
            
            let additionalContext = '';

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (isValidTextFileExtension(file.name)) {
                    additionalContext = await readTextFile(file);
                } else if (file.name.endsWith('.docx')) {
                    additionalContext = await readDocxFile(file);
                }
            }

            const system_prompt = `Generate ${numIdeas} creative ideas for ${category}. 
                Use the following tags: ${tags}. 
                Apply the ${reasoningSteps} reasoning process.
                Format your response using Markdown, including code blocks and mathematical equations where appropriate.
                
                Additional context from uploaded document:
                ${additionalContext}
                
                For each idea:
                1. Provide a formal introduction and problem statement.
                2. Detail your reasoning process, breaking it down into clear, logical steps.
                3. Present your solution, including any relevant code snippets or mathematical formulas.
                4. If applicable, include a Mermaid diagram to visually represent the idea or process.
                5. Conclude with a summary of the idea's potential impact and implementation considerations.

                Mermaid diagram syntax:
                \`\`\`mermaid
                // Your diagram code here
                \`\`\`

                Ensure your response is thorough, well-structured, and academically rigorous.`;
            
            console.log("system_prompt")
            console.log(system_prompt)
            const prompt = lc.system_message() + system_prompt + lc.template.separator_template + lc.ai_message();

            try {
                const loadingAnimation = document.getElementById('loading-animation');
                const ideaDisplaySection = document.getElementById('idea-display-section');

                if (loadingAnimation) loadingAnimation.classList.remove('hidden');
                if (ideaDisplaySection) ideaDisplaySection.classList.add('hidden');

                const generated_text = await lc.generate(prompt);

                if (typeof generated_text !== 'string') {
                    throw new Error('Generated text is not a string');
                }

                // Save generated ideas to the current project
                const projects = JSON.parse(localStorage.getItem('lollms_ideas_forge_projects')) || [];
                const projectIndex = projects.findIndex(p => p.id === currentProjectId);
                if (projectIndex !== -1) {
                    const newSession = {
                        ideas: generated_text,
                        numIdeas,
                        category,
                        tags,
                        reasoningSteps,
                        additionalContext
                    };
                    if (!projects[projectIndex].sessions) {
                        projects[projectIndex].sessions = [];
                    }
                    projects[projectIndex].sessions.push(newSession);
                    localStorage.setItem('lollms_ideas_forge_projects', JSON.stringify(projects));
                    console.log("Session saved successfully");
                    
                    // Refresh the displayed sessions
                    await openProject(currentProjectId);
                }

                if (loadingAnimation) loadingAnimation.classList.add('hidden');
                if (ideaDisplaySection) ideaDisplaySection.classList.remove('hidden');

            } catch (error) {
                console.error('Error generating ideas:', error);
                alert('An error occurred while generating ideas. Please try again.');
                if (document.getElementById('loading-animation')) {
                    document.getElementById('loading-animation').classList.add('hidden');
                }
            }
        }

        async function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        async function readDocxFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        resolve(result.value);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        generateIdeasBtn.addEventListener('click', generateIdeas);

        async function exportSession(sessionId, format) {
            const projects = JSON.parse(localStorage.getItem('lollms_ideas_forge_projects')) || [];
            const project = projects.find(p => p.id === currentProjectId);
            const session = project.sessions[sessionId];

            let content = '';
            let filename = '';
            let mimeType = '';

            switch (format) {
                case 'docx':
                    // For simplicity, we'll use a third-party library for DOCX conversion
                    // You'll need to add a DOCX conversion library to your project
                    alert('DOCX export not implemented in this example. Please implement using a DOCX library.');
                    return;
                case 'txt':
                case 'md':
                case 'csv':
                case 'html':
                    content = session.ideas;
                    filename = `session_${sessionId + 1}.${format}`;
                    mimeType = format === 'txt' ? 'text/plain' :
                            format === 'md' ? 'text/markdown' :
                            format === 'csv' ? 'text/csv' :
                            'text/html'; // Default to HTML for other cases
                    break;
                case 'py':
                    content = session.ideas;
                    filename = `session_${sessionId + 1}.py`;
                    mimeType = 'text/x-python';
                    break;
                case 'css':
                    content = session.ideas;
                    filename = `session_${sessionId + 1}.css`;
                    mimeType = 'text/css';
                    break;
                case 'c':
                    content = session.ideas;
                    filename = `session_${sessionId + 1}.c`;
                    mimeType = 'text/x-c';
                    break;
                case 'cpp':
                    content = session.ideas;
                    filename = `session_${sessionId + 1}.cpp`;
                    mimeType = 'text/x-c++';
                    break;
                case 'java':
                    content = session.ideas;
                    filename = `session_${sessionId + 1}.java`;
                    mimeType = 'text/x-java';
                    break;
                case 'js':
                    content = session.ideas;
                    filename = `session_${sessionId + 1}.js`;
                    mimeType = 'application/javascript';
                    break;
                default:
                    alert('Unsupported format');
                    return;
            }
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('export-btn')) {
                const sessionId = parseInt(e.target.getAttribute('data-session-id'));
                const format = prompt('Choose export format (docx, txt, or md):');
                if (['docx', 'txt', 'md'].includes(format)) {
                    await exportSession(sessionId, format);
                } else {
                    alert('Invalid format selected');
                }
            }
        });
        // Animation for page elements
        function animatePageLoad() {
            anime({
                targets: 'header, main > section',
                opacity: [0, 1],
                translateY: [20, 0],
                easing: 'easeOutExpo',
                duration: 1000,
                delay: anime.stagger(200)
            });
        }

        // Call animation function when the page loads
        window.addEventListener('load', animatePageLoad);

        // Smooth scrolling for internal links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // Initialize tooltips
        const tooltips = document.querySelectorAll('[data-tooltip]');
        tooltips.forEach(tooltip => {
            tooltip.addEventListener('mouseenter', () => {
                const tooltipText = tooltip.getAttribute('data-tooltip');
                const tooltipEl = document.createElement('div');
                tooltipEl.className = 'bg-gray-800 text-white p-2 rounded absolute z-10 text-sm';
                tooltipEl.textContent = tooltipText;
                tooltip.appendChild(tooltipEl);
            });
            tooltip.addEventListener('mouseleave', () => {
                const tooltipEl = tooltip.querySelector('div');
                if (tooltipEl) tooltipEl.remove();
            });
        });

        // Add responsive menu for mobile devices
        const menuToggle = document.createElement('button');
        menuToggle.innerHTML = '&#9776;'; // Hamburger icon
        menuToggle.className = 'md:hidden p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700';
        const nav = document.querySelector('nav');
        nav.parentNode.insertBefore(menuToggle, nav);

        menuToggle.addEventListener('click', () => {
            nav.classList.toggle('hidden');
        });

        // Make sure the menu is visible on larger screens
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // md breakpoint
                nav.classList.remove('hidden');
            }
        });

        // Add a back button for project view
        const backBtn = document.createElement('button');
        backBtn.textContent = 'Back to Projects';
        backBtn.className = 'bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mb-4 hidden';
        ideaGeneration.insertBefore(backBtn, ideaGeneration.firstChild);

        backBtn.addEventListener('click', () => {
            ideaGeneration.classList.add('hidden');
            projectsSection.classList.remove('hidden');
            backBtn.classList.add('hidden');
            document.title = 'LOLLMS Idea Forge';

            // Animate the transition
            anime({
                targets: '#projects-section',
                opacity: [0, 1],
                translateY: [20, 0],
                easing: 'easeOutExpo',
                duration: 800
            });

            // Refresh the projects list
            loadProjects();
        });

        const helpBtn = document.getElementById('help-btn');
        const helpSection = document.getElementById('help-section');

        helpBtn.addEventListener('click', () => {
            projectsSection.classList.add('hidden');
            settingsSection.classList.add('hidden');
            ideaGeneration.classList.add('hidden');
            helpSection.classList.remove('hidden');
        });

        document.getElementById('close-help').addEventListener('click', () => {
            helpSection.classList.add('hidden');
            projectsSection.classList.remove('hidden');
        });

        // Show projects section by default
        window.addEventListener('DOMContentLoaded', (event) => {
            projectsSection.classList.remove('hidden');
            settingsSection.classList.add('hidden');
            ideaGeneration.classList.add('hidden');
            loadProjects(); // Ensure projects are loaded
            mr.initMermaid()
        });
    </script>
</body>
</html>
