<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Life Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/lollms_assets/js/lollms_client_js"></script>
    <script src="/lollms_assets/js/axios.min"></script>
</head>
<style>
        .scrollable-container {
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
</style>
<body class="bg-gradient-to-r from-green-100 to-blue-100 font-sans min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-green-800 mb-8 text-center">Village Life Simulator</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="bg-white shadow-lg rounded-lg p-6 col-span-2">
                <h2 class="text-2xl font-semibold mb-4 text-green-700">Village Map</h2>
                <div id="villageMap" class="h-96 bg-green-200 rounded-lg relative"></div>
                <div id="loadingOverlay" class="hidden bg-gray-100 border border-gray-300 rounded-lg p-4 mt-4 w-full">
                    <div class="flex items-center mb-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-t-4 border-green-500 border-solid mr-3"></div>
                        <h3 class="text-lg font-semibold text-gray-700">Processing...</h3>
                    </div>
                    <div class="bg-gray-900 p-3 rounded">
                        <pre id="consoleOutput" class="text-green-500 font-mono text-sm overflow-y-auto max-h-40 whitespace-pre-wrap break-words"></pre>
                    </div>
                    <button id="pauseBtn" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                        Pause
                    </button>
                </div>
                
            </div>
            
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-700">Controls</h2>
                <div class="flex flex-col space-y-4">
                    <div class="flex flex-col space-y-2">
                        <label for="numPlaces" class="text-sm font-medium text-gray-700">Number of Places:</label>
                        <input type="number" id="numPlaces" min="1" max="20" value="10" class="border border-gray-300 rounded-md p-2">
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label for="numPersonas" class="text-sm font-medium text-gray-700">Number of Personas:</label>
                        <input type="number" id="numPersonas" min="1" max="20" value="5" class="border border-gray-300 rounded-md p-2">
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label for="villageContext" class="text-sm font-medium text-gray-700">Village Context:</label>
                        <textarea id="villageContext" rows="3" class="border border-gray-300 rounded-md p-2" placeholder="Describe the village style, era, etc."></textarea>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label for="maxSteps" class="text-sm font-medium text-gray-700">Maximum Simulation Steps:</label>
                        <input type="number" id="maxSteps" min="1" max="1000" value="100" class="border border-gray-300 rounded-md p-2">
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="buildImages" class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out">
                        <label for="buildImages" class="ml-2 text-sm font-medium text-gray-700">Build images (Coming up soon)</label>
                    </div>                    
                    <button id="buildVillageBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                        Build Village
                    </button>
                    <button id="startPauseBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                        Start Simulation
                    </button>
                    <div class="flex items-center">
                        <label for="speedControl" class="mr-2">Speed:</label>
                        <input type="range" id="speedControl" min="1" max="4" value="1" class="w-full">
                    </div>
                    <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                        Export State
                    </button>
                    <button id="importBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                        Import State
                    </button>
                    <button id="buildStoryBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                        Build story
                    </button>                    
                </div>
            </div>
        </div>
        
        <div class="mt-8 bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-2xl font-semibold mb-4 text-green-700">Character Information</h2>
            <div id="characterInfo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
        
        <div class="mt-8 bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-2xl font-semibold mb-4 text-green-700">Event Log</h2>
            <div id="eventLog" class="space-y-2">
            </div>
        </div>
    </div>
    <script>
        const lc = new LollmsClient();
        let simulationRunning = false;
        let villagers = [];
        let locations = [];
        let events = [];
        let stepMode = false;
        let maxSimulationSteps = 100;
        let currentStep = 0;
        
        function appendToConsole(text) {
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.textContent += (consoleOutput.textContent ? '\n' : '') + text;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Add this function to save parameters to localStorage
        function saveParameters() {
            const params = {
                numPlaces: document.getElementById('numPlaces').value,
                numPersonas: document.getElementById('numPersonas').value,
                villageContext: document.getElementById('villageContext').value,
                maxSteps: document.getElementById('maxSteps').value,
                speed: document.getElementById('speedControl').value
            };
            localStorage.setItem('villageSimulatorParams', JSON.stringify(params));
        }

        // Add this function to load parameters from localStorage
        function loadParameters() {
            const savedParams = localStorage.getItem('villageSimulatorParams');
            if (savedParams) {
                const params = JSON.parse(savedParams);
                document.getElementById('numPlaces').value = params.numPlaces;
                document.getElementById('numPersonas').value = params.numPersonas;
                document.getElementById('villageContext').value = params.villageContext;
                document.getElementById('maxSteps').value = params.maxSteps;
                document.getElementById('speedControl').value = params.speed;
            }
            const buildStoryButton = document.getElementById('buildStoryBtn');
    
            if (buildStoryButton) {
                buildStoryButton.addEventListener('click', buildStoryBtn);
            }
        }        
        async function buildStoryBtn() {
            showLoader("Generating story...");
            appendToConsole("Generating story...")
            const villageContext = document.getElementById('villageContext').value || 'A small medieval village';

            // Construct a detailed prompt using the available data
            const prompt = `Generate a captivating story based on the following village information:
Context:
${villageContext}

Locations:
${JSON.stringify(locations, null, 2)}

Villagers:
${JSON.stringify(villagers, null, 2)}

Events:
${JSON.stringify(events, null, 2)}

Using the provided information, create a rich and engaging narrative that incorporates the locations, villagers, and events. The story should have a clear beginning, middle, and end, with interesting character interactions and plot developments. Make sure to weave the events into the story naturally, and use the locations as vivid backdrops for the unfolding tale.`;

    // Use lc.generate to create the story
    const story = await lc.generate(prompt);

    // Format the story as a Markdown document
    const storyMd = `# Village Story

${story}`;

            // Create a Blob with the Markdown content
            const blob = new Blob([storyMd], { type: "text/markdown;charset=utf-8" });

            // Create a temporary URL for the Blob
            const url = URL.createObjectURL(blob);

            // Create a temporary anchor element and trigger the download
            const a = document.createElement("a");
            a.href = url;
            a.download = "village_story.md";
            document.body.appendChild(a);
            a.click();

            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log("Story exported as village_story.md");
            hideLoader();
        }

        // Modify the generateVillager function to include relationships
        async function generateVillager(villageContext, existingVillagers, locations) {
            appendToConsole('Generating villager ...');
            const prompt = `${lc.system_message()}Generate a JSON object for a villager in our simulation. The village context is: 
${villageContext}

Include fields for name, age, occupation, personality traits, current status (location, activity, mood), and a brief backstory. The villager should have unique and interesting characteristics. Ensure the name is not one of the following: ${JSON.stringify(existingVillagers, null, 2)}.

Example format:
\`\`\`json
{
    "name": "Elara Moonwhisper",
    "gender": "female",
    "age": 28,
    "occupation": "Herbalist",
    "personalityTraits": ["curious", "empathetic", "night owl"],
    "currentStatus": {
        "location": "Moonlit Grove",
        "activity": "Gathering herbs",
        "mood": "Focused"
    },
    "backstory": "Elara grew up in a family of healers and discovered her affinity for plants at a young age. She often explores the village outskirts at night, believing the moonlight enhances the potency of her herbs."
}
\`\`\`
${lc.user_message()}Please generate a unique villager for our simulation, different from:
\`\`\`json
${JSON.stringify(existingVillagers, null, 2)}
\`\`\`
The village locations are:
\`\`\`json
${JSON.stringify(locations, null, 2)}
\`\`\`

${lc.ai_message()}`;
            console.log(prompt)
  
            showLoader("Generating villager...");
            console.log(prompt)
            const villagerJson = await lc.generateCode(prompt);
            hideLoader();
        
            if (villagerJson) {
                const villager = JSON.parse(villagerJson);
                villager.relationships = {};
                
                // Initialize relationships with existing villagers
                existingVillagers.forEach(otherVillager => {
                    villager.relationships[otherVillager.name] = {
                        affinity: Math.floor(Math.random() * 100),
                        interactions: 0
                    };
                    // Also add this new villager to the other villager's relationships
                    otherVillager.relationships[villager.name] = {
                        affinity: Math.floor(Math.random() * 100),
                        interactions: 0
                    };
                });
                appendToConsole(`Added ${villager.name}`);
                return villager;
            }
            return null;
        }
        
        async function generateLocation(villageContext, existingLocations, retryCount = 0) {
            appendToConsole('Generating location ...');
            const existingLocationNames = existingLocations.map(l => l.name).join(", ");
            const prompt = `${lc.system_message()}Generate a JSON object for a location in our village simulation. The village context is: ${villageContext}. Include fields for name, type (e.g., house, shop, public space), capacity, and a brief description. The location should be unique and fitting for the village setting. 

IMPORTANT: Ensure the name is not one of the following existing locations: ${existingLocationNames}. Do not repeat any of these names or create very similar names.

Example format:
\`\`\`json
{
    "name": "Whispering Willow Inn",
    "type": "Tavern",
    "capacity": 30,
    "description": "A cozy tavern built around an ancient willow tree. Its branches extend through the roof, creating a magical atmosphere. Known for its unique herbal brews and storytelling nights."
}
\`\`\`        
${lc.user_message()}Please generate a unique location for our village simulation. Remember, it must be different from these existing locations: ${existingLocationNames}.${lc.ai_message()}`;

            showLoader("Generating location...");
            const locationJson = await lc.generateCode(prompt);
            hideLoader();

            if (locationJson) {
                const newLocation = JSON.parse(locationJson);
                // Double-check that the new location name is unique
                if (existingLocations.some(loc => loc.name === newLocation.name)) {
                    if (retryCount === 0) {
                        console.warn("Generated location name already exists. Retrying once...");
                        return generateLocation(villageContext, existingLocations, 1);
                    } else {
                        console.error("Failed to generate a unique location name after retry.");
                        return null;
                    }
                }
                appendToConsole(`Added ${newLocation.name}`);
                return newLocation;
            }
            return null;
        }

        
        async function updateVillagerStatus(villager) {
            const villageContext = document.getElementById('villageContext').value || 'A small medieval village';
            const prompt = `${lc.system_message()}Given the current state of a villager and the context, generate a JSON object representing their updated status. Include fields for current location, activity, mood, and any new memories or thoughts based on their recent experiences. Consider their personality and backstory when updating their status.
Here is the general village context:
${JSON.stringify(villageContext, null, 2)}

All villagers information:
${JSON.stringify(villagers, null, 2)}

Example format:
\`\`\`json
{
    "currentStatus": {
        "location": "Whispering Willow Inn",
        "activity": "Sharing herbal tea recipes",
        "mood": "Excited"
    },
    "newMemories": ["Made a new friend who's interested in herbology", "Learned about a rare plant growing near the village"],
    "thoughts": "I wonder if I could organize a weekly herbalism workshop at the inn..."
}
\`\`\`

${lc.user_message()}Current villager state: ${JSON.stringify(villager)}. Please update the villager status.${lc.ai_message()}`;
            console.log(prompt);
            showLoader("Updating villager status...");
            const updatedStatusJson = await lc.generateCode(prompt);
            hideLoader();
        
            if (updatedStatusJson) {
                const updatedStatus = JSON.parse(updatedStatusJson);
                return { ...villager, ...updatedStatus };
            }
            return villager;
        }
        
        // Add this to the villager generation function
        function generateRelationships(villager, otherVillagers) {
            villager.relationships = {};
            otherVillagers.forEach(other => {
                if (other.name !== villager.name) {
                    villager.relationships[other.name] = {
                        affinity: Math.floor(Math.random() * 100),
                        interactions: 0
                    };
                }
            });
        }

        async function generateGroupInteraction(villagers) {
            if (villagers.length < 2) {
                console.log("Not enough villagers for an interaction");
                return null;
            }

            // Select a random number of villagers (between 2 and the total number of villagers)
            const numParticipants = Math.floor(Math.random() * (villagers.length - 1)) + 2;
            const participants = shuffleArray(villagers).slice(0, numParticipants);

            // Calculate average affinity between all participants
            let totalAffinity = 0;
            let affinityCount = 0;
            for (let i = 0; i < participants.length; i++) {
                for (let j = i + 1; j < participants.length; j++) {
                    const villager1 = participants[i];
                    const villager2 = participants[j];
                    if (!villager1.relationships[villager2.name]) {
                        villager1.relationships[villager2.name] = { affinity: 50, interactions: 0 };
                    }
                    if (!villager2.relationships[villager1.name]) {
                        villager2.relationships[villager1.name] = { affinity: 50, interactions: 0 };
                    }
                    totalAffinity += villager1.relationships[villager2.name].affinity + villager2.relationships[villager1.name].affinity;
                    affinityCount += 2;
                }
            }
            const averageAffinity = totalAffinity / affinityCount;
            const villageContext = document.getElementById('villageContext').value || 'A small medieval village';

            const prompt = `${lc.system_message()}Generate a JSON object representing an interaction between ${numParticipants} villagers. Their average affinity is ${averageAffinity.toFixed(2)}/100. Include fields for the type of interaction, dialogue snippets, and any resulting changes in mood, affinity, or new memories for all villagers involved. Consider their personalities, occupations, current statuses, and affinities when creating the interaction.
The discussion should take into consideration the village context and villagers status.
Village context:
${JSON.stringify(villageContext, null, 2)}


Example format:
\`\`\`json
{
    "type": "Group discussion",
    "dialogue": [
        {"speaker": "Elara", "text": "I've discovered a new herb that might help with various ailments."},
        {"speaker": "Finn", "text": "That's fascinating! How does it work?"},
        {"speaker": "Zara", "text": "Could it help with the village's crop yield?"}
        ... the discussion can be as long as it is needed
    ],
    "outcomes": {
        "Elara": {
            "moodChange": "Enthusiastic",
            "affinityChanges": {"Finn": 5, "Zara": 3},
            "newMemories": ["Shared knowledge about herbs with the group", "Felt appreciated for her expertise"]
        },
        "Finn": {
            "moodChange": "Curious",
            "affinityChanges": {"Elara": 7, "Zara": 2},
            "newMemories": ["Learned about a new herb from Elara", "Enjoyed the group discussion"]
        },
        "Zara": {
            "moodChange": "Intrigued",
            "affinityChanges": {"Elara": 4, "Finn": 1},
            "newMemories": ["Considered potential agricultural applications of the new herb"]
        }
    }
}
\`\`\`
${lc.user_message()}Villagers: ${JSON.stringify(participants)}. Please generate an interaction between these villagers.${lc.ai_message()}`;

            showLoader("Generating group interaction...");
            const interactionJson = await lc.generateCode(prompt);
            hideLoader();

            if (interactionJson) {
                const interaction = JSON.parse(interactionJson);
                // Update relationships based on the interaction
                updateGroupRelationships(participants, interaction);
                return interaction;
            }
            return null;
        }

        function updateGroupRelationships(participants, interaction) {
            for (const villager of participants) {
                const outcome = interaction.outcomes[villager.name];
                if (outcome) {
                    if (outcome.moodChange) {
                        villager.mood = outcome.moodChange;
                    }
                    if (outcome.affinityChanges) {
                        for (const [otherVillagerName, affinityChange] of Object.entries(outcome.affinityChanges)) {
                            if (villager.relationships[otherVillagerName]) {
                                villager.relationships[otherVillagerName].affinity += affinityChange;
                                villager.relationships[otherVillagerName].affinity = Math.max(0, Math.min(100, villager.relationships[otherVillagerName].affinity));
                                villager.relationships[otherVillagerName].interactions++;
                            }
                        }
                    }
                    if (outcome.newMemories) {
                        villager.newMemories.push(...outcome.newMemories);
                    }
                }
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateRelationships(villager1, villager2, interaction) {
            const outcome1 = interaction.outcomes[villager1.name];
            const outcome2 = interaction.outcomes[villager2.name];
            
            if (outcome1 && outcome2) {
                villager1.relationships[villager2.name].affinity += outcome1.affinityChange || 0;
                villager1.relationships[villager2.name].interactions++;
                villager2.relationships[villager1.name].affinity += outcome2.affinityChange || 0;
                villager2.relationships[villager1.name].interactions++;

                // Ensure affinity stays within 0-100 range
                villager1.relationships[villager2.name].affinity = Math.max(0, Math.min(100, villager1.relationships[villager2.name].affinity));
                villager2.relationships[villager1.name].affinity = Math.max(0, Math.min(100, villager2.relationships[villager1.name].affinity));
            }
        }

        
        function updateVillageMap(simulationStep = null) {
            const villageMap = document.getElementById('villageMap');
            villageMap.innerHTML = '';

            locations.forEach((location, index) => {
                const locationElement = document.createElement('div');
                locationElement.className = 'absolute w-16 h-16 bg-yellow-200 rounded-lg flex items-center justify-center text-xs text-center cursor-pointer';
                locationElement.style.left = `${(index % 5) * 20}%`;
                locationElement.style.top = `${Math.floor(index / 5) * 25}%`;
                locationElement.textContent = location.name;
                locationElement.addEventListener('click', () => showLocationDetails(location));
                villageMap.appendChild(locationElement);
            });

            villagers.forEach((villager, index) => {
                const villagerElement = document.createElement('div');
                villagerElement.className = 'absolute w-8 h-8 rounded-full flex items-center justify-center text-xs text-white cursor-pointer';
                
                // Colorization based on age and gender
                const agePercent = villager.age / 100; // Assuming max age is 100
                let color;
                if (villager.gender === 'male') {
                    color = `rgb(${Math.round(135 + 120 * agePercent)}, ${Math.round(206 + 49 * agePercent)}, ${Math.round(235 + 20 * agePercent)})`;
                } else {
                    color = `rgb(${Math.round(255 - 70 * agePercent)}, ${Math.round(192 - 92 * agePercent)}, ${Math.round(203 - 103 * agePercent)})`;
                }
                villagerElement.style.backgroundColor = color;

                // Position villager based on simulation step or randomly
                if (simulationStep !== null && villager.history && villager.history[simulationStep]) {
                    villagerElement.style.left = `${villager.history[simulationStep].x}%`;
                    villagerElement.style.top = `${villager.history[simulationStep].y}%`;
                } else {
                    villagerElement.style.left = `${Math.random() * 80}%`;
                    villagerElement.style.top = `${Math.random() * 80}%`;
                }

                // Display villager's initials
                const initials = villager.name.split(' ').map(n => n.charAt(0)).join('.');
                villagerElement.textContent = initials;

                villagerElement.addEventListener('click', () => showVillagerHistory(villager));
                villageMap.appendChild(villagerElement);
            });
        }

        function showLocationDetails(location) {
            // Create a modal or popup element
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
            
            // Create content for the modal
            const content = document.createElement('div');
            content.className = 'bg-white p-6 rounded-lg max-w-md';
            content.innerHTML = `
                <h2 class="text-xl font-bold mb-2">${location.name}</h2>
                <p><strong>Type:</strong> ${location.type}</p>
                <p><strong>Capacity:</strong> ${location.capacity}</p>
                <p><strong>Description:</strong> ${location.description}</p>
                <button id="closeModal" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Close</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Add event listener to close the modal
            document.getElementById('closeModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        function updateCharacterInfo() {
            const characterInfo = document.getElementById('characterInfo');
            characterInfo.innerHTML = '';

            villagers.forEach((villager, index) => {
                const villagerCard = document.createElement('div');
                villagerCard.className = 'bg-gray-100 p-4 rounded-lg mb-4';
                villagerCard.innerHTML = `
                    <h3 class="font-semibold">${villager.name}</h3>
                    <p>Age: ${villager.age}</p>
                    <p>Gender: ${villager.gender}</p>
                    <p>Occupation: ${villager.occupation}</p>
                    <p>Status: ${villager.currentStatus.activity} at ${villager.currentStatus.location}</p>
                    <p>Mood: ${villager.currentStatus.mood}</p>
                    <div class="mt-2">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs mr-2">Show Memories</button>
                        <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded text-xs">Edit</button>
                    </div>
                `;
                const showMemoriesBtn = villagerCard.querySelector('button:first-child');
                showMemoriesBtn.addEventListener('click', () => showVillagerHistory(villager));

                const editBtn = villagerCard.querySelector('button:last-child');
                editBtn.addEventListener('click', () => showEditVillagerModal(villager, index));

                characterInfo.appendChild(villagerCard);
            });
        }

        function showEditVillagerModal(villager, index) {
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
            editModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">Edit ${villager.name}</h3>
                    <form id="editVillagerForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="name">Name:</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="name" type="text" value="${villager.name}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="age">Age:</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="age" type="number" value="${villager.age}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="gender">Gender:</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="gender" type="text" value="${villager.gender}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="occupation">Occupation:</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="occupation" type="text" value="${villager.occupation}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="activity">Activity:</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="activity" type="text" value="${villager.currentStatus.activity}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="location">Location:</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="location" type="text" value="${villager.currentStatus.location}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="mood">Mood:</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="mood" type="text" value="${villager.currentStatus.mood}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="newMemories">New Memories:</label>
                            <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="newMemories" rows="4">${villager.newMemories || ''}</textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="thoughts">Thoughts:</label>
                            <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="thoughts" rows="4">${villager.thoughts || ''}</textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="backstory">Backstory:</label>
                            <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="backstory" rows="4">${villager.backstory || ''}</textarea>
                        </div>
                        <div class="flex items-center justify-between">
                            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                                Save Changes
                            </button>
                            <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button" id="cancelEdit">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(editModal);

            const form = editModal.querySelector('form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                villagers[index] = {
                    ...villager,
                    name: form.name.value,
                    age: parseInt(form.age.value),
                    gender: form.gender.value,
                    occupation: form.occupation.value,
                    currentStatus: {
                        activity: form.activity.value,
                        location: form.location.value,
                        mood: form.mood.value
                    },
                    newMemories: form.newMemories.value,
                    thoughts: form.thoughts.value,
                    backstory: form.backstory.value
                };
                updateCharacterInfo();
                document.body.removeChild(editModal);
            });

            const cancelBtn = editModal.querySelector('#cancelEdit');
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(editModal);
            });
        }

        function addEventToLog(event) {
            const eventLog = document.getElementById('eventLog');
            const eventElement = document.createElement('div');
            eventElement.className = 'bg-white shadow-md rounded-lg p-4 mb-2';
            events.push(event)
            let interactionHtml = '';
            if (event.type === 'interaction') {
                interactionHtml = `
                    <button class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs show-interaction-btn">
                        Show Interaction
                    </button>
                `;
            }
            
            eventElement.innerHTML = `
                <h3 class="text-lg font-semibold mb-2">${event.title || 'Event'}</h3>
                <p>${event.description}</p>
                ${event.details ? `<p class="mt-2 text-sm text-gray-600">${event.details}</p>` : ''}
                ${interactionHtml}
            `;
            
            if (event.type === 'interaction') {
                const showInteractionBtn = eventElement.querySelector('.show-interaction-btn');
                showInteractionBtn.addEventListener('click', () => showInteractionPopup(event.interaction));
            }
            
            eventLog.insertBefore(eventElement, eventLog.firstChild);
        }

        async function runSimulation() {
            if (!simulationRunning) return;

            await simulationStep();

            if (!stepMode && currentStep < maxSimulationSteps) {
                setTimeout(runSimulation, 5000 / parseInt(document.getElementById('speedControl').value));
            } else if (currentStep >= maxSimulationSteps) {
                simulationRunning = false;
                document.getElementById('startPauseBtn').textContent = 'Start Simulation';
                alert('Simulation has reached the maximum number of steps.');
            }
        }

        async function simulationStep() {
            currentStep++;
            showLoader(`Simulating step ${currentStep} of ${maxSimulationSteps}...`);

            for (let i = 0; i < villagers.length; i++) {
                villagers[i] = await updateVillagerStatus(villagers[i]);
                addEventToLog({
                    title: `${villagers[i].name}'s Update`,
                    description: `${villagers[i].name} is ${villagers[i].currentStatus.activity} at ${villagers[i].currentStatus.location}.`,
                    details: `Mood: ${villagers[i].currentStatus.mood}`
                });
            }

            // Modified main interaction function
            if (villagers.length >= 2) {
                const interaction = await generateGroupInteraction(villagers);
                if (interaction) {
                    const participantNames = Object.keys(interaction.outcomes).join(', ');
                    addEventToLog({
                        type: 'interaction',
                        title: `Group Interaction: ${interaction.type}`,
                        description: `${participantNames} interact: "${interaction.dialogue[0]?.text || 'No dialogue available'}"`,
                        details: `Outcomes: ${Object.entries(interaction.outcomes).map(([name, outcome]) => `${name}: ${outcome.moodChange || 'No mood change'}`).join(', ')}`,
                        interaction: interaction
                    });
                }
            }

            updateVillageMap();
            updateCharacterInfo();
            hideLoader();
        }

        function showInteractionPopup(interaction) {
            const interactionModal = document.createElement('div');
            interactionModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
            interactionModal.innerHTML = `
                <div class="scrollable-container max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">Interaction: ${interaction.type}</h3>
                    <div class="mb-4">
                        ${interaction.dialogue.map(d => `<p><strong>${d.speaker}:</strong> ${d.text}</p>`).join('')}
                    </div>
                    <h4 class="font-bold mb-2">Outcomes:</h4>
                    <ul class="list-disc pl-5 mb-4">
                        ${Object.entries(interaction.outcomes).map(([name, outcome]) => `
                            <li>
                                <strong>${name}:</strong>
                                <ul class="list-disc pl-5">
                                    <li>Mood change: ${outcome.moodChange}</li>
                                    <li>Affinity change: ${outcome.affinityChange}</li>
                                    <li>New memories: ${outcome.newMemories.join(', ')}</li>
                                </ul>
                            </li>
                        `).join('')}
                    </ul>
                    <button class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Close</button>
                </div>
            `;
            document.body.appendChild(interactionModal);
            interactionModal.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(interactionModal);
            });
        }


        function showVillagerHistory(villager) {
            const memories = villager.newMemories || [];
            const thoughts = villager.thoughts || '';
            const historyModal = document.createElement('div');
            historyModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
            historyModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] flex flex-col">
                    <h3 class="text-xl font-bold mb-4">${villager.name}'s History</h3>
                    <div class="overflow-y-auto mb-4 flex-shrink-0" style="max-height: 100px;">
                        <p>${villager.backstory}</p>
                    </div>
                    <h4 class="font-bold mb-2">Recent Memories:</h4>
                    <div class="overflow-y-auto mb-4 flex-grow">
                        <ul class="list-disc pl-5">
                            ${memories.map(memory => `<li>${memory}</li>`).join('')}
                        </ul>
                    </div>
                    <h4 class="font-bold mb-2">Current Thoughts:</h4>
                    <div class="overflow-y-auto mb-4 flex-shrink-0" style="max-height: 100px;">
                        <p>${thoughts}</p>
                    </div>
                    <button class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Close</button>
                </div>
            `;
            document.body.appendChild(historyModal);
            historyModal.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(historyModal);
            });
        }


        document.getElementById('buildVillageBtn').addEventListener('click', initializeSimulation);

        document.getElementById('startPauseBtn').addEventListener('click', () => {
            appendToConsole(simulationRunning?"Pausing simulation ...":"Starting simulation ...")
            simulationRunning = !simulationRunning;
            document.getElementById('startPauseBtn').textContent = simulationRunning ? 'Pause Simulation' : 'Start Simulation';
            if (simulationRunning) {
                stepMode = false;
                currentStep = 0;
                maxSimulationSteps = parseInt(document.getElementById('maxSteps').value);
                runSimulation();
            }
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            const gameState = { villagers, locations, currentStep, events };
            const stateJson = JSON.stringify(gameState);
            const blob = new Blob([stateJson], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'village_life_simulator_state.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const gameState = JSON.parse(e.target.result);
                        villagers = gameState.villagers;
                        locations = gameState.locations;
                        events =  gameState.events || [];
                        currentStep = gameState.currentStep || 0;
                        updateVillageMap();
                        updateCharacterInfo();
                        alert('Game state imported successfully.');
                    } catch (error) {
                        alert('Error importing game state: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        });

        async function initializeSimulation() {
            saveParameters(); // Save parameters before initializing
            showLoader("Initializing simulation...");
            appendToConsole('Building village ...');
            
            const numPlaces = parseInt(document.getElementById('numPlaces').value);
            const numPersonas = parseInt(document.getElementById('numPersonas').value);
            const villageContext = document.getElementById('villageContext').value || 'A small medieval village';

            locations = [];
            villagers = [];
            currentStep = 0;
            maxSimulationSteps = parseInt(document.getElementById('maxSteps').value);

            for (let i = 0; i < numPlaces; i++) {
                const location = await generateLocation(villageContext, locations);
                if (location) locations.push(location);
            }

            for (let i = 0; i < numPersonas; i++) {
                const villager = await generateVillager(villageContext, villagers, locations);
                if (villager) villagers.push(villager);
            }

            updateVillageMap();
            updateCharacterInfo();

            hideLoader();
        }

        function showLoader(message) {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        document.getElementById('pauseBtn').addEventListener('click', () => {
            simulationRunning = false;
            document.getElementById('startPauseBtn').textContent = 'Start Simulation';
            hideLoader();
        });

 
        document.getElementById('numPlaces').addEventListener('change', saveParameters);
        document.getElementById('numPersonas').addEventListener('change', saveParameters);
        document.getElementById('villageContext').addEventListener('change', saveParameters);
        document.getElementById('maxSteps').addEventListener('change', saveParameters);
        document.getElementById('speedControl').addEventListener('change', saveParameters);

        // Load parameters when the page loads
        document.addEventListener('DOMContentLoaded', loadParameters);
    </script>
</body>
</html>