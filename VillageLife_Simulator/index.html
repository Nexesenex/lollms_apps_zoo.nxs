<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Life Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/lollms_assets/js/lollms_client_js"></script>
    <script src="/lollms_assets/js/axios.min"></script>
    <script src="https://unpkg.com/panzoom@9.4.0/dist/panzoom.min.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div id="gameContainer" class="w-full h-screen relative overflow-hidden flex">
        <!-- Left-side control panel -->
        <div id="controlPanel" class="w-64 bg-gray-800 bg-opacity-90 p-4 overflow-y-auto transform -translate-x-full transition-transform duration-300 ease-in-out absolute left-0 top-0 bottom-0 z-10">
            <h2 class="text-2xl font-semibold mb-4 text-green-400">Controls</h2>
            <!-- Control panel content -->
            <div class="space-y-4">
                <div class="flex flex-col space-y-2">
                    <label for="numPlaces" class="text-sm font-medium text-gray-300">Number of Places:</label>
                    <input type="number" id="numPlaces" min="1" max="20" value="10" class="bg-gray-700 text-white border border-gray-600 rounded-md p-2">
                </div>
                <div class="flex flex-col space-y-2">
                    <label for="numPersonas" class="text-sm font-medium text-gray-300">Number of Personas:</label>
                    <input type="number" id="numPersonas" min="1" max="20" value="5" class="bg-gray-700 text-white border border-gray-600 rounded-md p-2">
                </div>
                <div class="flex flex-col space-y-2">
                    <label for="villageContext" class="text-sm font-medium text-gray-300">Village Context:</label>
                    <textarea id="villageContext" rows="3" class="bg-gray-700 text-white border border-gray-600 rounded-md p-2" placeholder="Describe the village style, era, etc."></textarea>
                </div>
                <div class="flex flex-col space-y-2">
                    <label for="maxSteps" class="text-sm font-medium text-gray-300">Maximum Simulation Steps:</label>
                    <input type="number" id="maxSteps" min="1" max="1000" value="100" class="bg-gray-700 text-white border border-gray-600 rounded-md p-2">
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="buildImages" class="form-checkbox h-4 w-4 text-green-500">
                    <label for="buildImages" class="ml-2 text-sm font-medium text-gray-300">Build images (Coming up soon)</label>
                </div>
                <button id="buildVillageBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                    Build Village
                </button>
                <div class="flex items-center">
                    <label for="speedControl" class="mr-2 text-gray-300">Speed:</label>
                    <input type="range" id="speedControl" min="1" max="4" value="1" class="w-full">
                </div>
            </div>
        </div>

        <!-- Main game area -->
        <div class="flex-grow">
            <div id="villageMapContainer" class="w-full h-full bg-green-900">
                <div id="villageMap" class="w-full h-full"></div>
            </div>
        </div>

        <!-- Bottom panels -->
        <div id="characterPanel" class="hidden absolute inset-x-0 bottom-16 bg-gray-800 bg-opacity-90 p-4 overflow-y-auto max-h-[70vh]">
            <h2 class="text-2xl font-semibold mb-4 text-green-400">Characters</h2>
            <div id="characterInfo" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="eventPanel" class="hidden absolute inset-x-0 bottom-16 bg-gray-800 bg-opacity-90 p-4">
            <h2 class="text-2xl font-semibold mb-4 text-green-400">Event Log</h2>
            <div id="eventLogContainer" class="h-64 overflow-y-auto">
                <div id="eventLog" class="space-y-2"></div>
            </div>
        </div>
        
        <div id="loadingOverlay" class="hidden absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center">
            <div class="bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center mb-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-4 border-green-500 border-solid mr-3"></div>
                    <h3 class="text-lg font-semibold text-green-400">Processing...</h3>
                </div>
                <div class="bg-gray-900 p-3 rounded">
                    <pre id="consoleOutput" class="text-green-500 font-mono text-sm overflow-y-auto max-h-40 whitespace-pre-wrap break-words"></pre>
                </div>
                <button id="pauseBtn" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                    Pause
                </button>
            </div>
        </div>

        <!-- Bottom menu bar -->
        <div class="absolute bottom-0 inset-x-0 bg-gray-800 bg-opacity-90 p-4 flex justify-between items-center z-50 shadow-lg">
            <div class="flex space-x-4">
                <button id="controlsBtn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Controls
                </button>
                <button id="charactersBtn" class="flex items-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Characters
                </button>
                <button id="eventLogBtn" class="flex items-center bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    Event Log
                </button>
                <button id="exportBtn" class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Export State
                </button>
                <button id="importBtn" class="flex items-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Import State
                </button>
            </div>
            <div class="flex space-x-4">
                <button id="buildStoryBtn" class="flex items-center bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded transition duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    Build Story
                </button>
                <button id="startPauseBtn" class="flex items-center bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Start Simulation
                </button>
            </div>
        </div>
        
    </div>

    <script>
        // Initialize panzoom on the village map
        const villageMapElement = document.getElementById('villageMap');
        const panzoomInstance = panzoom(villageMapElement, {
            maxZoom: 5,
            minZoom: 0.5,
            bounds: true,
            boundsPadding: 0.1
        });

        // Panel toggle functionality
        const controlPanel = document.getElementById('controlPanel');
        const characterPanel = document.getElementById('characterPanel');
        const eventPanel = document.getElementById('eventPanel');

        document.getElementById('controlsBtn').addEventListener('click', () => {
            controlPanel.classList.toggle('-translate-x-full');
            characterPanel.classList.add('hidden');
            eventPanel.classList.add('hidden');
        });

        document.getElementById('charactersBtn').addEventListener('click', () => {
            characterPanel.classList.toggle('hidden');
            eventPanel.classList.add('hidden');
            controlPanel.classList.add('-translate-x-full');
        });

        document.getElementById('eventLogBtn').addEventListener('click', () => {
            eventPanel.classList.toggle('hidden');
            characterPanel.classList.add('hidden');
            controlPanel.classList.add('-translate-x-full');
        });
        const lc = new LollmsClient();
        let simulationRunning = false;
        let villagers = [];
        let locations = [];
        let events = [];
        let stepMode = false;
        let maxSimulationSteps = 100;
        let currentStep = 0;
        
        function appendToConsole(text) {
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.textContent += (consoleOutput.textContent ? '\n' : '') + text;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Add this function to save parameters to localStorage
        function saveParameters() {
            const params = {
                numPlaces: document.getElementById('numPlaces').value,
                numPersonas: document.getElementById('numPersonas').value,
                villageContext: document.getElementById('villageContext').value,
                maxSteps: document.getElementById('maxSteps').value,
                speed: document.getElementById('speedControl').value
            };
            localStorage.setItem('villageSimulatorParams', JSON.stringify(params));
        }

        // Add this function to load parameters from localStorage
        function loadParameters() {
            const savedParams = localStorage.getItem('villageSimulatorParams');
            if (savedParams) {
                const params = JSON.parse(savedParams);
                document.getElementById('numPlaces').value = params.numPlaces;
                document.getElementById('numPersonas').value = params.numPersonas;
                document.getElementById('villageContext').value = params.villageContext;
                document.getElementById('maxSteps').value = params.maxSteps;
                document.getElementById('speedControl').value = params.speed;
            }
            const buildStoryButton = document.getElementById('buildStoryBtn');
    
            if (buildStoryButton) {
                buildStoryButton.addEventListener('click', buildStoryBtn);
            }
        }        
        async function buildStoryBtn() {
            showLoader("Generating story...");
            appendToConsole("Generating story...")
            const villageContext = document.getElementById('villageContext').value || 'A small medieval village';

            // Construct a detailed prompt using the available data
            const prompt = `Generate a captivating story based on the following village information:
Context:
${villageContext}

Locations:
${JSON.stringify(locations, null, 2)}

Villagers:
${JSON.stringify(villagers, null, 2)}

Events:
${JSON.stringify(events, null, 2)}

Using the provided information, create a rich and engaging narrative that incorporates the locations, villagers, and events. The story should have a clear beginning, middle, and end, with interesting character interactions and plot developments. Make sure to weave the events into the story naturally, and use the locations as vivid backdrops for the unfolding tale.`;

    // Use lc.generate to create the story
    const story = await lc.generate(prompt);

    // Format the story as a Markdown document
    const storyMd = `# Village Story

${story}`;

            // Create a Blob with the Markdown content
            const blob = new Blob([storyMd], { type: "text/markdown;charset=utf-8" });

            // Create a temporary URL for the Blob
            const url = URL.createObjectURL(blob);

            // Create a temporary anchor element and trigger the download
            const a = document.createElement("a");
            a.href = url;
            a.download = "village_story.md";
            document.body.appendChild(a);
            a.click();

            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log("Story exported as village_story.md");
            hideLoader();
        }

        // Modify the generateVillager function to include relationships
        async function generateVillager(villageContext, existingVillagers, locations) {
            appendToConsole('Generating villager ...');
            const prompt = `${lc.system_message()}Generate a JSON object for a villager in our simulation. The village context is: 
${villageContext}

Include fields for name, age, occupation, personality traits, current status (location, activity, mood), and a brief backstory. The villager should have unique and interesting characteristics. Ensure the name is not one of the following: ${JSON.stringify(existingVillagers, null, 2)}.

Example format:
\`\`\`json
{
    "name": "Elara Moonwhisper",
    "gender": "female",
    "age": 28,
    "occupation": "Herbalist",
    "personalityTraits": ["curious", "empathetic", "night owl"],
    "currentStatus": {
        "location": "Moonlit Grove",
        "activity": "Gathering herbs",
        "mood": "Focused"
    },
    "backstory": "Elara grew up in a family of healers and discovered her affinity for plants at a young age. She often explores the village outskirts at night, believing the moonlight enhances the potency of her herbs."
}
\`\`\`
${lc.user_message()}Please generate a unique villager for our simulation, different from:
\`\`\`json
${JSON.stringify(existingVillagers, null, 2)}
\`\`\`
The village locations are:
\`\`\`json
${JSON.stringify(locations, null, 2)}
\`\`\`

${lc.ai_message()}`;
            console.log(prompt)
  
            showLoader("Generating villager...");
            console.log(prompt)
            const villagerJson = await lc.generateCode(prompt);
            hideLoader();
        
            if (villagerJson) {
                const villager = JSON.parse(villagerJson);
                villager.relationships = {};
                
                // Initialize relationships with existing villagers
                existingVillagers.forEach(otherVillager => {
                    villager.relationships[otherVillager.name] = {
                        affinity: Math.floor(Math.random() * 100),
                        interactions: 0
                    };
                    // Also add this new villager to the other villager's relationships
                    otherVillager.relationships[villager.name] = {
                        affinity: Math.floor(Math.random() * 100),
                        interactions: 0
                    };
                });
                appendToConsole(`Added ${villager.name}`);
                return villager;
            }
            return null;
        }
        
        async function generateLocation(villageContext, existingLocations, retryCount = 0) {
            appendToConsole('Generating location ...');
            const existingLocationNames = existingLocations.map(l => l.name).join(", ");
            const prompt = `${lc.system_message()}Generate a JSON object for a location in our village simulation. The village context is: ${villageContext}. Include fields for name, type (e.g., house, shop, public space), capacity, and a brief description. The location should be unique and fitting for the village setting. 

IMPORTANT: Ensure the name is not one of the following existing locations: ${existingLocationNames}. Do not repeat any of these names or create very similar names.

Example format:
\`\`\`json
{
    "name": "Whispering Willow Inn",
    "type": "Tavern",
    "capacity": 30,
    "description": "A cozy tavern built around an ancient willow tree. Its branches extend through the roof, creating a magical atmosphere. Known for its unique herbal brews and storytelling nights."
}
\`\`\`        
${lc.user_message()}Please generate a unique location for our village simulation. Remember, it must be different from these existing locations: ${existingLocationNames}.${lc.ai_message()}`;

            showLoader("Generating location...");
            const locationJson = await lc.generateCode(prompt);
            hideLoader();

            if (locationJson) {
                const newLocation = JSON.parse(locationJson);
                // Double-check that the new location name is unique
                if (existingLocations.some(loc => loc.name === newLocation.name)) {
                    if (retryCount === 0) {
                        console.warn("Generated location name already exists. Retrying once...");
                        return generateLocation(villageContext, existingLocations, 1);
                    } else {
                        console.error("Failed to generate a unique location name after retry.");
                        return null;
                    }
                }
                appendToConsole(`Added ${newLocation.name}`);
                return newLocation;
            }
            return null;
        }

        
        async function updateVillagerStatus(villager) {
            const villageContext = document.getElementById('villageContext').value || 'A small medieval village';
            const prompt = `${lc.system_message()}Given the current state of a villager and the context, generate a JSON object representing their updated status. Include fields for current location, activity, mood, and any new memories or thoughts based on their recent experiences. Consider their personality and backstory when updating their status.
Here is the general village context:
${JSON.stringify(villageContext, null, 2)}

All villagers information:
${JSON.stringify(villagers, null, 2)}

Example format:
\`\`\`json
{
    "currentStatus": {
        "location": "Whispering Willow Inn",
        "activity": "Sharing herbal tea recipes",
        "mood": "Excited"
    },
    "newMemories": ["Made a new friend who's interested in herbology", "Learned about a rare plant growing near the village"],
    "thoughts": "I wonder if I could organize a weekly herbalism workshop at the inn..."
}
\`\`\`

${lc.user_message()}Current villager state: ${JSON.stringify(villager)}. Please update the villager status.${lc.ai_message()}`;
            console.log(prompt);
            showLoader("Updating villager status...");
            const updatedStatusJson = await lc.generateCode(prompt);
            hideLoader();
        
            if (updatedStatusJson) {
                const updatedStatus = JSON.parse(updatedStatusJson);
                return { ...villager, ...updatedStatus };
            }
            return villager;
        }
        
        // Add this to the villager generation function
        function generateRelationships(villager, otherVillagers) {
            villager.relationships = {};
            otherVillagers.forEach(other => {
                if (other.name !== villager.name) {
                    villager.relationships[other.name] = {
                        affinity: Math.floor(Math.random() * 100),
                        interactions: 0
                    };
                }
            });
        }

        async function generateGroupInteraction(villagers) {
            if (villagers.length < 2) {
                console.log("Not enough villagers for an interaction");
                return null;
            }

            // Select a random number of villagers (between 2 and the total number of villagers)
            const numParticipants = Math.floor(Math.random() * (villagers.length - 1)) + 2;
            const participants = shuffleArray(villagers).slice(0, numParticipants);

            // Calculate average affinity between all participants
            let totalAffinity = 0;
            let affinityCount = 0;
            for (let i = 0; i < participants.length; i++) {
                for (let j = i + 1; j < participants.length; j++) {
                    const villager1 = participants[i];
                    const villager2 = participants[j];
                    if (!villager1.relationships[villager2.name]) {
                        villager1.relationships[villager2.name] = { affinity: 50, interactions: 0 };
                    }
                    if (!villager2.relationships[villager1.name]) {
                        villager2.relationships[villager1.name] = { affinity: 50, interactions: 0 };
                    }
                    totalAffinity += villager1.relationships[villager2.name].affinity + villager2.relationships[villager1.name].affinity;
                    affinityCount += 2;
                }
            }
            const averageAffinity = totalAffinity / affinityCount;
            const villageContext = document.getElementById('villageContext').value || 'A small medieval village';

            const prompt = `${lc.system_message()}Generate a JSON object representing an interaction between ${numParticipants} villagers. Their average affinity is ${averageAffinity.toFixed(2)}/100. Include fields for the type of interaction, dialogue snippets, and any resulting changes in mood, affinity, or new memories for all villagers involved. Consider their personalities, occupations, current statuses, and affinities when creating the interaction.
The discussion should take into consideration the village context and villagers status.
Village context:
${JSON.stringify(villageContext, null, 2)}


Example format:
\`\`\`json
{
    "type": "Group discussion",
    "dialogue": [
        {"speaker": "Elara", "text": "I've discovered a new herb that might help with various ailments."},
        {"speaker": "Finn", "text": "That's fascinating! How does it work?"},
        {"speaker": "Zara", "text": "Could it help with the village's crop yield?"}
        ... the discussion can be as long as it is needed
    ],
    "outcomes": {
        "Elara": {
            "moodChange": "Enthusiastic",
            "affinityChanges": {"Finn": 5, "Zara": 3},
            "newMemories": ["Shared knowledge about herbs with the group", "Felt appreciated for her expertise"]
        },
        "Finn": {
            "moodChange": "Curious",
            "affinityChanges": {"Elara": 7, "Zara": 2},
            "newMemories": ["Learned about a new herb from Elara", "Enjoyed the group discussion"]
        },
        "Zara": {
            "moodChange": "Intrigued",
            "affinityChanges": {"Elara": 4, "Finn": 1},
            "newMemories": ["Considered potential agricultural applications of the new herb"]
        }
    }
}
\`\`\`
${lc.user_message()}Villagers: ${JSON.stringify(participants)}. Please generate an interaction between these villagers.${lc.ai_message()}`;

            showLoader("Generating group interaction...");
            const interactionJson = await lc.generateCode(prompt);
            hideLoader();

            if (interactionJson) {
                const interaction = JSON.parse(interactionJson);
                // Update relationships based on the interaction
                updateGroupRelationships(participants, interaction);
                return interaction;
            }
            return null;
        }

        function updateGroupRelationships(participants, interaction) {
            for (const villager of participants) {
                const outcome = interaction.outcomes[villager.name];
                if (outcome) {
                    if (outcome.moodChange) {
                        villager.mood = outcome.moodChange;
                    }
                    if (outcome.affinityChanges) {
                        for (const [otherVillagerName, affinityChange] of Object.entries(outcome.affinityChanges)) {
                            if (villager.relationships[otherVillagerName]) {
                                villager.relationships[otherVillagerName].affinity += affinityChange;
                                villager.relationships[otherVillagerName].affinity = Math.max(0, Math.min(100, villager.relationships[otherVillagerName].affinity));
                                villager.relationships[otherVillagerName].interactions++;
                            }
                        }
                    }
                    if (outcome.newMemories) {
                        villager.newMemories.push(...outcome.newMemories);
                    }
                }
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateRelationships(villager1, villager2, interaction) {
            const outcome1 = interaction.outcomes[villager1.name];
            const outcome2 = interaction.outcomes[villager2.name];
            
            if (outcome1 && outcome2) {
                villager1.relationships[villager2.name].affinity += outcome1.affinityChange || 0;
                villager1.relationships[villager2.name].interactions++;
                villager2.relationships[villager1.name].affinity += outcome2.affinityChange || 0;
                villager2.relationships[villager1.name].interactions++;

                // Ensure affinity stays within 0-100 range
                villager1.relationships[villager2.name].affinity = Math.max(0, Math.min(100, villager1.relationships[villager2.name].affinity));
                villager2.relationships[villager1.name].affinity = Math.max(0, Math.min(100, villager2.relationships[villager1.name].affinity));
            }
        }

        
        function updateVillageMap(simulationStep = null) {
            const villageMap = document.getElementById('villageMap');
            villageMap.innerHTML = '';

            locations.forEach((location, index) => {
                const locationElement = document.createElement('div');
                locationElement.className = 'absolute w-16 h-16 bg-yellow-200 rounded-lg flex items-center justify-center text-xs text-center text-black cursor-pointer';
                locationElement.style.left = `${(index % 5) * 20}%`;
                locationElement.style.top = `${Math.floor(index / 5) * 25}%`;
                locationElement.textContent = location.name;
                locationElement.addEventListener('click', () => showLocationDetails(location));
                villageMap.appendChild(locationElement);
            });

            villagers.forEach((villager, index) => {
                const villagerElement = document.createElement('div');
                villagerElement.className = 'absolute w-8 h-8 rounded-full flex items-center justify-center text-xs text-black cursor-pointer';
                
                // Colorization based on age and gender
                const agePercent = villager.age / 100; // Assuming max age is 100
                let color;
                if (villager.gender === 'male') {
                    color = `rgb(${Math.round(135 + 120 * agePercent)}, ${Math.round(206 + 49 * agePercent)}, ${Math.round(235 + 20 * agePercent)})`;
                } else {
                    color = `rgb(${Math.round(255 - 70 * agePercent)}, ${Math.round(192 - 92 * agePercent)}, ${Math.round(203 - 103 * agePercent)})`;
                }
                villagerElement.style.backgroundColor = color;

                // Position villager based on simulation step or randomly
                if (simulationStep !== null && villager.history && villager.history[simulationStep]) {
                    villagerElement.style.left = `${villager.history[simulationStep].x}%`;
                    villagerElement.style.top = `${villager.history[simulationStep].y}%`;
                } else {
                    villagerElement.style.left = `${Math.random() * 80}%`;
                    villagerElement.style.top = `${Math.random() * 80}%`;
                }

                // Display villager's initials
                const initials = villager.name.split(' ').map(n => n.charAt(0)).join('.');
                villagerElement.textContent = initials;

                villagerElement.addEventListener('click', () => showVillagerHistory(villager));
                villageMap.appendChild(villagerElement);
            });
        }

        function showLocationDetails(location) {
            // Create a modal or popup element
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
            
            // Create content for the modal
            const content = document.createElement('div');
            content.className = 'bg-gray-800 p-6 rounded-lg max-w-md';
            content.innerHTML = `
                <h2 class="text-xl font-bold mb-2">${location.name}</h2>
                <p><strong>Type:</strong> ${location.type}</p>
                <p><strong>Capacity:</strong> ${location.capacity}</p>
                <p><strong>Description:</strong> ${location.description}</p>
                <button id="closeModal" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Close</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Add event listener to close the modal
            document.getElementById('closeModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        function updateCharacterInfo() {
            const characterInfo = document.getElementById('characterInfo');
            characterInfo.innerHTML = '';

            villagers.forEach((villager, index) => {
                const villagerCard = document.createElement('div');
                villagerCard.className = 'bg-gray-900 border border-green-500 rounded-lg p-4 mb-4 font-mono text-green-400 shadow-lg';
                villagerCard.innerHTML = `
                    <h3 class="font-semibold text-lg text-green-300 mb-2">${villager.name}</h3>
                    <p class="text-green-400">Age: <span class="text-green-500">${villager.age}</span></p>
                    <p class="text-green-400">Gender: <span class="text-green-500">${villager.gender}</span></p>
                    <p class="text-green-400">Occupation: <span class="text-green-500">${villager.occupation}</span></p>
                    <p class="text-green-400">Status: <span class="text-green-500">${villager.currentStatus.activity} at ${villager.currentStatus.location}</span></p>
                    <p class="text-green-400">Mood: <span class="text-green-500">${villager.currentStatus.mood}</span></p>
                    <div class="mt-4 flex space-x-2">
                        <button class="bg-green-700 hover:bg-green-600 text-green-200 font-bold py-1 px-2 rounded text-xs border border-green-500">Show Memories</button>
                        <button class="bg-green-700 hover:bg-green-600 text-green-200 font-bold py-1 px-2 rounded text-xs border border-green-500">Edit</button>
                    </div>
                `;
                const showMemoriesBtn = villagerCard.querySelector('button:first-child');
                showMemoriesBtn.addEventListener('click', () => showVillagerHistory(villager));

                const editBtn = villagerCard.querySelector('button:last-child');
                editBtn.addEventListener('click', () => showEditVillagerModal(villager, index));

                characterInfo.appendChild(villagerCard);
            });
        }

        function showEditVillagerModal(villager, index) {
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50';
            editModal.innerHTML = `
                <div class="bg-gray-900 border border-green-500 p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto text-green-400 font-mono">
                    <h3 class="text-xl font-bold mb-4 text-green-300">Edit ${villager.name}</h3>
                    <form id="editVillagerForm">
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="name">Name:</label>
                            <input class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="name" type="text" value="${villager.name}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="age">Age:</label>
                            <input class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="age" type="number" value="${villager.age}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="gender">Gender:</label>
                            <input class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="gender" type="text" value="${villager.gender}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="occupation">Occupation:</label>
                            <input class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="occupation" type="text" value="${villager.occupation}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="activity">Activity:</label>
                            <input class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="activity" type="text" value="${villager.currentStatus.activity}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="location">Location:</label>
                            <input class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="location" type="text" value="${villager.currentStatus.location}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="mood">Mood:</label>
                            <input class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="mood" type="text" value="${villager.currentStatus.mood}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="newMemories">New Memories:</label>
                            <textarea class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="newMemories" rows="4">${villager.newMemories || ''}</textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="thoughts">Thoughts:</label>
                            <textarea class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="thoughts" rows="4">${villager.thoughts || ''}</textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-green-400 text-sm font-bold mb-2" for="backstory">Backstory:</label>
                            <textarea class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 bg-gray-800 text-green-300 leading-tight focus:outline-none focus:shadow-outline" id="backstory" rows="4">${villager.backstory || ''}</textarea>
                        </div>
                        <div class="flex items-center justify-between">
                            <button class="bg-green-700 hover:bg-green-600 text-green-200 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline border border-green-500" type="submit">
                                Save Changes
                            </button>
                            <button class="bg-red-700 hover:bg-red-600 text-red-200 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline border border-red-500" type="button" id="cancelEdit">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(editModal);

            const form = editModal.querySelector('form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                villagers[index] = {
                    ...villager,
                    name: form.name.value,
                    age: parseInt(form.age.value),
                    gender: form.gender.value,
                    occupation: form.occupation.value,
                    currentStatus: {
                        activity: form.activity.value,
                        location: form.location.value,
                        mood: form.mood.value
                    },
                    newMemories: form.newMemories.value,
                    thoughts: form.thoughts.value,
                    backstory: form.backstory.value
                };
                updateCharacterInfo();
                document.body.removeChild(editModal);
            });

            const cancelBtn = editModal.querySelector('#cancelEdit');
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(editModal);
            });
        }


        function addEventToLog(event) {
            const eventLog = document.getElementById('eventLog');
            const eventElement = document.createElement('div');
            eventElement.className = 'bg-gray-900 border border-green-500 rounded-lg p-4 mb-2 font-mono text-green-400 shadow-lg';
            events.push(event)
            let interactionHtml = '';
            if (event.type === 'interaction') {
                interactionHtml = `
                    <button class="mt-2 bg-green-700 hover:bg-green-600 text-green-200 font-bold py-1 px-2 rounded text-xs show-interaction-btn border border-green-500">
                        Show Interaction
                    </button>
                `;
            }
            
            eventElement.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-green-300">${event.title || 'Event'}</h3>
                <p class="text-green-400">${event.description}</p>
                ${event.details ? `<p class="mt-2 text-sm text-green-500">${event.details}</p>` : ''}
                ${interactionHtml}
            `;
            
            if (event.type === 'interaction') {
                const showInteractionBtn = eventElement.querySelector('.show-interaction-btn');
                showInteractionBtn.addEventListener('click', () => showInteractionPopup(event.interaction));
            }
            
            eventLog.insertBefore(eventElement, eventLog.firstChild);
        }

        async function runSimulation() {
            if (!simulationRunning) return;

            await simulationStep();

            if (!stepMode && currentStep < maxSimulationSteps) {
                setTimeout(runSimulation, 5000 / parseInt(document.getElementById('speedControl').value));
            } else if (currentStep >= maxSimulationSteps) {
                simulationRunning = false;
                document.getElementById('startPauseBtn').textContent = 'Start Simulation';
                alert('Simulation has reached the maximum number of steps.');
            }
        }

        async function simulationStep() {
            currentStep++;
            showLoader(`Simulating step ${currentStep} of ${maxSimulationSteps}...`);

            for (let i = 0; i < villagers.length; i++) {
                villagers[i] = await updateVillagerStatus(villagers[i]);
                event = {
                    type:'villager update',
                    title: `${villagers[i].name}'s Update`,
                    description: `${villagers[i].name} is ${villagers[i].currentStatus.activity} at ${villagers[i].currentStatus.location}.`,
                    details:`Mood: ${villagers[i].currentStatus.mood}`
                }
                events.push(event)
                addEventToLog(event);
            }

            // Modified main interaction function
            if (villagers.length >= 2) {
                const interaction = await generateGroupInteraction(villagers);
                event = {
                    type: 'interaction',
                    title: `Group Interaction: ${interaction.type}`,
                    description: `${participantNames} interact: "${interaction.dialogue[0]?.text || 'No dialogue available'}"`,
                    details: `Outcomes: ${Object.entries(interaction.outcomes).map(([name, outcome]) => `${name}: ${outcome.moodChange || 'No mood change'}`).join(', ')}`,
                    interaction: interaction
                }
                events.push(event)
                if (interaction) {
                    const participantNames = Object.keys(interaction.outcomes).join(', ');
                    addEventToLog(event);
                }
            }

            updateVillageMap();
            updateCharacterInfo();
            hideLoader();
        }

        function addEventToLog(event) {
            const eventLog = document.getElementById('eventLog');
            const eventElement = document.createElement('div');
            eventElement.className = 'bg-gray-900 border border-green-500 rounded-lg p-4 mb-2 font-mono text-green-400 shadow-lg';
            events.push(event)
            let interactionHtml = '';
            if (event.type === 'interaction') {
                interactionHtml = `
                    <button class="mt-2 bg-green-700 hover:bg-green-600 text-green-200 font-bold py-1 px-2 rounded text-xs show-interaction-btn border border-green-500">
                        Show Interaction
                    </button>
                `;
            }
            
            eventElement.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-green-300">${event.title || 'Event'}</h3>
                <p class="text-green-400">${event.description}</p>
                ${event.details ? `<p class="mt-2 text-sm text-green-500">${event.details}</p>` : ''}
                ${interactionHtml}
            `;
            
            if (event.type === 'interaction') {
                const showInteractionBtn = eventElement.querySelector('.show-interaction-btn');
                showInteractionBtn.addEventListener('click', () => showInteractionPopup(event.interaction));
            }
            
            eventLog.insertBefore(eventElement, eventLog.firstChild);
        }

        function showInteractionPopup(interaction) {
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const content = document.createElement('div');
            content.className = 'bg-gray-800 border border-green-500 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] flex flex-col';
            
            content.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-green-300">Interaction Details</h2>
                <div class="overflow-y-auto flex-grow">
                    <pre class="text-green-400 whitespace-pre-wrap">${JSON.stringify(interaction, null, 2)}</pre>
                </div>
                <button class="mt-4 bg-green-700 hover:bg-green-600 text-green-200 font-bold py-2 px-4 rounded close-popup">
                    Close
                </button>
            `;
            
            popup.appendChild(content);
            document.body.appendChild(popup);
            
            const closeBtn = popup.querySelector('.close-popup');
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(popup);
            });
        }


        function showVillagerHistory(villager) {
            const memories = villager.newMemories || [];
            const thoughts = villager.thoughts || '';
            const historyModal = document.createElement('div');
            historyModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
            historyModal.innerHTML = `
                <div class="bg-gray-900 p-6 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] flex flex-col">
                    <h3 class="text-xl font-bold mb-4">${villager.name}'s History</h3>
                    <div class="overflow-y-auto mb-4 flex-shrink-0" style="max-height: 100px;">
                        <p>${villager.backstory}</p>
                    </div>
                    <h4 class="font-bold mb-2">Recent Memories:</h4>
                    <div class="overflow-y-auto mb-4 flex-grow">
                        <ul class="list-disc pl-5">
                            ${memories.map(memory => `<li>${memory}</li>`).join('')}
                        </ul>
                    </div>
                    <h4 class="font-bold mb-2">Current Thoughts:</h4>
                    <div class="overflow-y-auto mb-4 flex-shrink-0" style="max-height: 100px;">
                        <p>${thoughts}</p>
                    </div>
                    <button class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Close</button>
                </div>
            `;
            document.body.appendChild(historyModal);
            historyModal.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(historyModal);
            });
        }


        document.getElementById('buildVillageBtn').addEventListener('click', initializeSimulation);

        document.getElementById('startPauseBtn').addEventListener('click', () => {
            appendToConsole(simulationRunning?"Pausing simulation ...":"Starting simulation ...")
            simulationRunning = !simulationRunning;
            document.getElementById('startPauseBtn').textContent = simulationRunning ? 'Pause Simulation' : 'Start Simulation';
            if (simulationRunning) {
                stepMode = false;
                currentStep = 0;
                maxSimulationSteps = parseInt(document.getElementById('maxSteps').value);
                runSimulation();
            }
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            const gameState = { villagers, locations, currentStep, events };
            const stateJson = JSON.stringify(gameState);
            const blob = new Blob([stateJson], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'village_life_simulator_state.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const gameState = JSON.parse(e.target.result);
                        villagers = gameState.villagers;
                        locations = gameState.locations;
                        events =  gameState.events || [];
                        currentStep = gameState.currentStep || 0;
                        updateVillageMap();
                        updateCharacterInfo();
                        console.log(events)
                        events.map((event)=>{
                            addEventToLog(event);
                        });
                        alert('Game state imported successfully.');
                    } catch (error) {
                        alert('Error importing game state: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        });

        async function initializeSimulation() {
            saveParameters(); // Save parameters before initializing
            showLoader("Initializing simulation...");
            appendToConsole('Building village ...');
            
            const numPlaces = parseInt(document.getElementById('numPlaces').value);
            const numPersonas = parseInt(document.getElementById('numPersonas').value);
            const villageContext = document.getElementById('villageContext').value || 'A small medieval village';

            locations = [];
            villagers = [];
            currentStep = 0;
            maxSimulationSteps = parseInt(document.getElementById('maxSteps').value);

            for (let i = 0; i < numPlaces; i++) {
                const location = await generateLocation(villageContext, locations);
                if (location) locations.push(location);
            }

            for (let i = 0; i < numPersonas; i++) {
                const villager = await generateVillager(villageContext, villagers, locations);
                if (villager) villagers.push(villager);
            }

            updateVillageMap();
            updateCharacterInfo();

            hideLoader();
        }

        function showLoader(message) {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        document.getElementById('pauseBtn').addEventListener('click', () => {
            simulationRunning = false;
            document.getElementById('startPauseBtn').textContent = 'Start Simulation';
            hideLoader();
        });

 
        document.getElementById('numPlaces').addEventListener('change', saveParameters);
        document.getElementById('numPersonas').addEventListener('change', saveParameters);
        document.getElementById('villageContext').addEventListener('change', saveParameters);
        document.getElementById('maxSteps').addEventListener('change', saveParameters);
        document.getElementById('speedControl').addEventListener('change', saveParameters);

        // Load parameters when the page loads
        document.addEventListener('DOMContentLoaded', loadParameters);
    </script>
</body>
</html>