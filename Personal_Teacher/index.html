<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOLLMS Personal Teacher Enhanced</title>
    <!-- Assets -->
    <script src="/lollms_assets/js/tailwindcss"></script>
    <script src="/lollms_assets/js/lollms_client_js"></script>
    <script src="/lollms_assets/js/axios.min"></script>
    <script src="/lollms_assets/js/web.app.localizer.js"></script> <!-- Assumed available -->
    <!-- External Libs -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <!-- LOLLMS Renderer -->
    <link rel="stylesheet" type="text/css" href="/lollms_assets/css/lollms_markdown_renderer">
    <script src="/lollms_assets/js/lollms_markdown_renderer"></script>
    <!-- Math & Diagrams -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- Animation & P5 -->
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.2/lib/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --secondary-color: #ec4899; /* Pink-500 */
            --background-light: #f3f4f6; /* Gray-100 */
            --background-dark: #1f2937; /* Gray-800 */
            --text-light: #111827; /* Gray-900 */
            --text-dark: #f9fafb; /* Gray-50 */
            --card-bg-light: #ffffff;
            --card-bg-dark: #374151; /* Gray-700 */
            --border-light: #e5e7eb; /* Gray-200 */
            --border-dark: #4b5563; /* Gray-600 */
            --success-light: #d1fae5; /* Green-100 */
            --success-dark: #065f46; /* Green-800 */
             --success-text-light: #065f46; /* Green-800 */
             --success-text-dark: #6ee7b7; /* Green-300 */
            --error-light: #fee2e2; /* Red-100 */
            --error-dark: #991b1b; /* Red-800 */
             --error-text-light: #991b1b; /* Red-800 */
             --error-text-dark: #fca5a5; /* Red-300 */
        }
        /* Base styles */
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-light); color: var(--text-light); transition: background-color 0.3s ease, color 0.3s ease; font-size: 16px; }
        .dark body { background-color: var(--background-dark); color: var(--text-dark); }
        .card { background-color: var(--card-bg-light); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); transition: background-color 0.3s ease; overflow: hidden; }
        .dark .card { background-color: var(--card-bg-dark); }
        /* Buttons */
        .btn { font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 8px; transition: background-color 0.3s ease, transform 0.1s ease, opacity 0.2s ease; cursor: pointer; border: none; display: inline-flex; align-items: center; justify-content: center; line-height: 1.25; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; transform: translateY(-1px); }
        .btn-secondary { background-color: var(--secondary-color); color: white; padding: 0.5rem 1rem; }
        .btn-secondary:hover:not(:disabled) { background-color: #db2777; transform: translateY(-1px); }
        .btn-icon { background-color: transparent; color: var(--primary-color); padding: 0.5rem; border-radius: 50%; transition: background-color 0.2s ease; }
        .dark .btn-icon { color: #a5b4fc; }
        .btn-icon:hover:not(:disabled) { background-color: rgba(79, 70, 229, 0.1); }
        .dark .btn-icon:hover:not(:disabled) { background-color: rgba(165, 180, 252, 0.2); }
        /* Inputs & Textarea */
        input[type="text"], select, textarea { border: 1px solid var(--border-light); border-radius: 8px; padding: 0.75rem; width: 100%; transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.2s ease; background-color: var(--card-bg-light); color: var(--text-light); }
        .dark input[type="text"], .dark select, .dark textarea { border-color: var(--border-dark); background-color: var(--card-bg-dark); color: var(--text-dark); }
        input[type="text"]:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); }
        textarea { min-height: 80px; resize: vertical; }
        ::placeholder { color: #9ca3af; } /* Gray-400 */
        .dark ::placeholder { color: #6b7280; } /* Gray-500 */
        /* Utils */
        .hidden { display: none !important; }
        .blurred-bg { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); background-color: rgba(0, 0, 0, 0.4); }
        .dark .blurred-bg { background-color: rgba(20, 20, 30, 0.5); }
        /* Tabs */
        .tab-button { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -1px; transition: border-color 0.3s ease, color 0.3s ease; color: #6b7280; font-weight: 500; }
        .dark .tab-button { color: #9ca3af; }
        .tab-button.active { border-color: var(--primary-color); color: var(--primary-color); }
        .dark .tab-button.active { color: #a5b4fc; border-color: #a5b4fc; }
        .tab-content { padding-top: 1.5rem; border-top: 1px solid var(--border-light); }
        .dark .tab-content { border-top-color: var(--border-dark); }
        /* Markdown & Code */
        .prose { max-width: none; font-size: 1rem; line-height: 1.7; color: var(--text-light); }
        .dark .prose { color: var(--text-dark); }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 { color: var(--text-light); font-weight: 600; margin-top: 1.5em; margin-bottom: 0.8em; padding-bottom: 0.3em; border-bottom: 1px solid var(--border-light); }
        .dark .prose h1, .dark .prose h2, .dark .prose h3, .dark .prose h4, .dark .prose h5, .dark .prose h6 { color: var(--text-dark); border-bottom-color: var(--border-dark); }
        .prose a { color: var(--primary-color); text-decoration: underline; }
        .dark .prose a { color: #a5b4fc; }
        .prose code:not(pre > code) { background-color: rgba(0, 0, 0, 0.05); padding: 0.2em 0.4em; margin: 0 0.1em; border-radius: 4px; font-size: 0.9em; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; color: #c0392b; }
        .dark .prose code:not(pre > code) { background-color: rgba(255, 255, 255, 0.1); color: #f1c40f; }
        .prose pre { border-radius: 8px; margin-top: 1.5em; margin-bottom: 1.5em; padding: 1em; overflow-x: auto; background: #f3f4f6; }
        .dark .prose pre { background: #1e1e1e; }
        .prose pre code { background-color: transparent !important; padding: 0 !important; margin: 0 !important; border-radius: 0 !important; font-size: 0.9em !important; color: inherit !important; }
        .prose blockquote { border-left: 4px solid var(--primary-color); padding-left: 1em; margin: 1em 0; font-style: italic; color: #6b7280; background-color: #f9fafb; }
        .dark .prose blockquote { border-left-color: #a5b4fc; color: #9ca3af; background-color: #374151;}
        .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em;}
        .prose li > p { margin-top: 0.5em; margin-bottom: 0.5em; }
        /* Spinner */
        .loader { border-top-color: var(--primary-color); animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Iframe */
        iframe { background-color: white; }
        .dark iframe { background-color: #111827; }
        /* Settings Popup */
        #settings-popup .neumorphic { background-color: var(--card-bg-light); border-radius: 12px; box-shadow: 5px 5px 10px #d1d5db, -5px -5px 10px #ffffff; }
        .dark #settings-popup .neumorphic { background: var(--card-bg-dark); box-shadow: 5px 5px 10px #1a202c, -5px -5px 10px #4b5563; }
        #settings-popup label { color: var(--text-light); font-weight: 500; }
        .dark #settings-popup label { color: var(--text-dark); }
        #settings-popup input, #settings-popup select { background-color: #e5e7eb; box-shadow: inset 2px 2px 5px #bdbfc1, inset -2px -2px 5px #ffffff; border: none; color: var(--text-light); }
        .dark #settings-popup input, .dark #settings-popup select { background-color: #4b5563; box-shadow: inset 2px 2px 5px #374151, inset -2px -2px 5px #5c6777; color: var(--text-dark); }
        #settings-popup button#close-settings { background: var(--primary-color); color: white; box-shadow: 3px 3px 6px #d1d5db, -3px -3px 6px #ffffff; }
        .dark #settings-popup button#close-settings { box-shadow: 3px 3px 6px #1a202c, -3px -3px 6px #4b5563; }
        /* Quiz specific styles */
        .quiz-option-label { display: flex; align-items: center; space-x-3; cursor: pointer; padding: 0.75rem; border-radius: 6px; transition: background-color 0.2s ease; border: 1px solid var(--border-light); }
        .dark .quiz-option-label { border-color: var(--border-dark); }
        .quiz-option-label:hover { background-color: rgba(79, 70, 229, 0.05); }
        .dark .quiz-option-label:hover { background-color: rgba(165, 180, 252, 0.1); }
        .quiz-option-label.correct { background-color: var(--success-light) !important; border-color: var(--success-text-light) !important; color: var(--success-text-light); font-weight: 500;}
        .dark .quiz-option-label.correct { background-color: var(--success-dark) !important; border-color: var(--success-text-dark) !important; color: var(--success-text-dark);}
        .quiz-option-label.incorrect { background-color: var(--error-light) !important; border-color: var(--error-text-light) !important; color: var(--error-text-light); }
        .dark .quiz-option-label.incorrect { background-color: var(--error-dark) !important; border-color: var(--error-text-dark) !important; color: var(--error-text-dark); }
        .quiz-result-feedback { font-weight: 600; }
        .quiz-result-feedback.excellent { color: var(--success-text-light); }
        .dark .quiz-result-feedback.excellent { color: var(--success-text-dark); }
        .quiz-result-feedback.good { color: #d97706; } /* Amber-600 */
        .dark .quiz-result-feedback.good { color: #f59e0b; } /* Amber-500 */
        .quiz-result-feedback.retry { color: var(--error-text-light); }
        .dark .quiz-result-feedback.retry { color: var(--error-text-dark); }
        /* Ideas Section */
        .ideas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .idea-card { background-color: var(--card-bg-light); border: 1px solid var(--border-light); border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s ease; }
        .dark .idea-card { background-color: var(--card-bg-dark); border-color: var(--border-dark); }
        .idea-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-color: var(--primary-color); }
        .dark .idea-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .idea-card h4 { font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem; }
        .dark .idea-card h4 { color: #a5b4fc; }
        .idea-card p { font-size: 0.9rem; color: #6b7280; }
        .dark .idea-card p { color: #9ca3af; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-10 pb-4 border-b border-border-light dark:border-border-dark">
            <h1 data-translate="appTitle" class="text-3xl font-bold text-primary-color dark:text-indigo-400 mb-4 sm:mb-0">Personal Teacher</h1>
            <div class="flex items-center space-x-2 sm:space-x-3">
                <button id="toggleSavedCourses" title="Saved Courses" class="btn btn-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg></button>
                <button id="settings-button" title="Settings" class="btn btn-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                <button id="darkModeToggle" title="Toggle Dark Mode" class="btn btn-icon">
                    <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Course Generation Form -->
            <div class="card p-6 mb-8">
                <h2 class="text-2xl font-semibold text-primary-color dark:text-indigo-400 mb-5" data-translate="generateCourseTitle">Create Your Lesson</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <label for="topic" data-translate="whatWouldYouLikeToLearn" class="block mb-2 font-medium">What topic do you want to learn?</label>
                        <input type="text" id="topic" placeholder="e.g., Python functions, Photosynthesis, French Revolution">
                    </div>
                    <div>
                        <label for="difficulty" data-translate="difficultyLevel" class="block mb-2 font-medium">Select difficulty level:</label>
                        <select id="difficulty">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                            <option value="expert">Expert</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                     <label for="details" data-translate="optionalDetails" class="block mb-2 font-medium">Any specific details or focus points? (Optional)</label>
                     <textarea id="details" placeholder="e.g., Focus on decorators in Python, explain the Calvin cycle, compare causes with American Revolution..." class="w-full"></textarea>
                </div>
                <button id="generateCourse" class="btn btn-primary w-full md:w-auto">Generate Course</button>
                 <div id="generationStatus" class="mt-4 text-sm text-gray-600 dark:text-gray-400 min-h-[1.25rem]"></div>
            </div>

            <!-- Ideas Section -->
            <div class="mb-12">
                 <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300" data-translate="ideasTitle">Need Inspiration?</h3>
                 <div class="ideas-grid">
                     <div class="idea-card" onclick="setTopic('Introduction to Quantum Computing')">
                         <h4 data-translate="ideaQuantumTitle">Quantum Computing</h4>
                         <p data-translate="ideaQuantumDesc">Understand qubits, superposition, and entanglement.</p>
                     </div>
                     <div class="idea-card" onclick="setTopic('Beginners Guide to Investing')">
                         <h4 data-translate="ideaInvestingTitle">Investing Basics</h4>
                         <p data-translate="ideaInvestingDesc">Learn about stocks, bonds, and mutual funds.</p>
                     </div>
                     <div class="idea-card" onclick="setTopic('Learn Basic Japanese Phrases')">
                          <h4 data-translate="ideaJapaneseTitle">Basic Japanese</h4>
                          <p data-translate="ideaJapaneseDesc">Master essential greetings and useful phrases.</p>
                     </div>
                     <div class="idea-card" onclick="setTopic('History of Ancient Egypt')">
                          <h4 data-translate="ideaEgyptTitle">Ancient Egypt</h4>
                          <p data-translate="ideaEgyptDesc">Explore pharaohs, pyramids, and hieroglyphs.</p>
                     </div>
                 </div>
            </div>


            <!-- Course Display Area (Tabs) -->
            <div id="courseDisplayArea" class="card p-6 hidden">
                 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h2 id="courseTitle" class="text-2xl font-semibold text-primary-color dark:text-indigo-400 flex-grow">Course Content</h2>
                     <button id="exportButton" class="btn btn-secondary text-sm flex-shrink-0" title="Export current course view as HTML">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Export View</span>
                    </button>
                 </div>

                <!-- Tab Buttons -->
                <div class="border-b border-border-light dark:border-border-dark mb-6">
                    <nav class="-mb-px flex space-x-4 sm:space-x-6 overflow-x-auto" aria-label="Tabs">
                        <button id="tabBtnLesson" class="tab-button active flex-shrink-0" onclick="switchTab('lesson')">Lesson</button>
                        <button id="tabBtnDemo" class="tab-button flex-shrink-0" onclick="switchTab('demo')">Interactive Demo</button>
                        <button id="tabBtnQuiz" class="tab-button flex-shrink-0" onclick="switchTab('quiz')">Quiz</button>
                    </nav>
                </div>

                <!-- Tab Content Panes -->
                <div id="tabContent">
                    <div id="lessonTab" class="tab-pane">
                        <div id="markdown-content" class="prose dark:prose-invert max-w-none">
                            <!-- Rendered Markdown content goes here -->
                        </div>
                    </div>
                    <div id="demoTab" class="tab-pane hidden">
                         <p id="demoStatus" class="text-center text-gray-500 dark:text-gray-400 my-4 min-h-[1.25rem]"></p>
                        <div id="demo-content" class="relative" style="min-height: 400px;">
                           <!-- Iframe for demo will be added here -->
                        </div>
                    </div>
                    <div id="quizTab" class="tab-pane hidden">
                         <p id="quizStatus" class="text-center text-gray-500 dark:text-gray-400 my-4 min-h-[1.25rem]"></p>
                        <div id="quiz-content">
                           <!-- Quiz form and results will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Saved Courses Popup -->
    <div id="savedCoursesPopup" class="fixed inset-0 blurred-bg hidden flex items-center justify-center p-4 z-40">
        <div class="card w-full max-w-lg max-h-[80vh] flex flex-col">
             <div class="flex justify-between items-center p-5 border-b border-border-light dark:border-border-dark">
                <h2 class="text-xl font-semibold" data-translate="savedCoursesTitle">Saved Courses</h2>
                <button id="closeSavedCourses" class="btn btn-icon text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 -mr-2" title="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-5">
                <input type="text" id="courseSearch" class="w-full p-2 border rounded mb-4 dark:bg-gray-600 dark:border-gray-500 focus:ring-primary-color focus:border-primary-color" placeholder="Search courses by topic...">
            </div>
            <ul id="courseList" class="space-y-1 overflow-y-auto flex-grow p-5">
                <!-- Course list items populated by JS -->
            </ul>
             <div class="p-5 border-t border-border-light dark:border-border-dark flex justify-end space-x-2">
                 <button id="exportData" class="btn btn-secondary text-sm">Export All</button>
                 <input type="file" id="importData" class="hidden" accept=".json">
                 <button id="importDataBtn" class="btn btn-primary text-sm">Import</button>
             </div>
        </div>
    </div>

    <!-- Settings Popup -->
    <div id="settings-popup" class="fixed inset-0 bg-black bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 sm:top-20 mx-auto p-6 border w-full max-w-md shadow-lg rounded-lg neumorphic bg-gray-100 dark:bg-gray-800">
             <button id="close-settings-icon" class="absolute top-3 right-3 btn btn-icon text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100" title="Close settings">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
             </button>
            <div class="mt-3 text-center">
                <h3 class="text-2xl leading-6 font-medium text-primary-color dark:text-indigo-400 mb-6" data-translate="settingsButton">Settings</h3>
                <div class="mb-8 text-left">
                    <label id="language-select-label" for="language-select" class="text-lg font-semibold mb-2 block">Language</label>
                    <select id="language-select" class="w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-color transition duration-300">
                        <!-- Language options added by JS -->
                    </select>
                </div>
                <div class="items-center px-4 py-3 mt-6">
                    <button id="close-settings" class="w-full btn btn-primary px-6 py-3 rounded-full font-medium">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Spinner -->
    <div id="spinner" class="hidden fixed top-0 left-0 right-0 bottom-0 w-full h-screen z-[100] overflow-hidden bg-gray-700 bg-opacity-75 flex flex-col items-center justify-center">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <h2 id="spinner-message" class="text-center text-white text-xl font-semibold">Loading...</h2>
        <p class="w-1/3 text-center text-white text-sm">Please wait while the content is being generated.</p>
    </div>

    <!-- HTML Templates -->
    <template id="quizQuestionTemplate">
        <div class="quiz-question-container bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <p class="question-text font-semibold text-lg mb-3"></p>
            <div class="options-container space-y-2"></div>
        </div>
    </template>

    <template id="quizOptionTemplate">
        <label class="quiz-option-label">
            <input type="radio" class="form-radio h-4 w-4 text-primary-color focus:ring-primary-color border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-900">
            <span class="option-text"></span>
        </label>
    </template>

    <template id="courseListItemTemplate">
        <li class="border-b border-border-light dark:border-border-dark last:border-b-0">
            <div class="flex justify-between items-center p-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 rounded-md">
                <div class="course-info-container flex-grow mr-2 cursor-pointer overflow-hidden">
                    <span class="course-title font-medium text-primary-color dark:text-indigo-400 block truncate"></span>
                    <span class="course-details text-sm text-gray-500 dark:text-gray-400 block"></span>
                </div>
                <button class="delete-course-button btn btn-icon text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 hover:bg-red-100 dark:hover:bg-red-900 transition flex-shrink-0" title="Delete Course">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        </li>
    </template>


    <script>
        // --- Configuration & Initialization ---
        const languageSelect = document.getElementById('language-select');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const generationStatus = document.getElementById('generationStatus');
        const courseDisplayArea = document.getElementById('courseDisplayArea');
        const courseTitle = document.getElementById('courseTitle');
        const topicInput = document.getElementById('topic');
        const detailsInput = document.getElementById('details'); // Added optional details input
        const quizQuestionTemplate = document.getElementById('quizQuestionTemplate');
        const quizOptionTemplate = document.getElementById('quizOptionTemplate');
        const courseListItemTemplate = document.getElementById('courseListItemTemplate');

        // --- Translations Object (with added keys) ---
        const translations = {
             en: {
                name: "English",
                translations: {
                    appTitle: "Personal Teacher", settingsButton: "Settings", whatWouldYouLikeToLearn: "What topic do you want to learn?",
                    difficultyLevel: "Select difficulty level:", generateCourse: "Generate Course", courseContent: "Course Content",
                    closeSettings: "Close", savedCoursesTitle: "Saved Courses", exportButton: "Export View",
                    statusGeneratingCourse: "Generating course content...", statusGeneratingDemo: "Creating interactive demo...", statusGeneratingQuiz: "Building quiz...", statusDone: "Course generated successfully!",
                    tabLesson: "Lesson", tabDemo: "Interactive Demo", tabQuiz: "Quiz",
                    demoUnavailable: "No interactive demo available for this topic or format.",
                    quizUnavailable: "Could not generate quiz. The format might be incorrect.",
                    quizResultTitle: "Quiz Results", quizScore: "You scored {score} out of {totalQuestions}",
                    quizFeedbackExcellent: "Excellent work!", quizFeedbackGood: "Good effort, keep learning!", quizFeedbackRetry: "Review the material and try again.",
                    yourAnswer: "Your answer", correctAnswer: "Correct answer", notAnswered: "Not answered", submitQuiz: "Submit Quiz",
                    loadingCourses: "Loading courses...", noSavedCourses: "No saved courses found.", errorLoadingCourses: "Error loading courses.",
                    confirmDeleteMessage: "Are you sure you want to delete the course \"{title}\"? This action cannot be undone.",
                    courseDeleted: "Course deleted.", errorDeleting: "Error deleting course.", errorSavingCourse: "Error saving the course.",
                    courseNotFound: "Course not found.", errorLoadingCourse: "Error loading the course.",
                    exportingData: "Exporting data...", noCoursesToExport: "No courses to export.", errorExporting: "Error exporting course data.",
                    importingData: "Importing data...", importSuccess: "Successfully imported/updated {count} courses.", importError: "Error importing courses: {message}", importInvalidFormat: "Imported file is not a valid course array.", importReadError: "Error reading the import file.",
                    importNoValidCourses: "No valid courses found in the imported file.",
                    alertEnterTopic: "Please enter a topic to learn.", loadingCourse: "Loading course...",
                    generateCourseTitle: "Create Your Lesson",
                    optionalDetails: "Any specific details or focus points? (Optional)",
                    detailsPlaceholder: "e.g., Focus on decorators in Python, explain the Calvin cycle, compare causes with American Revolution...",
                    topicPlaceholder: "e.g., Python functions, Photosynthesis, French Revolution",
                    ideasTitle: "Need Inspiration?",
                    ideaQuantumTitle: "Quantum Computing", ideaQuantumDesc: "Understand qubits, superposition, and entanglement.",
                    ideaInvestingTitle: "Investing Basics", ideaInvestingDesc: "Learn about stocks, bonds, and mutual funds.",
                    ideaJapaneseTitle: "Basic Japanese", ideaJapaneseDesc: "Master essential greetings and useful phrases.",
                    ideaEgyptTitle: "Ancient Egypt", ideaEgyptDesc: "Explore pharaohs, pyramids, and hieroglyphs."
                 },
                promptTranslations: {
                    coursePrompt: `You are an expert educator AI. Generate a comprehensive, engaging, and well-structured course for a {difficulty} level learner on the topic: "{topic}".

Follow this structure strictly:

1.  **Course Title:** A clear and concise title for the course.
2.  **Target Audience:** Briefly describe who this {difficulty} level course is for.
3.  **Prerequisites:** List any prior knowledge or skills recommended (if any).
4.  **Learning Objectives:** Provide 3-5 specific, measurable, achievable, relevant, and time-bound (SMART) objectives.
5.  **Key Concepts:** List and concisely explain 5-7 core concepts crucial to understanding the topic.
6.  **Detailed Content:** This is the main part. Divide into logical sections (at least 3-5). For each section:
    *   Use clear headings (Markdown H2 or H3).
    *   Explain concepts thoroughly but accessibly for the {difficulty} level.
    *   Use examples, analogies, or case studies.
    *   Include relevant code snippets (\`\`\`language ... \`\`\`), Mermaid diagrams (\`\`\`mermaid ... \`\`\`), or SVG (\`\`\`svg ... \`\`\`) where appropriate and valuable.
7.  **Practical Exercises/Activities:** Include 2-3 practical exercises or thought-provoking questions.
8.  **Summary & Key Takeaways:** Briefly recap main points.
9.  **Further Learning (Optional):** Suggest 1-2 resources.

**User Request Consideration:**
{user_details_section}

**Formatting Instructions:**
*   Use Markdown for all formatting.
*   Ensure language is clear, engaging, and appropriate for {difficulty}.
*   Break down complex ideas. Prioritize accuracy.

Generate *only* the markdown content for the course.`,
                    quizPrompt:`Generate a 5-question multiple-choice quiz for the {difficulty} level course on "{topic}". Test key concepts. Format *strictly* as a JSON object (no text outside JSON). Root key "questions" (array). Each question object needs keys: "question" (String), "options" (Array of 4 Strings), "correctAnswer" (Integer, 0-based index), "explanation" (String). Ensure relevance to {topic} at {difficulty} level.`,
                    demoPrompt: `You are an AI assistant specialized in creating simple, interactive web demos. Based on a {difficulty} level course about "{topic}", create a self-contained HTML snippet that demonstrates a *single key concept* from the topic in an interactive or visual way. Requirements: 1. Focus: ONE core concept. 2. Technology: HTML, CSS (Tailwind/inline/<style>), vanilla JS or p5.js (instance mode). 3. Interactivity/Visualization: Interactive (sliders/buttons) or visual (animation/diagram). 4. Clarity: Minimal explanatory text inside. 5. Self-Contained: All HTML/CSS/JS in the code block. 6. Simplicity: Clear, focused code. 7. Placeholder: If not feasible, output *only* \`<!-- No suitable interactive demo for this topic/difficulty -->\` inside the code block. Output Format: Provide *only* the HTML code block, starting strictly with \`\`\`html and ending strictly with \`\`\`. Inside the block: * HTML comment identifying concept: \`<!-- Demo for: [Concept Name] -->\` * A single root \`<div>\`. * Inside root div: HTML elements, optional \`<style>\`, and a \`<script>\` (vanilla JS or p5.js instance mode). Important: Do NOT add any text outside the final \`\`\`html ... \`\`\` code block.`
                }
            },
             fr: {
                name: "Français",
                translations: {
                    appTitle: "Professeur Personnel", settingsButton: "Paramètres", whatWouldYouLikeToLearn: "Quel sujet souhaitez-vous apprendre ?",
                    difficultyLevel: "Sélectionnez le niveau :", generateCourse: "Générer le cours", courseContent: "Contenu du cours",
                    closeSettings: "Fermer", savedCoursesTitle: "Cours sauvegardés", exportButton: "Exporter la vue",
                    statusGeneratingCourse: "Génération du contenu...", statusGeneratingDemo: "Création de la démo...", statusGeneratingQuiz: "Construction du quiz...", statusDone: "Cours généré avec succès !",
                    tabLesson: "Leçon", tabDemo: "Démo Intéractive", tabQuiz: "Quiz",
                    demoUnavailable: "Aucune démo interactive disponible.",
                    quizUnavailable: "Impossible de générer le quiz.",
                    quizResultTitle: "Résultats du Quiz", quizScore: "Votre score : {score}/{totalQuestions}",
                    quizFeedbackExcellent: "Excellent travail !", quizFeedbackGood: "Bon effort !", quizFeedbackRetry: "Revoyez et réessayez.",
                    yourAnswer: "Votre réponse", correctAnswer: "Réponse correcte", notAnswered: "Non répondu", submitQuiz: "Soumettre",
                    loadingCourses: "Chargement...", noSavedCourses: "Aucun cours sauvegardé.", errorLoadingCourses: "Erreur chargement cours.",
                    confirmDeleteMessage: "Supprimer le cours \"{title}\" ?", courseDeleted: "Cours supprimé.", errorDeleting: "Erreur suppression.", errorSavingCourse: "Erreur sauvegarde.",
                    courseNotFound: "Cours introuvable.", errorLoadingCourse: "Erreur chargement.",
                    exportingData: "Exportation...", noCoursesToExport: "Aucun cours à exporter.", errorExporting: "Erreur exportation.",
                    importingData: "Importation...", importSuccess: "{count} cours importés/mis à jour.", importError: "Erreur importation : {message}", importInvalidFormat: "Format invalide.", importReadError: "Erreur lecture fichier.",
                    importNoValidCourses: "Aucun cours valide trouvé.",
                    alertEnterTopic: "Veuillez entrer un sujet.", loadingCourse: "Chargement...",
                    generateCourseTitle: "Créez Votre Leçon",
                    optionalDetails: "Détails spécifiques ou points focus ? (Optionnel)",
                    detailsPlaceholder: "Ex : Focus sur les décorateurs Python, cycle de Calvin, comparer causes avec Révolution Américaine...",
                    topicPlaceholder: "Ex : Fonctions Python, Photosynthèse, Révolution française",
                    ideasTitle: "Besoin d'Inspiration ?",
                    ideaQuantumTitle: "Informatique Quantique", ideaQuantumDesc: "Comprendre qubits, superposition, intrication.",
                    ideaInvestingTitle: "Bases Investissement", ideaInvestingDesc: "Actions, obligations, fonds mutuels.",
                    ideaJapaneseTitle: "Japonais de Base", ideaJapaneseDesc: "Salutations et phrases utiles.",
                    ideaEgyptTitle: "Égypte Ancienne", ideaEgyptDesc: "Pharaons, pyramides, hiéroglyphes."
                 },
                promptTranslations: {
                    coursePrompt: `Vous êtes une IA éducatrice experte. Générez un cours complet, engageant et structuré pour un apprenant de niveau {difficulty} sur : "{topic}". Structure stricte : 1. Titre 2. Public cible 3. Prérequis 4. Objectifs (3-5 SMART) 5. Concepts clés (5-7) 6. Contenu détaillé (3-5 sections, titres, explications, exemples, code/Mermaid/SVG optionnels) 7. Exercices (2-3) 8. Résumé 9. Pour aller plus loin (Optionnel). Considération Requête Utilisateur : {user_details_section}. Format : Markdown. Langage clair pour {difficulty}. Priorité à l'exactitude. Générez *uniquement* le contenu markdown.`,
                    quizPrompt: `Générez un quiz QCM de 5 questions pour le cours niveau {difficulty} sur "{topic}". Testez les concepts clés. Format *strictement* JSON (rien en dehors). Clé racine "questions" (tableau). Chaque objet question : "question" (String), "options" (Tableau 4 Strings), "correctAnswer" (Integer, index 0), "explanation" (String). Pertinence pour {topic} et {difficulty}.`,
                    demoPrompt: `Vous êtes un assistant IA spécialisé dans la création de démos web simples et interactives. Basé sur un cours de niveau {difficulty} sur "{topic}", créez un extrait HTML autonome qui démontre un *concept clé unique* du sujet de manière interactive ou visuelle. Exigences : 1. Focus : UN concept clé. 2. Technologie : HTML, CSS (Tailwind/inline/<style>), JS vanilla ou p5.js (mode instance). 3. Interactivité/Visualisation : Interactif (curseurs/boutons) ou visuel (animation/diagramme). 4. Clarté : Minimum de texte explicatif à l'intérieur. 5. Autonome : Tout HTML/CSS/JS dans le bloc de code. 6. Simplicité : Code clair et ciblé. 7. Espace réservé : Si non réalisable, sortez *uniquement* \`<!-- Aucune démo interactive adaptée pour ce sujet/difficulté -->\` dans le bloc. Format de sortie : Fournissez *uniquement* le bloc de code HTML (\`\`\`html ... \`\`\`). À l'intérieur : * Commentaire HTML : \`<!-- Démo pour : [Nom Concept] -->\` * Un unique \`<div>\` racine. * Dans le div : Éléments HTML, optionnel \`<style>\`, et un \`<script>\`. Important : AUCUN texte en dehors du bloc de code \`\`\`html ... \`\`\`.`
                }
             }
             // Add other languages (it, de, ar, zh) here following the same structure
        };

        // Instantiate the localizer globally
        let localizer;
        try {
            localizer = new WebAppLocalizer(translations, 'personalTeacher_', languageSelect);
        } catch (e) {
             console.error("Failed to initialize WebAppLocalizer. Check if the script loaded correctly.", e);
             alert("Localization library failed to load. UI text might not appear correctly.");
             // Create a dummy localizer to prevent further errors
             localizer = {
                 translate: (key, vals = {}) => key,
                 formatPrompt: (key, vals = {}) => `Error: Localizer failed. Prompt: ${key}`,
                 setLanguage: () => {},
                 apply: () => {},
                 getCurrentLanguage: () => 'en',
                 getAvailableLanguages: () => [{code: 'en', name: 'English'}]
             };
        }

        const mr = new MarkdownRenderer();
        mr.initMermaid();
        const lc = new LollmsClient();
        let db;
        let currentCourseId = null;

        // --- Database Handling ---
        function initDB() {
            db = new Dexie('LOLLMSTeacherDB_V2');
            db.version(1).stores({
                courses: '++id, &topic_difficulty, title, topic, difficulty, content, demoContent, quizContent, created, lastAccessed'
            });
             db.open().catch(err => {
                console.error("Failed to open Dexie DB:", err);
                alert("Error initializing local storage. Saved courses may not work.");
             });
        }

        // --- UI Functions ---
        function showSpinner(message = 'Loading...') {
            document.getElementById('spinner-message').textContent = message;
            document.getElementById('spinner').classList.remove('hidden');
        }
        function hideSpinner() {
            document.getElementById('spinner').classList.add('hidden');
        }
        function updateStatus(message) {
            generationStatus.textContent = message;
            generationStatus.className = 'mt-4 text-sm text-gray-600 dark:text-gray-400 min-h-[1.25rem]';
        }
        function updateStatusSuccess(message) {
            updateStatus(message);
            generationStatus.classList.add('text-green-600', 'dark:text-green-400');
        }
         function updateStatusError(message) {
            updateStatus(message);
            generationStatus.classList.add('text-red-600', 'dark:text-red-400');
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            const pane = document.getElementById(`${tabName}Tab`);
            const button = document.getElementById(`tabBtn${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if(pane) pane.classList.remove('hidden');
            if(button) button.classList.add('active');
        }
        function applyDarkMode(isDark) {
             document.documentElement.classList.toggle('dark', isDark);
             moonIcon.classList.toggle('hidden', !isDark);
             sunIcon.classList.toggle('hidden', isDark);
             localStorage.setItem('darkMode', isDark);
             if (typeof mermaid !== 'undefined') {
                 try {
                    mermaid.initialize({ startOnLoad: false, theme: isDark ? 'dark' : 'default' });
                    document.querySelectorAll('.mermaid[data-processed="true"]').forEach(el => {
                        el.removeAttribute('data-processed');
                        const code = el.textContent;
                        el.innerHTML = '';
                        if (!el.id) { el.id = `mermaid-${Date.now()}-${Math.random().toString(16).slice(2)}`; }
                        mermaid.render(el.id, code, (svgCode) => {
                             if(!el.hasAttribute('data-processed')){
                                el.innerHTML = svgCode;
                                el.setAttribute('data-processed', 'true');
                             }
                        }, el);
                    });
                 } catch (e) { console.error("Mermaid re-initialization/render error:", e); }
             }
             document.querySelectorAll('pre code').forEach((block) => {
                 hljs.highlightElement(block);
             });
        }
        function setupDarkMode() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedMode = localStorage.getItem('darkMode');
            applyDarkMode(savedMode !== null ? JSON.parse(savedMode) : prefersDark);
            darkModeToggle.addEventListener('click', () => applyDarkMode(!document.documentElement.classList.contains('dark')));
        }
        function populateLanguageSelector() {
            if (!localizer || typeof localizer.getAvailableLanguages !== 'function') {
                 console.error("Localizer not ready for populateLanguageSelector");
                 return;
            }
            languageSelect.innerHTML = '';
            localizer.getAvailableLanguages().forEach(lang => {
                 const option = document.createElement('option');
                 option.value = lang.code;
                 option.textContent = lang.name;
                 languageSelect.appendChild(option);
            });
            languageSelect.value = localizer.getCurrentLanguage();
        }

        // Function to set topic from idea cards
        function setTopic(topic) {
            topicInput.value = topic;
            // Optional: scroll to the input field or focus it
            topicInput.focus();
            // Optional: clear details if a new topic is selected from ideas
            detailsInput.value = '';
        }


        // --- Course Generation & Display ---
        async function generateAndDisplayCourse() {
            const topic = topicInput.value.trim();
            const difficulty = document.getElementById('difficulty').value;
            const userDetails = detailsInput.value.trim();

            if (!topic) {
                alert(localizer.translate('alertEnterTopic'));
                return;
            }

            const genButton = document.getElementById('generateCourse');
            genButton.disabled = true;
            showSpinner(localizer.translate('statusGeneratingCourse'));
            updateStatus(localizer.translate('statusGeneratingCourse'));
            courseDisplayArea.classList.add('hidden');
            currentCourseId = null;

            let rawCourseContent = '', courseContentToRender = '', demoContent = '', quizContent = '', courseTitleText = topic;

            try {
                // 1. Generate Course Content
                let userDetailsSection = userDetails ? `\n**User Specific Request:** Please focus on or include the following details: ${userDetails}\n` : "No specific user details provided.";
                const coursePromptPayload = { difficulty, topic, user_details_section: userDetailsSection };
                const coursePrompt = localizer.formatPrompt("coursePrompt", coursePromptPayload);

                console.log("Generating Course...");
                rawCourseContent = await lc.generate(coursePrompt, 8192);
                console.log("Raw course content received.");

                // *** DETECT AND REMOVE MARKDOWN FENCES ***
                let processedCourseContent = rawCourseContent.trim();
                // Check if it starts with ```markdown and ends with ```
                 // Allow for optional language specifier like ```markdown or just ```
                if (processedCourseContent.startsWith('```') && processedCourseContent.endsWith('```')) {
                     console.log("Detected markdown fences, removing them.");
                     // Find the first newline after the opening fence
                     const firstNewlineIndex = processedCourseContent.indexOf('\n');
                     // Find the last newline before the closing fence
                     const lastNewlineIndex = processedCourseContent.lastIndexOf('\n');

                     if (firstNewlineIndex !== -1 && lastNewlineIndex !== -1 && lastNewlineIndex > firstNewlineIndex) {
                         processedCourseContent = processedCourseContent.substring(firstNewlineIndex + 1, lastNewlineIndex).trim();
                     } else {
                          // Fallback: simple fence removal if no newlines found correctly (e.g., ```content```)
                          processedCourseContent = processedCourseContent.slice(3, -3).trim();
                     }
                }
                 // Assign the processed content for rendering and saving
                 courseContentToRender = processedCourseContent;

                const titleMatch = courseContentToRender.match(/^#\s*(.*)/); // Check processed content for title
                if (titleMatch && titleMatch[1]) courseTitleText = titleMatch[1].trim();
                courseTitle.textContent = courseTitleText;

                const markdownContainer = document.getElementById('markdown-content');
                markdownContainer.innerHTML = '';
                markdownContainer.innerHTML = await mr.renderMarkdown(courseContentToRender); // Render the processed content
                console.log("Markdown rendered.");

                // 2. Generate Interactive Demo
                updateStatus(localizer.translate('statusGeneratingDemo'));
                showSpinner(localizer.translate('statusGeneratingDemo'));
                const demoPrompt = localizer.formatPrompt("demoPrompt", { difficulty, topic });
                console.log("Generating Demo...");
                const rawDemoOutput = await lc.generate(demoPrompt, 4096);
                console.log("Raw Demo Output:", rawDemoOutput);
                const demoCodeBlocks = lc.extractCodeBlocks(rawDemoOutput);
                const demoContainer = document.getElementById('demo-content');
                const demoStatusEl = document.getElementById('demoStatus');
                const demoTabButton = document.getElementById('tabBtnDemo');
                demoContainer.innerHTML = ''; demoStatusEl.textContent = '';
                const htmlDemoBlock = demoCodeBlocks?.find(block => block.type.toLowerCase() === 'html');
                if (htmlDemoBlock) {
                    demoContent = htmlDemoBlock.content;
                    if (demoContent.includes('<!-- No suitable interactive demo')) {
                        demoStatusEl.textContent = localizer.translate('demoUnavailable');
                        demoContent = '';
                        demoTabButton.style.display = 'none';
                    } else {
                        const iframe = document.createElement('iframe');
                        iframe.style.cssText = 'width: 100%; height: 500px; border: 1px solid var(--border-light); border-radius: 8px; background-color: white;';
                        iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
                        demoContainer.appendChild(iframe);
                        iframe.srcdoc = demoContent;
                        demoTabButton.style.display = 'inline-block';
                        demoStatusEl.textContent = '';
                    }
                } else {
                    demoStatusEl.textContent = localizer.translate('demoUnavailable');
                    demoTabButton.style.display = 'none';
                }

                // 3. Generate Quiz
                updateStatus(localizer.translate('statusGeneratingQuiz'));
                showSpinner(localizer.translate('statusGeneratingQuiz'));
                const quizPrompt = localizer.formatPrompt("quizPrompt", { difficulty, topic });
                console.log("Generating Quiz...");
                const rawQuizJson = await lc.generate(quizPrompt, 2048);
                console.log("Raw Quiz JSON:", rawQuizJson);
                const quizContainer = document.getElementById('quiz-content');
                const quizStatusEl = document.getElementById('quizStatus');
                const quizTabButton = document.getElementById('tabBtnQuiz');
                quizContainer.innerHTML = ''; quizStatusEl.textContent = '';
                let quizData = null;
                try {
                    const jsonMatch = rawQuizJson.match(/```json\s*(\{[\s\S]*\})\s*```|\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("No JSON object found.");
                    const jsonString = jsonMatch[1] || jsonMatch[0];
                    quizData = JSON.parse(jsonString);
                    if (!quizData?.questions?.length) throw new Error("Invalid JSON quiz format.");
                    quizContent = JSON.stringify(quizData);
                    createQuiz(quizData);
                    quizTabButton.style.display = 'inline-block';
                    quizStatusEl.textContent = '';
                } catch (error) {
                    console.error('Error processing quiz JSON:', error, "Raw:", rawQuizJson);
                    quizStatusEl.textContent = localizer.translate('quizUnavailable');
                    quizContent = '';
                    quizTabButton.style.display = 'none';
                }

                // 4. Save Course (Use the processed content without fences)
                await saveCourse(topic, difficulty, courseTitleText, courseContentToRender, demoContent, quizContent);

                updateStatusSuccess(localizer.translate('statusDone'));
                courseDisplayArea.classList.remove('hidden');
                switchTab('lesson');

            } catch (error) {
                console.error("Error during course generation:", error);
                updateStatusError(`Error: ${error.message}. Please check console or try again.`);
            } finally {
                hideSpinner();
                genButton.disabled = false;
            }
        }

        // --- Quiz Creation (Using Templates) ---
        function createQuiz(quizData) {
            const quizContainer = document.getElementById('quiz-content');
            quizContainer.innerHTML = '';
            const quizStatusEl = document.getElementById('quizStatus');
            quizStatusEl.textContent = '';

             if (!quizData || !quizData.questions || quizData.questions.length === 0) {
                quizStatusEl.textContent = localizer.translate('quizUnavailable');
                return;
             }

            const form = document.createElement('form');
            form.id = 'quiz-form';
            form.className = 'space-y-6';

            quizData.questions.forEach((q, index) => {
                const questionFragment = quizQuestionTemplate.content.cloneNode(true);
                const questionTextEl = questionFragment.querySelector('.question-text');
                const optionsContainer = questionFragment.querySelector('.options-container');
                questionTextEl.textContent = `${index + 1}. ${q.question}`;
                q.options.forEach((option, optionIndex) => {
                    const optionFragment = quizOptionTemplate.content.cloneNode(true);
                    const label = optionFragment.querySelector('label');
                    const radio = optionFragment.querySelector('input[type="radio"]');
                    const optionTextEl = optionFragment.querySelector('.option-text');
                    radio.name = `question${index}`;
                    radio.value = optionIndex;
                    radio.id = `q${index}_opt${optionIndex}`;
                    label.setAttribute('for', radio.id);
                    optionTextEl.textContent = option;
                    optionsContainer.appendChild(optionFragment);
                });
                form.appendChild(questionFragment);
            });

            const submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.textContent = localizer.translate('submitQuiz');
            submitButton.className = 'w-full btn btn-primary mt-6';
            form.appendChild(submitButton);

            quizContainer.appendChild(form);

            const resultContainer = document.createElement('div');
            resultContainer.id = 'quiz-result-container';
            resultContainer.className = 'mt-8';
            quizContainer.appendChild(resultContainer);

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                calculateScore(quizData, form);
                submitButton.disabled = true;
            });
        }

        // --- Quiz Score Calculation (Using DOM Elements) ---
        function calculateScore(quizData, form) {
            let score = 0;
            const totalQuestions = quizData.questions.length;
            const resultContainer = document.getElementById('quiz-result-container');
            resultContainer.innerHTML = '';

            const resultDiv = document.createElement('div');
            resultDiv.className = 'p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow';

             const resultsTitle = document.createElement('h2');
             resultsTitle.className = 'text-2xl font-bold mb-4';
             resultsTitle.textContent = localizer.translate('quizResultTitle');
             resultDiv.appendChild(resultsTitle);

             const scoreSummaryP = document.createElement('p');
             scoreSummaryP.className = 'text-xl mb-2';
             resultDiv.appendChild(scoreSummaryP);

             const feedbackP = document.createElement('p');
             feedbackP.className = 'mb-6 font-semibold';
             resultDiv.appendChild(feedbackP);

             const detailsContainer = document.createElement('div');
             detailsContainer.className = 'space-y-4';
             resultDiv.appendChild(detailsContainer);

            quizData.questions.forEach((q, index) => {
                const selectedRadio = form.querySelector(`input[name="question${index}"]:checked`);
                const selectedAnswerIndex = selectedRadio ? parseInt(selectedRadio.value) : -1;
                const isCorrect = selectedAnswerIndex === q.correctAnswer;
                if (isCorrect) score++;

                const questionDiv = form.querySelectorAll('.quiz-question-container')[index];
                questionDiv.querySelectorAll('label.quiz-option-label').forEach((label, optIndex) => {
                    label.classList.remove('correct', 'incorrect');
                    const radioInput = label.querySelector('input[type="radio"]');
                    if (radioInput) radioInput.disabled = true;
                    if (optIndex === q.correctAnswer) { label.classList.add('correct'); }
                    if (selectedAnswerIndex === optIndex && !isCorrect) { label.classList.add('incorrect'); }
                });

                 const details = document.createElement('details');
                 details.className = 'border-b dark:border-gray-600 pb-3 mb-3';
                 const summary = document.createElement('summary');
                 summary.className = 'font-semibold cursor-pointer hover:text-primary-color dark:hover:text-indigo-400 list-none flex items-center gap-2';
                 summary.innerHTML = `
                     <span class="inline-block w-5 text-lg flex-shrink-0">${isCorrect ? '✅' : '❌'}</span>
                     <span class="flex-1">${index + 1}. ${escapeHtml(q.question)} -
                         <span class="${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                             ${isCorrect ? 'Correct' : 'Incorrect'}
                         </span>
                     </span>`;
                 details.appendChild(summary);

                 const explanationDiv = document.createElement('div');
                 explanationDiv.className = 'mt-2 pl-10 text-sm space-y-1';
                 const userAnswerP = document.createElement('p');
                 userAnswerP.innerHTML = `${localizer.translate('yourAnswer')}: <span class="${isCorrect ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}">${selectedAnswerIndex !== -1 ? escapeHtml(q.options[selectedAnswerIndex]) : localizer.translate('notAnswered')}</span>`;
                 explanationDiv.appendChild(userAnswerP);

                 if (!isCorrect) {
                     const correctAnswerP = document.createElement('p');
                     correctAnswerP.innerHTML = `${localizer.translate('correctAnswer')}: <span class="text-green-700 dark:text-green-300">${escapeHtml(q.options[q.correctAnswer])}</span>`;
                     explanationDiv.appendChild(correctAnswerP);
                 }
                 const explanationP = document.createElement('p');
                 explanationP.className = 'text-gray-600 dark:text-gray-400 mt-1';
                 explanationP.innerHTML = `<em>Explanation:</em> ${escapeHtml(q.explanation || "No explanation provided.")}`;
                 explanationDiv.appendChild(explanationP);

                 details.appendChild(explanationDiv);
                 detailsContainer.appendChild(details);
            });

            const scorePercentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0;
            let feedbackClass = 'retry';
            let feedbackMessage = localizer.translate('quizFeedbackRetry');

            if (scorePercentage >= 80) { feedbackClass = 'excellent'; feedbackMessage = localizer.translate('quizFeedbackExcellent'); }
            else if (scorePercentage >= 50) { feedbackClass = 'good'; feedbackMessage = localizer.translate('quizFeedbackGood'); }

            scoreSummaryP.innerHTML = `${localizer.translate('quizScore', { score: score, totalQuestions: totalQuestions })} (<span class="font-bold quiz-result-feedback ${feedbackClass}">${scorePercentage.toFixed(0)}%</span>)`;
            feedbackP.textContent = feedbackMessage;
            feedbackP.className = `mb-6 font-semibold quiz-result-feedback ${feedbackClass}`;

            resultContainer.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }


        // --- Course Persistence (Dexie) ---
        async function saveCourse(topic, difficulty, title, content, demoContentStr, quizContentStr) {
            if (!db) { console.error("DB not initialized, cannot save course."); return null; }
            if (!topic || !difficulty || !content) { console.error("Cannot save course with missing topic, difficulty, or content."); return null; }
            const newCourse = {
                topic_difficulty: `${topic.toLowerCase()}_${difficulty}`, title: title || topic, topic, difficulty, content, // Save the processed content
                demoContent: demoContentStr || '', quizContent: quizContentStr || '',
                created: new Date(), lastAccessed: new Date()
            };
            try {
                const id = await db.courses.put(newCourse);
                console.log(`Course "${title}" saved/updated with ID: ${id}`);
                currentCourseId = id;
                updateCourseList();
                return id;
            } catch (error) {
                 if (error.name === 'ConstraintError') {
                    console.warn(`Course with topic "${topic}" and difficulty "${difficulty}" likely already exists and was updated by 'put'.`);
                    const existing = await db.courses.get({topic_difficulty: newCourse.topic_difficulty});
                    if (existing) currentCourseId = existing.id;
                 } else {
                    console.error("Failed to save course:", error);
                    alert(localizer.translate('errorSavingCourse'));
                 }
                 return null;
            }
        }

        // --- Course List Update (Using Template) ---
        async function updateCourseList(filteredCourses = null) {
            if (!db) { console.error("DB not initialized"); return; }
            const courseList = document.getElementById('courseList');
            const loadingLi = document.createElement('li');
            loadingLi.className = 'text-center text-gray-500 dark:text-gray-400 p-4';
            loadingLi.textContent = localizer.translate('loadingCourses');
            courseList.innerHTML = '';
            courseList.appendChild(loadingLi);

            try {
                 const courses = filteredCourses ? filteredCourses : await db.courses.orderBy('lastAccessed').reverse().toArray();
                 courseList.innerHTML = '';
                 if (courses.length === 0) {
                    const emptyLi = document.createElement('li');
                    emptyLi.className = 'text-center text-gray-500 dark:text-gray-400 p-4';
                    emptyLi.textContent = localizer.translate('noSavedCourses');
                    courseList.appendChild(emptyLi);
                    return;
                 }
                courses.forEach(course => {
                    const courseFragment = courseListItemTemplate.content.cloneNode(true);
                    const titleEl = courseFragment.querySelector('.course-title');
                    const detailsEl = courseFragment.querySelector('.course-details');
                    const infoContainer = courseFragment.querySelector('.course-info-container');
                    const deleteButton = courseFragment.querySelector('.delete-course-button');
                    titleEl.textContent = course.title || course.topic;
                    detailsEl.textContent = `${course.difficulty} - Accessed: ${course.lastAccessed.toLocaleDateString()}`;
                    infoContainer.addEventListener('click', () => loadCourse(course.id));
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        confirmDeleteCourse(course.id, course.title || course.topic);
                    });
                    courseList.appendChild(courseFragment);
                });
            } catch (error) {
                 console.error("Failed to update course list:", error);
                 courseList.innerHTML = '';
                 const errorLi = document.createElement('li');
                 errorLi.className = 'text-center text-red-500 p-4';
                 errorLi.textContent = localizer.translate('errorLoadingCourses');
                 courseList.appendChild(errorLi);
            }
        }

        // --- Load Course ---
        async function loadCourse(id) {
            if (!db) { console.error("DB not initialized"); return; }
            showSpinner(localizer.translate('loadingCourse') || "Loading course...");
            try {
                const course = await db.courses.get(id);
                if (!course) {
                    alert(localizer.translate('courseNotFound'));
                    hideSpinner();
                    return;
                }
                currentCourseId = id;
                topicInput.value = course.topic;
                document.getElementById('difficulty').value = course.difficulty;
                detailsInput.value = ''; // Clear details field when loading
                courseTitle.textContent = course.title || course.topic;

                // Render SAVED Lesson Content (already processed)
                const markdownContainer = document.getElementById('markdown-content');
                markdownContainer.innerHTML = ''; // Clear previous
                markdownContainer.innerHTML = await mr.renderMarkdown(course.content); // Render saved content
                console.log("Saved Markdown rendered.");


                 // Render Demo
                 const demoContainer = document.getElementById('demo-content');
                 const demoStatusEl = document.getElementById('demoStatus');
                 const demoTabButton = document.getElementById('tabBtnDemo');
                 demoContainer.innerHTML = ''; demoStatusEl.textContent = '';
                 if (course.demoContent && !course.demoContent.includes('<!-- No suitable interactive demo')) {
                    const iframe = document.createElement('iframe');
                    iframe.style.cssText = 'width: 100%; height: 500px; border: 1px solid var(--border-light); border-radius: 8px; background-color: white;';
                    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
                    demoContainer.appendChild(iframe);
                    iframe.srcdoc = course.demoContent;
                    demoTabButton.style.display = 'inline-block';
                 } else {
                    demoStatusEl.textContent = localizer.translate('demoUnavailable');
                    demoTabButton.style.display = 'none';
                 }

                // Render Quiz
                const quizContainer = document.getElementById('quiz-content');
                const quizStatusEl = document.getElementById('quizStatus');
                const quizTabButton = document.getElementById('tabBtnQuiz');
                 quizContainer.innerHTML = ''; quizStatusEl.textContent = '';
                 if (course.quizContent) {
                     try {
                         const quizData = JSON.parse(course.quizContent);
                         if (!quizData?.questions?.length) throw new Error("Invalid quiz format");
                         createQuiz(quizData);
                         quizTabButton.style.display = 'inline-block';
                     } catch (e) {
                         console.error("Failed to parse stored quiz JSON:", e);
                         quizStatusEl.textContent = localizer.translate('quizUnavailable');
                         quizTabButton.style.display = 'none';
                     }
                 } else {
                    quizStatusEl.textContent = localizer.translate('quizUnavailable');
                     quizTabButton.style.display = 'none';
                 }

                courseDisplayArea.classList.remove('hidden');
                switchTab('lesson');
                document.getElementById('savedCoursesPopup').classList.add('hidden');

                db.courses.update(id, { lastAccessed: new Date() }).catch(err => console.error("Failed to update lastAccessed time:", err));

            } catch (error) {
                console.error("Failed to load course:", error);
                alert(localizer.translate('errorLoadingCourse'));
            } finally {
                hideSpinner();
            }
        }

        // --- Delete Course ---
        function confirmDeleteCourse(id, title) {
             const message = localizer.translate('confirmDeleteMessage', { title: title });
             if (confirm(message)) {
                 deleteCourse(id);
             }
        }
        async function deleteCourse(id) {
             if (!db) { console.error("DB not initialized"); return; }
             try {
                 await db.courses.delete(id);
                 console.log("Course deleted:", id);
                 if (currentCourseId === id) {
                     courseDisplayArea.classList.add('hidden');
                     topicInput.value = '';
                     detailsInput.value = '';
                     currentCourseId = null;
                 }
                 updateCourseList();
             } catch (error) {
                 console.error("Failed to delete course:", error);
                 alert(localizer.translate('errorDeleting'));
             }
        }

        // --- Course Search ---
        document.getElementById('courseSearch').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            if (!db) return;
            if (searchTerm === '') { updateCourseList(); return; }
            try {
                 const allCourses = await db.courses.toArray();
                 const filteredCourses = allCourses.filter(course =>
                    (course.title && course.title.toLowerCase().includes(searchTerm)) ||
                    (course.topic && course.topic.toLowerCase().includes(searchTerm))
                 ).sort((a, b) => b.lastAccessed - a.lastAccessed);
                 updateCourseList(filteredCourses);
            } catch (error) {
                console.error("Error searching courses:", error);
                 document.getElementById('courseList').innerHTML = `<li class="text-center text-red-500 p-4">${localizer.translate('errorLoadingCourses')}</li>`;
            }
        });

        // --- Import/Export ---
        document.getElementById('exportData').addEventListener('click', async () => {
            if (!db) { alert("Database not ready."); return; }
            showSpinner(localizer.translate('exportingData'));
            try {
                const courses = await db.courses.toArray();
                if (courses.length === 0) {
                    alert(localizer.translate('noCoursesToExport'));
                    hideSpinner();
                    return;
                }
                const dataStr = JSON.stringify(courses, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const linkElement = document.createElement('a');
                linkElement.href = url;
                linkElement.download = `lollms_teacher_courses_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Failed to export data:", error);
                alert(localizer.translate('errorExporting'));
            } finally {
                hideSpinner();
            }
        });

        document.getElementById('importDataBtn').addEventListener('click', () => {
            document.getElementById('importData').value = '';
            document.getElementById('importData').click();
        });

        document.getElementById('importData').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file || !db) return;
            showSpinner(localizer.translate('importingData'));
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const coursesToImport = JSON.parse(e.target.result);
                    if (!Array.isArray(coursesToImport)) {
                        throw new Error(localizer.translate('importInvalidFormat'));
                    }
                    const validCourses = coursesToImport.filter(c => c.topic && c.difficulty && c.content);
                    if (validCourses.length !== coursesToImport.length) {
                         console.warn("Some imported courses were filtered out due to missing required fields (topic, difficulty, content).");
                    }
                    if(validCourses.length > 0) {
                        const count = await db.courses.bulkPut(validCourses);
                        alert(localizer.translate('importSuccess', { count: count }));
                        updateCourseList();
                    } else {
                        alert(localizer.translate('importNoValidCourses'));
                    }
                } catch (error) {
                    console.error("Failed to import data:", error);
                    alert(localizer.translate('importError', { message: error.message }));
                } finally {
                     hideSpinner();
                }
            };
            reader.onerror = () => {
                 alert(localizer.translate('importReadError'));
                 hideSpinner();
            }
            reader.readAsText(file);
        });

        // --- Helper function ---
        function escapeHtml(unsafe) {
             if (typeof unsafe !== 'string') return '';
             return unsafe
                 .replace(/&/g, "&")
                 .replace(/</g, "<")
                 .replace(/>/g, ">")
                 .replace(/"/g, "\"")
                 .replace(/'/g, "'");
        }

        // --- Export Current View (using DOM manipulation) ---
        document.getElementById('exportButton').addEventListener('click', function() {
            const lessonContentSource = document.getElementById('markdown-content');
            const demoContentSource = document.getElementById('demo-content');
            const demoStatusSource = document.getElementById('demoStatus');
            const quizContentSource = document.getElementById('quiz-content');
            const quizStatusSource = document.getElementById('quizStatus');
            const titleText = courseTitle.textContent || 'Exported Course';

            const exportDoc = document.implementation.createHTMLDocument(titleText);
            const exportHtml = exportDoc.documentElement;
            const exportHead = exportDoc.head;
            const exportBody = exportDoc.body;

            const metaCharset = exportDoc.createElement('meta');
            metaCharset.setAttribute('charset', 'UTF-8');
            exportHead.appendChild(metaCharset);

            const titleEl = exportDoc.createElement('title');
            titleEl.textContent = titleText;
            exportHead.appendChild(titleEl);

            const styleEl = exportDoc.createElement('style');
            styleEl.textContent = `
                body { font-family: system-ui, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: auto; color: #333; }
                h1, h2, h3 { margin-top: 1.5em; margin-bottom: 0.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; color: #111; }
                pre { background: #2d2d2d; color: #ccc; padding: 1em; border-radius: 5px; overflow-x: auto; font-size: 0.9em; }
                code { font-family: 'Courier New', Courier, monospace; }
                blockquote { border-left: 3px solid #ccc; padding-left: 1em; margin: 1em 0; font-style: italic; color: #555; background-color: #f9f9f9; }
                .section { margin-top: 2em; padding-top: 1em; }
                .prose { /* Basic prose styles */ }
                iframe { width: 100%; min-height: 400px; border: 1px solid #ddd; }
                 .quiz-question-container { border: 1px solid #eee; padding: 1em; margin-bottom: 1em; background: #f9f9f9; border-radius: 4px; }
                 .quiz-option-label { display: block; margin-bottom: 0.5em; }
                 .question-text { font-weight: bold; margin-bottom: 0.8em; }
                 details { border: 1px solid #eee; padding: 0.5em; margin-bottom: 1em; border-radius: 4px; } summary { cursor: pointer; font-weight: bold;}
                 .correct { background-color: #e0f2e9; border-left: 3px solid #4caf50; padding-left: 5px;}
                 .incorrect { background-color: #ffebee; border-left: 3px solid #f44336; padding-left: 5px;}
            `;
            exportHead.appendChild(styleEl);

            const highlightCSS = exportDoc.createElement('link');
            highlightCSS.rel = 'stylesheet';
            highlightCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css';
            exportHead.appendChild(highlightCSS);
            const highlightJS = exportDoc.createElement('script');
            highlightJS.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js';
            highlightJS.defer = true;
            exportHead.appendChild(highlightJS);
            const highlightInit = exportDoc.createElement('script');
            highlightInit.textContent = `document.addEventListener('DOMContentLoaded', () => { try { document.querySelectorAll('pre code').forEach((el) => hljs.highlightElement(el)); } catch(e){ console.error('Highlight.js failed:', e); } });`;
            highlightInit.defer = true;
            exportHead.appendChild(highlightInit);

            const mainTitle = exportDoc.createElement('h1');
            mainTitle.textContent = titleText;
            exportBody.appendChild(mainTitle);

            const lessonSection = exportDoc.createElement('div');
            lessonSection.className = 'section';
            const lessonTitle = exportDoc.createElement('h2');
            lessonTitle.textContent = 'Lesson Content';
            lessonSection.appendChild(lessonTitle);
            const lessonDiv = exportDoc.createElement('div');
            lessonDiv.className = 'prose';
            lessonDiv.innerHTML = lessonContentSource.innerHTML;
            lessonSection.appendChild(lessonDiv);
            exportBody.appendChild(lessonSection);

            const demoIframe = demoContentSource.querySelector('iframe');
            const demoStatus = demoStatusSource.textContent;
            if (demoIframe || demoStatus) {
                const demoSection = exportDoc.createElement('div');
                demoSection.className = 'section';
                const demoTitle = exportDoc.createElement('h2');
                demoTitle.textContent = 'Interactive Demo';
                demoSection.appendChild(demoTitle);
                if (demoIframe && demoIframe.srcdoc) {
                    const demoIframeClone = exportDoc.createElement('iframe');
                    demoIframeClone.setAttribute('srcdoc', demoIframe.srcdoc);
                    demoIframeClone.style.cssText = 'width: 100%; height: 500px; border: 1px solid #ddd;';
                    demoIframeClone.setAttribute('sandbox', 'allow-scripts allow-same-origin');
                    const comment = exportDoc.createComment(' Demo content below might require a server or specific browser settings to run correctly due to srcdoc usage. ');
                    demoSection.appendChild(comment);
                    demoSection.appendChild(demoIframeClone);
                } else if (demoStatus) {
                    const statusP = exportDoc.createElement('p');
                    statusP.textContent = demoStatus;
                    demoSection.appendChild(statusP);
                }
                exportBody.appendChild(demoSection);
            }

            const quizStatus = quizStatusSource.textContent;
            if (quizContentSource.innerHTML.trim() && !quizStatus) {
                const quizSection = exportDoc.createElement('div');
                quizSection.className = 'section';
                const quizTitle = exportDoc.createElement('h2');
                quizTitle.textContent = 'Quiz';
                quizSection.appendChild(quizTitle);
                const quizClone = quizContentSource.cloneNode(true);
                const resultContainerClone = quizClone.querySelector('#quiz-result-container');
                if(resultContainerClone) resultContainerClone.remove();
                const submitButtonClone = quizClone.querySelector('button[type="submit"]');
                if(submitButtonClone) { submitButtonClone.textContent += " (Exported - Disabled)"; submitButtonClone.disabled = true; }
                quizClone.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
                quizSection.appendChild(quizClone);
                exportBody.appendChild(quizSection);
            } else if (quizStatus) {
                 const quizSection = exportDoc.createElement('div');
                 quizSection.className = 'section';
                 const quizTitle = exportDoc.createElement('h2');
                 quizTitle.textContent = 'Quiz';
                 quizSection.appendChild(quizTitle);
                 const statusP = exportDoc.createElement('p');
                 statusP.textContent = quizStatus;
                 quizSection.appendChild(statusP);
                 exportBody.appendChild(quizSection);
            }

            const doctype = '<!DOCTYPE html>';
            const finalHtmlString = doctype + '\n' + exportHtml.outerHTML;

            const blob = new Blob([finalHtmlString], { type: 'text/html;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${titleText.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_export.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });


        // --- Event Listeners ---
        document.getElementById('generateCourse').addEventListener('click', generateAndDisplayCourse);
        document.getElementById('toggleSavedCourses').addEventListener('click', () => {
            updateCourseList();
            document.getElementById('savedCoursesPopup').classList.toggle('hidden');
        });
        document.getElementById('closeSavedCourses').addEventListener('click', () => {
            document.getElementById('savedCoursesPopup').classList.add('hidden');
        });
        document.getElementById('settings-button').addEventListener('click', () => {
            populateLanguageSelector();
            document.getElementById('settings-popup').classList.remove('hidden');
        });
        document.getElementById('close-settings').addEventListener('click', () => {
            document.getElementById('settings-popup').classList.add('hidden');
        });
        document.getElementById('close-settings-icon').addEventListener('click', () => {
            document.getElementById('settings-popup').classList.add('hidden');
        });
        languageSelect.addEventListener('change', (e) => {
             localizer.setLanguage(e.target.value); // Calls apply() internally
             // Manually update non-data-translate elements
             document.getElementById('generateCourse').textContent = localizer.translate('generateCourse');
             document.getElementById('close-settings').textContent = localizer.translate('closeSettings');
             document.getElementById('tabBtnLesson').textContent = localizer.translate('tabLesson');
             document.getElementById('tabBtnDemo').textContent = localizer.translate('tabDemo');
             document.getElementById('tabBtnQuiz').textContent = localizer.translate('tabQuiz');
             document.querySelector('#exportButton span').textContent = localizer.translate('exportButton');
             document.getElementById('topic').placeholder = localizer.translate('topicPlaceholder');
             document.getElementById('details').placeholder = localizer.translate('detailsPlaceholder');
             // Note: Idea card text content uses data-translate now.
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure localizer is defined before proceeding
             if (typeof WebAppLocalizer === 'undefined') {
                console.error("FATAL: WebAppLocalizer script not loaded!");
                alert("Core localization library failed to load. Application cannot function.");
                return; // Stop further execution
             }

             initDB();
             setupDarkMode();

             try {
                // Initialize localizer after its definition is confirmed loaded
                // localizer = new WebAppLocalizer(translations, 'personalTeacher_', languageSelect); // Already defined globally

                populateLanguageSelector(); // Populate <select>
                localizer.apply(); // Apply initial translations

                // Manually translate elements without data-translate attributes after apply()
                document.getElementById('generateCourse').textContent = localizer.translate('generateCourse');
                document.getElementById('close-settings').textContent = localizer.translate('closeSettings');
                document.getElementById('tabBtnLesson').textContent = localizer.translate('tabLesson');
                document.getElementById('tabBtnDemo').textContent = localizer.translate('tabDemo');
                document.getElementById('tabBtnQuiz').textContent = localizer.translate('tabQuiz');
                document.querySelector('#exportButton span').textContent = localizer.translate('exportButton');
                // Translate placeholders
                document.getElementById('topic').placeholder = localizer.translate('topicPlaceholder');
                document.getElementById('details').placeholder = localizer.translate('detailsPlaceholder');


             } catch (e) {
                 console.error("Error during initialization (Localizer likely failed):", e);
                 // Attempt to provide minimal functionality or better error message
             }

             console.log("Personal Teacher Initialized");
        });

        // Make globally accessible
        window.switchTab = switchTab;
        window.setTopic = setTopic; // Make idea card function global

    </script>
</body>
</html>